<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ú–∞–≥–∞–∑–∏–Ω—á–∏–∫ –Ø–º–∏ ‚Äî –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤</title>
  <meta name="description" content="–ú–∞–≥–∞–∑–∏–Ω—á–∏–∫ –Ø–º–∏ ‚Äî –∑–∞–∫–∞–∑—ã–≤–∞–π –∫–æ–Ω—Ç–µ–Ω—Ç –∑–∞ –±–∞–ª–ª—ã —Å –∫–ª–∏–ø–æ–≤. –ü—Ä–∞–≤–∏–ª–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è, –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –±–∞–ª–ª–æ–≤ –∏ —Ç–æ–≤–∞—Ä—ã." />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --glass-bg: rgba(255, 255, 255, .55);
      --glass-brd: rgba(255, 255, 255, .45);
      --shadow: 0 18px 55px rgba(18, 28, 55, .14);
      --ring: 0 0 0 1px rgba(255, 255, 255, .55), 0 0 0 6px rgba(255, 255, 255, .18);
    }
    
    body {
      background: radial-gradient(1200px 800px at 10% 10%, rgba(100, 150, 220, .30), transparent 60%), 
                  radial-gradient(1000px 700px at 90% 20%, rgba(80, 140, 200, .25), transparent 55%), 
                  radial-gradient(900px 700px at 40% 100%, rgba(100, 160, 200, .20), transparent 55%), 
                  linear-gradient(135deg, #1a2f4f 0%, #2d4a7a 50%, #1f3a5f 100%);
      min-height: 100vh;
      color: #1e293b;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    
    .glass {
      background: var(--glass-bg);
      border: 1.5px solid var(--glass-brd);
      box-shadow: var(--shadow), 0 0 30px rgba(100, 200, 255, 0.15), inset 0 1px 2px rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    
    .glass:hover {
      box-shadow: var(--shadow), 0 0 40px rgba(100, 200, 255, 0.25), inset 0 1px 2px rgba(255, 255, 255, 0.3);
    }
    
    .glow {
      position: relative;
    }
    
    .glow:before {
      content: "";
      position: absolute;
      inset: -2px;
      border-radius: inherit;
      pointer-events: none;
      background: linear-gradient(135deg, rgba(100, 200, 255, 0.4), rgba(150, 180, 255, 0.2), rgba(100, 200, 255, 0.3));
      filter: blur(15px);
      opacity: 0.6;
      z-index: -1;
    }
    
    .floaty {
      position: absolute;
      border-radius: 999px;
      filter: blur(22px);
      opacity: .35;
      mix-blend-mode: multiply;
      pointer-events: none;
    }
    
    .reveal {
      opacity: 0;
      transform: translateY(14px);
      transition: opacity .6s ease, transform .6s ease;
    }
    
    .reveal.is-in {
      opacity: 1;
      transform: translateY(0);
    }
    
    .modal-backdrop {
      background: rgba(20, 30, 55, .35);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    
    .toast {
      animation: toastIn .22s ease-out;
    }
    
    @keyframes toastIn {
      from {
        transform: translateY(12px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    #petals {
      position: fixed;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 0;
    }
    
    @media (prefers-reduced-motion: reduce) {
      .reveal {
        transition: none !important;
      }
    }
    
    .yammy-check {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, .38);
      background: rgba(255, 255, 255, .20);
      display: inline-grid;
      place-content: center;
      cursor: pointer;
      flex: 0 0 18px;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, .06);
    }
    
    .yammy-check:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(255, 255, 255, .18);
    }
    
    .yammy-check::after {
      content: "";
      width: 9px;
      height: 5px;
      border-left: 2px solid #1e293b;
      border-bottom: 2px solid #1e293b;
      transform: rotate(-45deg);
      opacity: 0;
      margin-top: -1px;
    }
    
    .yammy-check:checked::after {
      opacity: 1;
    }
  </style>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['ui-sans-serif', 'system-ui', 'Segoe UI', 'Roboto', 'Arial']
          }
        }
      }
    }
  </script>
</head>
<body class="text-slate-900">
  <div id="petals" aria-hidden="true"></div>
  <div class="pointer-events-none fixed inset-0 -z-10">
    <div class="floaty hidden lg:block" style="top:10%;left:8%;width:220px;height:220px;background:rgba(100,200,255,.25);box-shadow:0 0 80px rgba(100,200,255,.2)"></div>
    <div class="floaty hidden lg:block" style="top:18%;right:10%;width:260px;height:260px;background:rgba(120,180,255,.20);box-shadow:0 0 100px rgba(120,180,255,.15)"></div>
    <div class="floaty hidden lg:block" style="bottom:12%;left:18%;width:300px;height:300px;background:rgba(100,220,255,.15);box-shadow:0 0 120px rgba(100,220,255,.1)"></div>
  </div>
  
  <div id="tgWarning" class="hidden mx-auto max-w-6xl px-4 pt-3">
    <div class="glass rounded-2xl p-4 border border-amber-200/60 bg-amber-50/60">
      <div class="flex items-start gap-3">
        <div class="text-xl">‚ö†Ô∏è</div>
        <div class="text-sm text-slate-800">
          –ü–æ—Ö–æ–∂–µ, —Ç—ã –æ—Ç–∫—Ä—ã–ª(–∞) —Å–∞–π—Ç –≤–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ Telegram. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è Twitch –∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ. –õ—É—á—à–µ –æ—Ç–∫—Ä—ã—Ç—å –≤ –æ–±—ã—á–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ (Chrome/Safari).
        </div>
      </div>
    </div>
  </div>
  
  <main class="relative z-10 mx-auto max-w-6xl px-4 pb-16 pt-6 md:pt-10">
    <section class="reveal">
      <div class="glass glow rounded-3xl p-6 md:p-8">
        <h1 class="text-2xl md:text-3xl font-bold tracking-tight">
          ‚ú® –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∞–≥–∞–∑–∏–Ω—á–∏–∫ –Ø–º–∏ ‚ú®
        </h1>
        <p class="mt-3 text-slate-700 leading-relaxed">
          –ó–¥–µ—Å—å —Ç—ã –º–æ–∂–µ—à—å –∑–∞–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –∑–∞ –±–∞–ª–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞—Ä–∞–±–æ—Ç–∞–ª(–∞) –Ω–∞ –∫–ª–∏–ø–∞—Ö.
        </p>
        
        <div class="mt-5 grid sm:grid-cols-3 gap-3">
          <div class="glass rounded-2xl p-4 border border-white/60">
            <div class="text-2xl mb-2">üé¨</div>
            <div class="text-sm text-slate-600">–°–æ–∑–¥–∞–≤–∞–π –∫–ª–∏–ø—ã</div>
            <div class="font-semibold">+50 –±–∞–ª–ª–æ–≤ –∑–∞ –∫–ª–∏–ø</div>
          </div>
          <div class="glass rounded-2xl p-4 border border-white/60">
            <div class="text-2xl mb-2">üõí</div>
            <div class="text-sm text-slate-600">–í—ã–±–∏—Ä–∞–π –Ω–∞–≥—Ä–∞–¥—ã</div>
            <div class="font-semibold">–ú–µ–º—ã, –∫–∏–Ω–æ, –∏–≥—Ä—ã</div>
          </div>
          <div class="glass rounded-2xl p-4 border border-white/60">
            <div class="text-2xl mb-2">üì©</div>
            <div class="text-sm text-slate-600">–ó–∞–∫–∞–∑—ã–≤–∞–π</div>
            <div class="font-semibold">–ü—Ä—è–º–æ —Å —Å–∞–π—Ç–∞</div>
          </div>
        </div>
        <div class="mt-5 flex flex-wrap gap-2">
          <a href="#products" class="px-4 py-2 rounded-xl bg-white/75 hover:bg-white transition border border-white/70 font-medium">
            –í—ã–±—Ä–∞—Ç—å —Ç–æ–≤–∞—Ä
          </a>
          <a href="#rules" class="px-4 py-2 rounded-xl glass hover:bg-white/60 transition border border-white/60 font-medium">
            –ü—Ä–∞–≤–∏–ª–∞ –∏ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
          </a>
        </div>
      </div>
    </section>
    
    <section id="rules" class="mt-8 md:mt-10">
      <div class="glass glow rounded-3xl p-6 md:p-8 reveal">
        <div class="grid lg:grid-cols-[1fr_320px] gap-8 items-start">
          <div>
            <h2 class="text-xl md:text-2xl font-bold">üìå –ü–†–ê–í–ò–õ–ê –ù–ê–ß–ò–°–õ–ï–ù–ò–Ø –ë–ê–õ–õ–û–í</h2>
            <p class="mt-2 text-slate-600">–ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –∑–∞ –∫–ª–∏–ø—ã. –ù–∏–∂–µ ‚Äî –ø—Ä–∞–≤–∏–ª–∞, –º–∏–Ω–∏‚Äë–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∏ –≤–∏—Ç—Ä–∏–Ω–∞ —Ç–æ–≤–∞—Ä–æ–≤.</p>
            
            <div class="mt-4 space-y-2 text-slate-800 leading-relaxed">
              <p>üé¨ –ó–∞ –∫–∞–∂–¥—ã–π –∫–ª–∏–ø ‚Üí <b>+50 –±–∞–ª–ª–æ–≤</b>.</p>
              <p>‚ú® –ï—Å–ª–∏ –∫–ª–∏–ø–æ–≤ –±–æ–ª—å—à–µ –æ–¥–Ω–æ–≥–æ ‚Üí –∫ –∫–∞–∂–¥–æ–º—É —Å–ª–µ–¥—É—é—â–µ–º—É –¥–æ–±–∞–≤–ª—è–µ–º <b>+3%</b> –æ—Ç —Å—É–º–º—ã –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–ª–∏–ø–∞.</p>
              <div class="mt-3 glass rounded-2xl p-4 border border-white/60">
                <div class="font-semibold mb-2">–ü—Ä–∏–º–µ—Ä—ã:</div>
                <ul class="space-y-1 text-sm text-slate-700">
                  <li>1 –∫–ª–∏–ø = 50 üôÇ</li>
                  <li>2 –∫–ª–∏–ø–∞ = 100 + 3% √ó 100 √ó 1 = 103 üôÇ</li>
                  <li>3 –∫–ª–∏–ø–∞ = 150 + 3% √ó 150 √ó 2 = 159 üôÇ</li>
                  <li>4 –∫–ª–∏–ø–∞ = 200 + 3% √ó 200 √ó 3 = 218 üôÇ</li>
                </ul>
              </div>
              <p class="mt-3">‚ö†Ô∏è –í–∞–∂–Ω–æ: –µ—Å–ª–∏ –∫–ª–∏–ø –Ω–µ –æ —á–µ–º ‚Äî –±–∞–ª–ª—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è!</p>
              <p>üí° –°–æ–≤–µ—Ç: –ß–µ–º –±–æ–ª—å—à–µ –∫–ª–∏–ø–æ–≤ –≤ —Å—Ç—Ä–∏–º–µ ‚Äî —Ç–µ–º –≤—ã–≥–æ–¥–Ω–µ–µ!</p>
              <div class="mt-4 glass rounded-2xl p-4 border border-white/60">
                <p class="text-slate-800">
                  üéÆ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤–æ–∏ –±–∞–ª–ª—ã –≤—ã –º–æ–∂–µ—Ç–µ –Ω–∞ —Ç–≤–∏—á–µ, –Ω–∞–ø–∏—Å–∞—Ç—å –≤ —á–∞—Ç <b>!–ë–∞–ª–∞–Ω—Å</b>
                </p>
              </div>
            </div>
            <div class="mt-5 flex flex-wrap gap-2">
              <button id="openCalc" class="px-4 py-2 rounded-xl bg-white/75 hover:bg-white transition border border-white/70 font-medium">
                –û—Ç–∫—Ä—ã—Ç—å –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –±–∞–ª–ª–æ–≤
              </button>
              <button id="copyBalanceCmd" class="px-4 py-2 rounded-xl glass hover:bg-white/60 transition border border-white/60 font-medium">
                –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É !–ë–∞–ª–∞–Ω—Å
              </button>
            </div>
          </div>
          
          <aside class="glass glow rounded-3xl p-5 border border-white/60">
            <div class="flex items-center justify-between gap-3 mb-4">
              <h3 class="text-lg font-bold">–ë–∞–ª–∞–Ω—Å</h3>
              <label class="inline-flex items-center gap-2 text-xs text-slate-600 select-none">
                <input id="rememberNick" type="checkbox" checked class="yammy-check" />
                <span>–ó–∞–ø–æ–º–Ω–∏—Ç—å –≤—Ö–æ–¥</span>
              </label>
            </div>
            
            <div id="authStatusBlock" class="glass rounded-2xl p-4 border border-white/60 mb-3">
              <div class="text-xs text-slate-600">–°—Ç–∞—Ç—É—Å</div>
              <div id="authStatus" class="font-semibold truncate">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω(–∞)</div>
              <div id="authSub" class="text-xs text-slate-600 mt-1">
                –í–æ–π–¥–∏ —á–µ—Ä–µ–∑ Twitch, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä—è—Ç—å –±–∞–ª–∞–Ω—Å –∏ –æ—Ñ–æ—Ä–º–ª—è—Ç—å –∑–∞–∫–∞–∑.
              </div>
            </div>
            
            <div id="loginButtonBlock" class="mb-3">
              <button id="btnLogin" class="w-full px-4 py-2 rounded-xl font-medium glass hover:bg-white/60 transition border border-white/60">
                –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Twitch
              </button>
            </div>
            
            <div id="balanceInfoBlock" class="hidden space-y-3">
              <div class="glass rounded-2xl p-4 border border-white/60">
                <div class="flex items-center justify-between gap-2">
                  <div>
                    <div class="text-xs text-slate-600">–ù–∏–∫ (Twitch)</div>
                    <div id="displayName" class="font-semibold truncate">‚Äî</div>
                  </div>
                  <button id="btnLogout" class="px-2 py-1 rounded-lg text-xs font-medium bg-white/70 hover:bg-white/90 transition border border-white/60">
                    –í—ã—Ö–æ–¥
                  </button>
                </div>
              </div>
              
              <div class="glass rounded-2xl p-4 border border-white/60">
                <div class="text-xs text-slate-600">–ë–∞–ª–ª—ã</div>
                <div id="balanceValue" class="text-2xl font-extrabold tracking-tight">‚Äî</div>
                <div id="balanceHint" class="mt-2 text-xs text-slate-600">
                  –ù–∞–∂–º–∏ ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª, —á—Ç–æ–±—ã –ø–æ–¥—Ç—è–Ω—É—Ç—å –±–∞–ª–∞–Ω—Å –∏–∑ —Ç–∞–±–ª–∏—Ü—ã.
                </div>
              </div>
              
              <div class="flex flex-wrap gap-2">
                <button id="btnRefreshBalance" class="flex-1 px-4 py-2 rounded-xl bg-white/75 hover:bg-white transition border border-white/70 font-medium">
                  –û–±–Ω–æ–≤–∏—Ç—å
                </button>
                <button id="btnCopyBalance" class="flex-1 px-4 py-2 rounded-xl glass hover:bg-white/60 transition border border-white/60 font-medium">
                  –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å !–ë–∞–ª–∞–Ω—Å
                </button>
              </div>
              <div id="balanceError" class="hidden glass rounded-2xl p-4 border border-rose-200/70 bg-rose-50/60 text-sm text-rose-700">
                –û—à–∏–±–∫–∞
              </div>
            </div>
          </aside>
        </div>
      </div>
    </section>
    
    <section id="products" class="mt-8 md:mt-10">
      <div class="glass glow rounded-3xl p-6 md:p-8 reveal">
        <div class="flex items-end justify-between gap-4 flex-wrap">
          <div>
            <h2 class="text-xl md:text-2xl font-bold">üõçÔ∏è –¢–æ–≤–∞—Ä—ã</h2>
            <p class="mt-2 text-slate-700 text-sm">
              –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä—ã –≤ –æ–¥–Ω–æ–º —Å—Ç–∏–ª–µ ‚Äî —è —Å–æ–±–∏—Ä–∞—é –∏—Ö –≤ –µ–¥–∏–Ω—ã–π –±–ª–æ–∫. –í—ã–±–∏—Ä–∞–π, –∏ —Å–∞–π—Ç –ø—Ä–æ–∫—Ä—É—Ç–∏—Ç —Ç–µ–±—è –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é –∑–∞–∫–∞–∑–∞.
            </p>
          </div>
          <div class="text-sm text-slate-600">
            –í—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä: <span id="selectedProductLabel" class="font-semibold text-slate-900">–Ω–µ –≤—ã–±—Ä–∞–Ω</span>
          </div>
        </div>
        
        <div class="mt-6 grid lg:grid-cols-2 gap-4">
          <div class="glass rounded-3xl p-5 border border-white/60 hover:bg-white/60 transition reveal">
            <div class="flex items-center justify-between gap-3">
              <div>
                <div class="text-xs text-slate-600">üôÇ (–ú–µ–º—ã)</div>
                <div class="text-lg font-bold">–ú–µ–º-–ø–∞–∫</div>
              </div>
              <div class="text-xs text-slate-600">–°—Ç–µ–∫–ª—è–Ω–Ω—ã–π —Å—Ç–∏–ª—å</div>
            </div>
            
            <div class="mt-4 grid sm:grid-cols-2 gap-3">
              <button class="productCard text-left glass rounded-2xl p-4 border border-white/60 hover:bg-white/70 transition" data-title="20 –º–µ–º–æ–≤" data-cost="200">
                <div class="text-sm text-slate-600">200 üôÇ</div>
                <div class="font-semibold">20 –º–µ–º–æ–≤</div>
              </button>
              <button class="productCard text-left glass rounded-2xl p-4 border border-white/60 hover:bg-white/70 transition" data-title="45 –º–µ–º–æ–≤" data-cost="400">
                <div class="text-sm text-slate-600">400 üôÇ</div>
                <div class="font-semibold">45 –º–µ–º–æ–≤</div>
              </button>
            </div>
          </div>
          
          <div class="glass rounded-3xl p-5 border border-white/60 hover:bg-white/60 transition reveal">
            <div class="flex items-center justify-between gap-3">
              <div>
                <div class="text-xs text-slate-600">üé¨ –ö–∏–Ω–æ –∏ –ê–Ω–∏–º–µ</div>
                <div class="text-lg font-bold">–ü—Ä–æ—Å–º–æ—Ç—Ä</div>
              </div>
              <div class="text-xs text-slate-600">–¥–æ 2 —á–∞—Å–æ–≤</div>
            </div>
            
            <div class="mt-4 grid sm:grid-cols-2 gap-3">
              <button class="productCard text-left glass rounded-2xl p-4 border border-white/60 hover:bg-white/70 transition" data-title="–§–∏–ª—å–º / –ú—É–ª—å—Ç—Ñ–∏–ª—å–º" data-cost="750">
                <div class="text-sm text-slate-600">750 üôÇ</div>
                <div class="font-semibold">–§–∏–ª—å–º / –ú—É–ª—å—Ç—Ñ–∏–ª—å–º</div>
              </button>
              <button class="productCard text-left glass rounded-2xl p-4 border border-white/60 hover:bg-white/70 transition" data-title="–ê–Ω–∏–º–µ / –°–µ—Ä–∏–∞–ª / –¢–µ–ª–µ—à–æ—É" data-cost="750">
                <div class="text-sm text-slate-600">750 üôÇ</div>
                <div class="font-semibold">–ê–Ω–∏–º–µ / –°–µ—Ä–∏–∞–ª / –¢–µ–ª–µ—à–æ—É</div>
                <div class="text-xs text-slate-600 mt-1">–µ—Å–ª–∏ –∑–∞–π–¥–µ—Ç ‚Äî —Å–º–æ—Ç—Ä–∏–º —Ñ—É–ª–ª</div>
              </button>
            </div>
          </div>
          
          <div class="glass rounded-3xl p-5 border border-white/60 hover:bg-white/60 transition reveal">
            <div class="flex items-center justify-between gap-3">
              <div>
                <div class="text-xs text-slate-600">üîû (18+)</div>
                <div class="text-lg font-bold">Boosty</div>
              </div>
              <div class="text-xs text-slate-600">–Ω–∞ —Ç–≤–æ–π/–º–æ–π –≤—ã–±–æ—Ä</div>
            </div>
            
            <div class="mt-4">
              <button class="productCard w-full text-left glass rounded-2xl p-4 border border-white/60 hover:bg-white/70 transition" data-title="–•–µ–Ω—Ç–∞–π –∞–Ω–∏–º–µ / –ü–æ—Ä–Ω–æ-–∏–≥—Ä—ã –Ω–∞ Boosty" data-cost="1000">
                <div class="text-sm text-slate-600">1000 üôÇ</div>
                <div class="font-semibold">–•–µ–Ω—Ç–∞–π –∞–Ω–∏–º–µ / –ü–æ—Ä–Ω–æ-–∏–≥—Ä—ã –Ω–∞ Boosty</div>
              </button>
            </div>
          </div>
          
          <div class="glass rounded-3xl p-5 border border-white/60 hover:bg-white/60 transition reveal">
            <div class="flex items-center justify-between gap-3">
              <div>
                <div class="text-xs text-slate-600">üéÆ –ì–µ–π–º–µ—Ä—Å–∫–∞—è –∑–æ–Ω–∞</div>
                <div class="text-lg font-bold">–ò–≥—Ä–∞–µ–º</div>
              </div>
              <div class="text-xs text-slate-600">2 —á–∞—Å–∞ –º–∏–Ω–∏–º—É–º</div>
            </div>
            
            <div class="mt-4">
              <button class="productCard w-full text-left glass rounded-2xl p-4 border border-white/60 hover:bg-white/70 transition" data-title="–ò–≥—Ä–∞—é –≤ –¢–í–û–Æ –∏–≥—Ä—É" data-cost="1500">
                <div class="text-sm text-slate-600">1500 üôÇ</div>
                <div class="font-semibold">–ò–≥—Ä–∞—é –≤ –¢–í–û–Æ –∏–≥—Ä—É</div>
                <div class="text-xs text-slate-600 mt-1">–î–ª—è MMO ‚Äî —Ç–æ–ª—å–∫–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∏–≥—Ä—ã. –ï—Å–ª–∏ –∏–≥—Ä–∞ –Ω–µ ¬´–∑–∞—à–ª–∞¬ª ‚Äî —Å—Ç–æ–ø —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞.</div>
              </button>
            </div>
          </div>
          
          <div class="glass rounded-3xl p-5 border border-white/60 hover:bg-white/60 transition lg:col-span-2 reveal">
            <div class="flex items-center justify-between gap-3 flex-wrap">
              <div>
                <div class="text-xs text-slate-600">üëë –£–ª—å—Ç–∏–º–∞—Ç–∏–≤–Ω—ã–π –∑–∞–∫–∞–∑</div>
                <div class="text-lg font-bold">12 —á–∞—Å–æ–≤ —Å—Ç—Ä–∏–º–∞</div>
              </div>
              <div class="text-sm text-slate-700 font-semibold">5000 üôÇ</div>
            </div>
            
            <div class="mt-4">
              <button class="productCard w-full text-left glass rounded-2xl p-4 border border-white/60 hover:bg-white/70 transition" data-title="12 —á–∞—Å–æ–≤ —Å—Ç—Ä–∏–º–∞" data-cost="5000">
                <div class="text-sm text-slate-600">5000 üôÇ</div>
                <div class="font-semibold">‚Äî / 12 —á–∞—Å–æ–≤ —Å—Ç—Ä–∏–º–∞!</div>
              </button>
            </div>
          </div>
          
          <div class="glass rounded-3xl p-5 border border-white/60 hover:bg-white/60 transition reveal">
            <div class="flex items-center justify-between gap-3">
              <div>
                <div class="text-xs text-slate-600">üñåÔ∏è –†–∏—Å—É–Ω–∫–∏</div>
                <div class="text-lg font-bold">–ê—Ä—Ç</div>
              </div>
              <div class="text-xs text-slate-600">–ù–µ–±–æ–ª—å—à–∏–µ —Ä–∏—Å—É–Ω–∫–∏</div>
            </div>
            
            <div class="mt-4">
              <button class="productCard w-full text-left glass rounded-2xl p-4 border border-white/60 hover:bg-white/70 transition" data-title="–ó–∞–∫–∞–∑–∞—Ç—å –≤—Å—Ä–∞—Ç—ã—à–∞" data-cost="3000">
                <div class="text-sm text-slate-600">3000 üôÇ</div>
                <div class="font-semibold">–ó–∞–∫–∞–∑–∞—Ç—å –≤—Å—Ä–∞—Ç—ã—à–∞</div>
              </button>
            </div>
          </div>
          
          <div class="glass rounded-3xl p-5 border border-white/60 hover:bg-white/60 transition reveal">
            <div class="flex items-center justify-between gap-3">
              <div>
                <div class="text-xs text-slate-600">üéÅ –°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç</div>
                <div class="text-lg font-bold">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</div>
              </div>
              <div class="text-xs text-slate-600">–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ</div>
            </div>
            
            <div class="mt-4">
              <button class="productCard w-full text-left glass rounded-2xl p-4 border border-white/60 hover:bg-white/70 transition" data-title="–•–æ—á—É –æ–±—Å—É–¥–∏—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –∑–∞–∫–∞–∑" data-cost="null">
                <div class="text-sm text-slate-600">‚Äî</div>
                <div class="font-semibold">–•–æ—á—É –æ–±—Å—É–¥–∏—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –∑–∞–∫–∞–∑</div>
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <section id="howto" class="mt-8 md:mt-10 grid lg:grid-cols-2 gap-6 items-start">
      <div class="glass glow rounded-3xl p-6 md:p-8 reveal">
        <h2 class="text-xl md:text-2xl font-bold">–ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑?</h2>
        <p class="mt-3 text-slate-700 leading-relaxed">
          –ù–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ –≤ –õ–° –≤ Telegram ‚Äî –æ–¥–Ω–∏–º –∫–ª–∏–∫–æ–º –∏–∑ —ç—Ç–æ–≥–æ —Å–∞–π—Ç–∞.
        </p>
        <ol class="mt-4 space-y-2 text-slate-800">
          <li>1) –í—ã–±–µ—Ä–∏ –Ω–∞–≥—Ä–∞–¥—É –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–¢–æ–≤–∞—Ä—ã¬ª.</li>
          <li>2) –î–æ–±–∞–≤—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) –∏ –Ω–∞–∂–º–∏ ¬´–ó–∞–∫–∞–∑–∞—Ç—å¬ª.</li>
          <li>3) –Ø –ø–æ–ª—É—á—É –∑–∞–∫–∞–∑ –≤ Telegram –∏ –æ—Ç–≤–µ—á—É —Ç–µ–±–µ.</li>
        </ol>
      </div>
      
      <div id="order" class="glass glow rounded-3xl p-6 md:p-8 reveal">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h3 class="text-xl font-bold">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h3>
            <p class="mt-1 text-sm text-slate-700">
              –í—ã–±–µ—Ä–∏ —Ç–æ–≤–∞—Ä, –ø—Ä–æ–≤–µ—Ä—å –±–∞–ª–∞–Ω—Å –∏ –æ—Ç–ø—Ä–∞–≤—å –∑–∞–∫–∞–∑.
            </p>
          </div>
          <div class="text-right text-sm">
            <div class="text-slate-600">–°—Ç–æ–∏–º–æ—Å—Ç—å</div>
            <div id="orderCost" class="text-2xl font-extrabold">‚Äî</div>
          </div>
        </div>
        
        <form id="orderForm" class="mt-5 space-y-3">
          <div class="glass rounded-2xl p-4 border border-white/60">
            <label class="text-xs text-slate-600">–¢–æ–≤–∞—Ä</label>
            <div id="orderProduct" class="font-semibold mt-1">–ù–µ –≤—ã–±—Ä–∞–Ω</div>
          </div>
          
          <div>
            <label for="comment" class="text-xs text-slate-600">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
            <textarea id="comment" rows="4" class="mt-1 w-full rounded-2xl glass border border-white/60 p-4 outline-none focus:ring-2 focus:ring-white/60" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∫–∞–∫–æ–π —Ñ–∏–ª—å–º / –∫–∞–∫–∞—è –∏–≥—Ä–∞ / –ª—é–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è"></textarea>
          </div>
          
          <div id="inlineMsg" class="hidden glass rounded-2xl p-4 border border-white/60 text-sm"></div>
          
          <button id="btnOrder" type="submit" class="w-full px-5 py-3 rounded-2xl font-semibold bg-white/80 hover:bg-white transition border border-white/70">
            –ó–∞–∫–∞–∑–∞—Ç—å
          </button>
          <button id="btnOrderAgain" type="button" class="hidden w-full px-5 py-3 rounded-2xl font-semibold glass hover:bg-white/60 transition border border-white/60">
            –û—Ñ–æ—Ä–º–∏—Ç—å –µ—â—ë –æ–¥–∏–Ω –∑–∞–∫–∞–∑
          </button>
        </form>
        
        <div id="progressArea" class="hidden mt-5 glass rounded-2xl p-4 border border-white/60">
          <div class="flex items-center gap-3">
            <div id="spinner" class="h-5 w-5 rounded-full border-2 border-slate-900/25 border-t-slate-900 animate-spin"></div>
            <div id="progressText" class="text-sm text-slate-800">–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–∫–∞–∑...</div>
          </div>
          <div id="progressSub" class="mt-1 text-xs text-slate-600"></div>
        </div>
      </div>
    </section>
    
    <footer class="mt-10">
      <div class="glass glow rounded-3xl p-6 md:p-8 text-sm text-slate-700 reveal">
        <div class="flex items-center justify-between gap-3 flex-wrap">
          <div>
            –°–¥–µ–ª–∞–Ω–æ —Å –ª—é–±–æ–≤—å—é ‚ù§Ô∏è
          </div>
          <a href="#top" id="toTop" class="px-4 py-2 rounded-xl glass hover:bg-white/60 transition border border-white/60 font-medium">
            –ù–∞–≤–µ—Ä—Ö
          </a>
        </div>
      </div>
    </footer>
  </main>
  
  <div id="calcModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 modal-backdrop"></div>
    
    <div class="relative mx-auto max-w-lg px-4 py-8">
      <div class="glass glow rounded-3xl p-6 md:p-7 border border-white/60">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="text-lg font-bold">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –±–∞–ª–ª–æ–≤</div>
            <div class="text-sm text-slate-700 mt-1">+3% –∫–∞–∂–¥—ã–π —Å–ª–µ–¥—É—é—â–∏–π –∫–ª–∏–ø</div>
          </div>
          <button id="closeCalc" class="px-3 py-2 rounded-xl glass border border-white/60 hover:bg-white/60 transition">
            –ó–∞–∫—Ä—ã—Ç—å
          </button>
        </div>
        
        <div class="mt-5 grid grid-cols-[auto_1fr_auto] gap-2 items-center">
          <button id="clipsMinus" class="h-12 w-12 rounded-2xl glass border border-white/60 hover:bg-white/60 transition text-xl">‚àí</button>
          <input id="clipsInput" inputmode="numeric" pattern="[0-9]*" class="h-12 w-full rounded-2xl glass border border-white/60 px-4 text-center text-lg font-semibold outline-none focus:ring-2 focus:ring-white/60" value="1" />
          <button id="clipsPlus" class="h-12 w-12 rounded-2xl glass border border-white/60 hover:bg-white/60 transition text-xl">+</button>
        </div>
        
        <div class="mt-4 glass rounded-2xl p-4 border border-white/60">
          <div class="text-xs text-slate-600">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
          <div class="mt-1 flex items-center justify-between gap-3">
            <div id="calcResult" class="text-3xl font-extrabold">50</div>
            <button id="copyCalc" class="px-4 py-2 rounded-xl bg-white/75 hover:bg-white transition border border-white/70 font-medium">
              –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
            </button>
          </div>
          <div class="mt-1 text-xs text-slate-600">–ó–∞–∫—Ä—ã—Ç–∏–µ: ESC</div>
        </div>
      </div>
    </div>
  </div>
  
  <div id="toastHost" class="fixed z-[60] bottom-4 left-0 right-0 px-4 flex flex-col items-center gap-2"></div>
  
  <script>
    // --- In-app browsers fallback ---
    try {
      const ua = (navigator.userAgent || '').toLowerCase();
      const inApp = ua.includes('telegram') || ua.includes('instagram') || ua.includes('fbav') || ua.includes('fban');
      if (inApp) document.documentElement.classList.add('no-io');
      if (!('IntersectionObserver' in window)) document.documentElement.classList.add('no-io');
    } catch (e) {
      document.documentElement.classList.add('no-io');
    }

    // ----- Helpers -----
    const $ = (sel, root = document) => root.querySelector(sel);
    const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

    async function copyText(text) {
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch (e) {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        try {
          document.execCommand('copy');
          return true;
        } catch (err) {
          return false;
        } finally {
          document.body.removeChild(ta);
        }
      }
    }

    function toast(el) {
      if (!el) return;
      el.classList.remove('hidden');
      el.style.opacity = '0';
      el.style.transition = 'opacity .25s ease';
      requestAnimationFrame(() => el.style.opacity = '1');
      clearTimeout(el._t);
      el._t = setTimeout(() => {
        el.style.opacity = '0';
        setTimeout(() => el.classList.add('hidden'), 260);
      }, 1300);
    }

    function roundNice(n) {
      const r = Math.round(n);
      if (Math.abs(n - r) < 1e-9) return String(r);
      const one = Math.round(n * 10) / 10;
      return String(one).replace('.', ',');
    }

    // ----- Calculator -----
    function calcTotal(clips) {
      clips = Math.max(0, Math.floor(Number(clips) || 0));
      // –§–æ—Ä–º—É–ª–∞: S = 50√óN + 0.03√ó(50√óN)√ó(N-1)
      const base = 50 * clips;
      const bonus = 0.03 * base * (clips - 1);
      return base + bonus;
    }

    function updateCalc() {
      const clipsEl = $('#clipsInput');
      const totalEl = $('#calcResult');
      if (!clipsEl || !totalEl) return;
      let c = Math.max(0, Math.floor(Number(clipsEl.value || 0)));
      clipsEl.value = c;
      totalEl.textContent = roundNice(calcTotal(c));
    }

    function openCalcModal() {
      const m = $('#calcModal');
      if (!m) return;
      m.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      updateCalc();
      setTimeout(() => $('#clipsInput')?.focus(), 50);
    }

    function closeCalcModal() {
      const m = $('#calcModal');
      if (!m) return;
      m.classList.add('hidden');
      document.body.style.overflow = '';
    }

    // ----- Products -----
    let picked = '';
    let pickedCost = null;

    function setSelectedProduct(p) {
      picked = p.title;
      pickedCost = p.cost === 'null' ? null : Number(p.cost);
      const selectedProductLabel = $('#selectedProductLabel');
      const orderProduct = $('#orderProduct');
      const orderCost = $('#orderCost');
      
      if (selectedProductLabel) selectedProductLabel.textContent = `${p.title}`;
      if (orderProduct) orderProduct.textContent = `${p.title}`;
      if (orderCost) orderCost.textContent = p.cost === 'null' ? '‚Äî' : `${p.cost} üôÇ`;
      
      // Highlight selected button
      $$('.productCard').forEach(btn => {
        const isActive = (btn.dataset.title === p.title) && (btn.dataset.cost === p.cost);
        btn.style.outline = isActive ? '2px solid rgba(15,23,42,.35)' : 'none';
        btn.style.boxShadow = isActive ? '0 0 0 6px rgba(255,255,255,.18)' : '';
      });
      
      // Scroll to order section
      $('#order')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // ----- Google Sheets API (Apps Script) -----
    const BALANCE_API_URL = 'https://script.google.com/macros/s/AKfycbxv93RskaQaMSQ4t41bpKLhUfx1RQHiwPl-tdYicJ12lvDJ7ZCZhSCAwR2PjSYqZDo/exec';
    const SPEND_ENABLED = true;
    const SPEND_TOKEN = 'yammy_spend_v1';

    function normNick(s) { return String(s ?? '').trim().toLowerCase(); }

    function parsePoints(v) {
      if (v === null || v === undefined) return NaN;
      if (typeof v === 'number') return v;
      const s = String(v).trim().replace(',', '.');
      const n = Number(s);
      return Number.isFinite(n) ? n : NaN;
    }

    async function fetchBalances() {
      const res = await fetch(BALANCE_API_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error('API request failed');
      const json = await res.json();
      if (!json || json.ok !== true || !Array.isArray(json.data)) throw new Error('Bad API payload');
      return json.data;
    }

    async function spendPoints({ nick, amount, item, comment } = {}) {
      const cleanNick = String(nick || '').trim();
      const a = Number(amount);
      if (!cleanNick) return { ok: false, reason: 'nonick' };
      if (!Number.isFinite(a) || a <= 0) return { ok: false, reason: 'badamount' };

      const payload = {
        action: 'spend',
        token: SPEND_TOKEN,
        nick: cleanNick,
        amount: a,
        item: String(item || '').slice(0, 200),
        comment: String(comment || '').slice(0, 500),
        at: Date.now(),
      };

      const res = await fetch(BALANCE_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(payload)
      });

      const txt = await res.text();
      try { return JSON.parse(txt); }
      catch (e) { return { ok: false, reason: 'badjson', raw: txt.slice(0, 200) }; }
    }

    async function findBalanceByNick(nick) {
      const needle = normNick(nick);
      if (!needle) return { found: false, reason: 'empty' };
      const rows = await fetchBalances();
      const nickKeys = ['–ù–∏–∫–Ω–µ–π–º', '–Ω–∏–∫–Ω–µ–π–º', 'Nick', 'nick', '–ù–∏–∫', '–Ω–∏–∫'];
      const pointsKeys = ['–ò—Ç–æ–≥–æ–≤—ã–µ –±–∞–ª–ª—ã', '–∏—Ç–æ–≥–æ–≤—ã–µ –±–∞–ª–ª—ã', '–ë–∞–ª–ª—ã', '–±–∞–ª–ª—ã', 'Points', 'points'];

      for (const r of rows) {
        const nickVal = nickKeys.map(k => r[k]).find(v => v !== undefined);
        const rowNick = normNick(nickVal);
        if (!rowNick) continue;
        if (rowNick === needle) {
          const ptsVal = pointsKeys.map(k => r[k]).find(v => v !== undefined);
          const pts = parsePoints(ptsVal);
          return { found: true, nick: nickVal ?? nick, points: ptsVal, pointsNum: pts };
        }
      }
      return { found: false, reason: 'notfound' };
    }

    // ----- Twitch OAuth (PKCE primary + Implicit fallback) -----
    const TWITCH_CLIENT_ID = '89zu7axvj9y80avfsn6a5l20mv5kjq';
    const TWITCH_REDIRECT_URI = 'https://yammyvt.github.io/YammyTanuki/';
    const TWITCH_SCOPES = [];
    const AUTH_STORAGE_KEY = 'yammy_twitch_auth_v2';
    const PKCE_STORAGE_KEY = 'yammy_twitch_pkce_v2';

    function setPkceState(obj) { sessionStorage.setItem(PKCE_STORAGE_KEY, JSON.stringify(obj || {})); }
    function getPkceState() { try { return JSON.parse(sessionStorage.getItem(PKCE_STORAGE_KEY) || '{}'); } catch (e) { return {}; } }
    function clearPkceState() { sessionStorage.removeItem(PKCE_STORAGE_KEY); }

    function setAuth(obj) {
      const remember = document.getElementById('rememberNick');
      const data = obj || {};
      try {
        if (remember && remember.checked === false) {
          sessionStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(data));
          localStorage.removeItem(AUTH_STORAGE_KEY);
        } else {
          localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(data));
          sessionStorage.removeItem(AUTH_STORAGE_KEY);
        }
      } catch (e) {
        try { localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(data)); } catch (err) {}
      }
    }

    function getAuth() {
      try { const s = sessionStorage.getItem(AUTH_STORAGE_KEY); if (s) return JSON.parse(s); } catch (e) {}
      try { return JSON.parse(localStorage.getItem(AUTH_STORAGE_KEY) || '{}'); } catch (e) { return {}; }
    }

    function clearAuth() {
      try { localStorage.removeItem(AUTH_STORAGE_KEY); } catch (e) {}
      try { sessionStorage.removeItem(AUTH_STORAGE_KEY); } catch (e) {}
    }

    function base64UrlEncode(uint8) {
      let s = '';
      uint8.forEach(b => s += String.fromCharCode(b));
      return btoa(s).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    function randomString(len = 64) {
      try {
        const a = new Uint8Array(len);
        crypto.getRandomValues(a);
        return base64UrlEncode(a);
      } catch (e) {
        let s = '';
        for (let i = 0; i < len; i++) s += String.fromCharCode(Math.floor(Math.random() * 256));
        return btoa(s).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      }
    }

    async function sha256(text) {
      const enc = new TextEncoder().encode(text);
      const hash = await crypto.subtle.digest('SHA-256', enc);
      return new Uint8Array(hash);
    }

    function withTimeout(promise, ms = 12000) {
      return new Promise((resolve, reject) => {
        const t = setTimeout(() => reject(new Error('Timeout')), ms);
        promise.then(v => { clearTimeout(t); resolve(v); }, e => { clearTimeout(t); reject(e); });
      });
    }

    function cleanUrlAfterOAuth() {
      const url = new URL(window.location.href);
      url.searchParams.delete('code');
      url.searchParams.delete('scope');
      url.searchParams.delete('state');
      window.history.replaceState({}, document.title, url.toString());
    }

    async function twitchExchangeCode(code) {
      const st = getPkceState();
      if (!st || !st.verifier) throw new Error('Missing PKCE verifier');
      const redirectUri = String(TWITCH_REDIRECT_URI || '').trim();
      const dbg = `client_id=${TWITCH_CLIENT_ID} redirect_uri=${redirectUri}`;
      const params = new URLSearchParams({
        client_id: TWITCH_CLIENT_ID,
        grant_type: 'authorization_code',
        code: String(code || ''),
        redirect_uri: redirectUri,
        code_verifier: String(st.verifier || '')
      });

      const endpoints = ['https://id.twitch.tv/oauth2/token', 'https://api.twitch.tv/oauth2/token'];
      let lastTxt = '';
      let lastJson = null;
      let lastStatus = 0;

      for (const ep of endpoints) {
        let res;
        try {
          res = await withTimeout(fetch(ep, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params.toString()
          }), 12000);
        } catch (e) {
          lastTxt = String(e?.message || e);
          lastJson = null;
          lastStatus = 0;
          continue;
        }
        lastStatus = res.status;
        lastTxt = await res.text();
        lastJson = null;
        try { lastJson = JSON.parse(lastTxt); } catch (e) {}
        if (res.ok && lastJson?.access_token) return lastJson;
      }

      const desc = lastJson?.message || lastJson?.error_description || lastJson?.error || lastTxt || `HTTP ${lastStatus}`;
      if (String(desc).toLowerCase().includes('invalid client credentials')) {
        throw new Error(`Token exchange failed: Invalid client credentials (${dbg})`);
      }
      if (String(desc).toLowerCase().includes('failed to fetch') || String(desc).toLowerCase().includes('timeout')) {
        throw new Error(`Token exchange failed: Failed to fetch (–≤–æ–∑–º–æ–∂–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–µ—Ç–∏/AdBlock/–±—Ä–∞—É–∑–µ—Ä–æ–º). –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–π –±—Ä–∞—É–∑–µ—Ä –∏–ª–∏ –≤—ã–∫–ª—é—á–∏ –±–ª–æ–∫–∏—Ä–æ–≤—â–∏–∫. (${dbg})`);
      }
      throw new Error(`Token exchange failed: ${desc} (${dbg})`);
    }

    async function twitchGetUserHelix(accessToken) {
      const res = await withTimeout(fetch('https://api.twitch.tv/helix/users', {
        headers: {
          'Authorization': `Bearer ${accessToken}`,
          'Client-ID': TWITCH_CLIENT_ID
        }
      }), 12000);

      const txt = await res.text();
      let json = null;
      try { json = JSON.parse(txt); } catch (e) {}
      if (!res.ok) {
        const desc = json?.message || json?.error || txt.slice(0, 200);
        throw new Error(`Failed to fetch user: ${desc}`);
      }
      const u = json?.data?.[0];
      const login = String(u?.login || '').trim();
      const display = String(u?.display_name || login).trim();
      return login ? { login, display_name: display, login_lower: login.toLowerCase() } : null;
    }

    function handleImplicitTokenFromHash() {
      const h = String(window.location.hash || '');
      if (!h || !h.includes('access_token=')) return null;
      const params = new URLSearchParams(h.replace(/^#/, ''));
      const token = params.get('access_token');
      const state = params.get('state') || '';
      if (!token) return null;
      try { history.replaceState({}, document.title, window.location.pathname + window.location.search); } catch (e) {}
      return { access_token: token, state };
    }

    function setNickUIAuthed(displayName) {
      const status = $('#authStatus');
      const nickLine = $('#displayName');
      if (nickLine) nickLine.textContent = displayName ? displayName : '‚Äî';
      if (status) status.textContent = displayName ? '–í—ã –≤–æ—à–ª–∏ —á–µ—Ä–µ–∑ Twitch.' : '–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Twitch, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –±–∞–ª–∞–Ω—Å.';

      $('#authStatusBlock')?.classList.toggle('hidden', !!displayName);
      $('#loginButtonBlock')?.classList.toggle('hidden', !!displayName);
      $('#balanceInfoBlock')?.classList.toggle('hidden', !displayName);
      $('#btnLogout')?.classList.toggle('hidden', !displayName);
    }

    function getKnownNick() {
      const a = getAuth();
      return String(a?.login || '').trim();
    }

    function getKnownDisplayName() {
      const a = getAuth();
      return String(a?.display_name || a?.login || '').trim();
    }

    async function refreshBalanceForAuthed() {
      const out = $('#balanceValue');
      const hint = $('#balanceHint');
      const nickLine = $('#displayName');
      const login = getKnownNick();
      let displayName = getKnownDisplayName();

      // –ï—Å–ª–∏ –Ω–µ—Ç display_name –≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–º auth, –ø–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Å Twitch
      const auth = getAuth();
      if (auth?.login && !auth?.display_name && auth?.access_token) {
        try {
          const user = await twitchGetUserHelix(auth.access_token);
          if (user?.display_name) {
            auth.display_name = user.display_name;
            setAuth(auth);
            displayName = user.display_name;
          }
        } catch (e) {
          // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º login
        }
      }

      if (!login) {
        if (nickLine) nickLine.textContent = '‚Äî';
        if (out) out.textContent = '‚Äî';
        if (hint) hint.textContent = '–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Twitch, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –±–∞–ª–∞–Ω—Å.';
        return;
      }

      if (nickLine) nickLine.textContent = displayName;
      if (!BALANCE_API_URL) {
        if (out) out.textContent = '–ë–∞–ª–∞–Ω—Å –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω.';
        if (hint) hint.textContent = '–ù—É–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å URL Apps Script –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é BALANCE_API_URL.';
        return;
      }

      if (out) out.textContent = '–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶';
      try {
        const res = await findBalanceByNick(login);
        if (res.found) {
          const pts = Number.isFinite(res.pointsNum) ? Math.round(res.pointsNum) : res.points;
          if (out) out.textContent = `${pts} üôÇ`;
          if (hint) hint.textContent = '–ï—Å–ª–∏ –±–∞–ª–ª—ã –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç ‚Äî –ø—Ä–æ–≤–µ—Ä—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã.';
        } else {
          if (out) out.textContent = '0 üôÇ üò¢';
          if (hint) hint.textContent = '–£ –≤–∞—Å 0 –±–∞–ª–ª–æ–≤ üò¢';
        }
      } catch (e) {
        if (out) out.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.';
        if (hint) hint.textContent = '–ü—Ä–æ–≤–µ—Ä—å –¥–æ—Å—Ç—É–ø Apps Script (Deploy ‚Üí Web app ‚Üí –¥–æ—Å—Ç—É–ø: "–í—Å–µ").';
      }
    }

    async function handleTwitchOAuthCallback() {
      // Implicit token flow
      const implicit = handleImplicitTokenFromHash();
      if (implicit?.access_token) {
        try {
          const user = await twitchGetUserHelix(implicit.access_token);
          if (!user?.login) throw new Error('No login');
          setAuth({ login: user.login, display_name: user.display_name, access_token: implicit.access_token, obtained_at: Date.now(), implicit: true });
          setNickUIAuthed(user.display_name);
          await refreshBalanceForAuthed();
        } catch (e) {
          clearAuth();
          setNickUIAuthed('');
          const hint = $('#balanceHint');
          if (hint) hint.textContent = `–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Twitch. ${String(e?.message || e)}`;
        }
        return;
      }

      // PKCE code flow
      const url = new URL(window.location.href);
      const code = url.searchParams.get('code');
      const state = url.searchParams.get('state');
      if (!code) return;

      const st0 = getPkceState();
      if (!st0?.state || !st0?.verifier) {
        clearPkceState();
        cleanUrlAfterOAuth();
        clearAuth();
        setNickUIAuthed('');
        const hint = $('#balanceHint');
        if (hint) hint.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å –≤—Ö–æ–¥. –ù–∞–∂–º–∏ ¬´–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Twitch¬ª –µ—â—ë —Ä–∞–∑.';
        return;
      }

      try {
        const st = getPkceState();
        if (st.state !== state) throw new Error('Bad state');
        const token = await twitchExchangeCode(code);
        const user = await twitchGetUserHelix(token.access_token);
        if (!user?.login) throw new Error('No login');
        setAuth({ login: user.login, display_name: user.display_name, access_token: token.access_token, expires_in: token.expires_in, obtained_at: Date.now() });
        setNickUIAuthed(user.display_name);
        await refreshBalanceForAuthed();
      } catch (e) {
        clearAuth();
        setNickUIAuthed('');
        const hint = $('#balanceHint');
        if (hint) hint.textContent = `–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Twitch. ${String(e?.message || e)}`;
      } finally {
        clearPkceState();
        cleanUrlAfterOAuth();
      }
    }

    async function twitchLogin() {
      clearPkceState();
      try { cleanUrlAfterOAuth(); } catch (e) {}

      const redirectUri = String(TWITCH_REDIRECT_URI || '').trim();
      const ua = (navigator.userAgent || '').toLowerCase();

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–æ–±–∏–ª—å–Ω—ã–µ –∏ –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã
      const isAndroid = /android/i.test(ua);
      const isIOS = /iphone|ipad|ipod/i.test(ua);
      const isTelegramBrowser = /telegram/i.test(ua) || ua.includes('tgwebview');

      // Telegram - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
      if (isTelegramBrowser) {
        const inlineMsg = $('#inlineMsg');
        if (inlineMsg) {
          inlineMsg.className = 'glass rounded-2xl p-4 border border-amber-200/70 bg-amber-50/60 text-sm text-amber-900';
          inlineMsg.textContent = 'Telegram –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä –∏–º–µ–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç –≤ Chrome –∏–ª–∏ Safari –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.';
          inlineMsg.classList.remove('hidden');
        }
        return;
      }

      // –ò—Å–ø–æ–ª—å–∑—É–µ–º Implicit flow –¥–ª—è –í–°–ï–• (–ø—Ä–æ—â–µ –∏ –Ω–∞–¥–µ–∂–Ω–µ–µ)
      const state = `implicit_${randomString(24)}`;
      const params = new URLSearchParams({
        client_id: TWITCH_CLIENT_ID,
        redirect_uri: redirectUri,
        response_type: 'token',
        scope: TWITCH_SCOPES.join(' '),
        state: state
      });

      const authUrl = `https://id.twitch.tv/oauth2/authorize?${params.toString()}`;

      // –î–ª—è Android –∏—Å–ø–æ–ª—å–∑—É–µ–º Intent URI
      if (isAndroid && !isTelegramBrowser) {
        const intentUrl = `intent://id.twitch.tv/oauth2/authorize?${params.toString()}#Intent;scheme=https;action=android.intent.action.VIEW;S.browser_fallback_url=${encodeURIComponent(authUrl)};end;`;
        window.location.href = intentUrl;
        setTimeout(() => {
          window.location.href = authUrl;
        }, 500);
      } else {
        window.location.assign(authUrl);
      }
    }

    function twitchLogout() {
      clearAuth();
      setNickUIAuthed('');
      refreshBalanceForAuthed();
    }

    // ----- Telegram Bot API -----
    const TELEGRAM_BOT_API_URL = 'https://script.google.com/macros/s/AKfycbzn3wvaFYwSWkopLZP1ueRb52pJnbWM7sB2Ay4DOx3FPPvBQITpaLF-cx2hflnZ10-_Xg/exec';

    async function sendOrderToBot({ nick, item, price, comment }) {
      try {
        const res = await fetch(TELEGRAM_BOT_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({
            nick: nick || '–ù–µ —É–∫–∞–∑–∞–Ω',
            item: item || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
            price: price || '‚Äî',
            comment: comment || '–ù–µ—Ç'
          })
        });

        const text = await res.text();
        let data;
        try {
          data = JSON.parse(text);
        } catch (e) {
          return { ok: false, error: '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞', raw: text };
        }
        return data;
      } catch (e) {
        return { ok: false, error: String(e) };
      }
    }

    // ----- Order functions -----
    function showInline(type, text) {
      const inlineMsg = $('#inlineMsg');
      if (!inlineMsg) return;

      inlineMsg.classList.remove('hidden');
      inlineMsg.classList.remove('bg-emerald-50/60', 'border-emerald-200/70', 'text-emerald-800');
      inlineMsg.classList.remove('bg-rose-50/60', 'border-rose-200/70', 'text-rose-700');
      inlineMsg.classList.remove('bg-amber-50/60', 'border-amber-200/70', 'text-amber-900');

      if (type === 'ok') {
        inlineMsg.classList.add('bg-emerald-50/60', 'border-emerald-200/70', 'text-emerald-800');
      } else if (type === 'err') {
        inlineMsg.classList.add('bg-rose-50/60', 'border-rose-200/70', 'text-rose-700');
      } else {
        inlineMsg.classList.add('bg-amber-50/60', 'border-amber-200/70', 'text-amber-900');
      }
      inlineMsg.textContent = text;
    }

    function hideInline() {
      const inlineMsg = $('#inlineMsg');
      if (inlineMsg) {
        inlineMsg.classList.add('hidden');
        inlineMsg.textContent = '';
      }
    }

    function setProgress(on, text = '', sub = '') {
      const progressArea = $('#progressArea');
      const progressText = $('#progressText');
      const progressSub = $('#progressSub');
      const spinner = $('#spinner');

      if (progressArea) progressArea.classList.toggle('hidden', !on);
      if (spinner) spinner.classList.toggle('hidden', !on);
      if (progressText) progressText.textContent = text;
      if (progressSub) progressSub.textContent = sub;
    }

    function setOrderEnabled(enabled) {
      const btnOrder = $('#btnOrder');
      const commentEl = $('#comment');

      if (btnOrder) {
        btnOrder.disabled = !enabled;
        btnOrder.classList.toggle('opacity-60', !enabled);
        btnOrder.classList.toggle('cursor-not-allowed', !enabled);
      }
      if (commentEl) commentEl.disabled = !enabled;
    }

    function resetOrderUI() {
      hideInline();
      setProgress(false);
      const btnOrderAgain = $('#btnOrderAgain');
      const btnOrder = $('#btnOrder');
      if (btnOrderAgain) btnOrderAgain.classList.add('hidden');
      if (btnOrder) btnOrder.classList.remove('hidden');
      setOrderEnabled(true);
    }

    // ----- Event Listeners -----
    function initEventListeners() {
      // Calculator
      $('#clipsMinus')?.addEventListener('click', () => {
        const i = $('#clipsInput');
        if (!i) return;
        i.value = Math.max(0, (Number(i.value) || 0) - 1);
        updateCalc();
      });

      $('#clipsPlus')?.addEventListener('click', () => {
        const i = $('#clipsInput');
        if (!i) return;
        i.value = (Number(i.value) || 0) + 1;
        updateCalc();
      });

      $('#clipsInput')?.addEventListener('input', updateCalc);
      $('#openCalc')?.addEventListener('click', openCalcModal);
      $('#closeCalc')?.addEventListener('click', closeCalcModal);
      $('#calcModal .absolute')?.addEventListener('click', closeCalcModal);

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !$('#calcModal')?.classList.contains('hidden')) {
          closeCalcModal();
        }
      });

      $('#copyCalc')?.addEventListener('click', async () => {
        const c = Number($('#clipsInput')?.value) || 0;
        const t = $('#calcResult')?.textContent || '';
        const ok = await copyText(`–ö–ª–∏–ø–æ–≤: ${c}. –ò—Ç–æ–≥–æ –±–∞–ª–ª–æ–≤: ${t} üôÇ`);
        if (ok) {
          const toastEl = document.createElement('div');
          toastEl.className = 'toast glass border border-white/60 rounded-2xl px-4 py-3 shadow-[0_18px_55px_rgba(18,28,55,.14)] bg-emerald-50/60 text-emerald-800 max-w-[92vw]';
          toastEl.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ';
          $('#toastHost').appendChild(toastEl);
          setTimeout(() => {
            toastEl.style.opacity = '0';
            toastEl.style.transform = 'translateY(10px)';
            toastEl.style.transition = 'opacity .2s ease, transform .2s ease';
            setTimeout(() => toastEl.remove(), 220);
          }, 1300);
        }
      });

      // Copy balance commands
      $('#copyBalanceCmd')?.addEventListener('click', async () => {
        const ok = await copyText('!–ë–∞–ª–∞–Ω—Å');
        if (ok) {
          const toastEl = document.createElement('div');
          toastEl.className = 'toast glass border border-white/60 rounded-2xl px-4 py-3 shadow-[0_18px_55px_rgba(18,28,55,.14)] bg-emerald-50/60 text-emerald-800 max-w-[92vw]';
          toastEl.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ';
          $('#toastHost').appendChild(toastEl);
          setTimeout(() => {
            toastEl.style.opacity = '0';
            toastEl.style.transform = 'translateY(10px)';
            toastEl.style.transition = 'opacity .2s ease, transform .2s ease';
            setTimeout(() => toastEl.remove(), 220);
          }, 1300);
        }
      });

      $('#btnCopyBalance')?.addEventListener('click', async () => {
        const ok = await copyText('!–ë–∞–ª–∞–Ω—Å');
        if (ok) {
          const toastEl = document.createElement('div');
          toastEl.className = 'toast glass border border-white/60 rounded-2xl px-4 py-3 shadow-[0_18px_55px_rgba(18,28,55,.14)] bg-emerald-50/60 text-emerald-800 max-w-[92vw]';
          toastEl.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ';
          $('#toastHost').appendChild(toastEl);
          setTimeout(() => {
            toastEl.style.opacity = '0';
            toastEl.style.transform = 'translateY(10px)';
            toastEl.style.transition = 'opacity .2s ease, transform .2s ease';
            setTimeout(() => toastEl.remove(), 220);
          }, 1300);
        }
      });

      // Product selection
      $$('.productCard').forEach(btn => {
        btn.addEventListener('click', () => {
          const title = btn.dataset.title || '–¢–æ–≤–∞—Ä';
          const cost = btn.dataset.cost || '0';
          setSelectedProduct({ title, cost });
        });
      });

      // Auth buttons
      $('#btnLogin')?.addEventListener('click', twitchLogin);
      $('#btnLogout')?.addEventListener('click', twitchLogout);
      $('#btnRefreshBalance')?.addEventListener('click', refreshBalanceForAuthed);

      // Order form
      $('#btnOrderAgain')?.addEventListener('click', () => {
        $('#comment').value = '';
        resetOrderUI();
        const toastEl = document.createElement('div');
        toastEl.className = 'toast glass border border-white/60 rounded-2xl px-4 py-3 shadow-[0_18px_55px_rgba(18,28,55,.14)] bg-emerald-50/60 text-emerald-800 max-w-[92vw]';
        toastEl.textContent = '–ú–æ–∂–Ω–æ –æ—Ñ–æ—Ä–º–∏—Ç—å –µ—â—ë –æ–¥–∏–Ω –∑–∞–∫–∞–∑';
        $('#toastHost').appendChild(toastEl);
        setTimeout(() => {
          toastEl.style.opacity = '0';
          toastEl.style.transform = 'translateY(10px)';
          toastEl.style.transition = 'opacity .2s ease, transform .2s ease';
          setTimeout(() => toastEl.remove(), 220);
        }, 1300);
      });

      $('#orderForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        hideInline();

        const nick = getKnownNick();
        const displayName = getKnownDisplayName();

        if (!nick) {
          showInline('err', '–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏ —á–µ—Ä–µ–∑ Twitch, —á—Ç–æ–±—ã –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑.');
          return;
        }

        if (!picked) {
          showInline('err', '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Ç–æ–≤–∞—Ä –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–¢–æ–≤–∞—Ä—ã¬ª.');
          return;
        }

        const spend = pickedCost;

        try {
          setOrderEnabled(false);
          setProgress(true, '‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–∫–∞–∑...', '–ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram');

          // –°–ù–ê–ß–ê–õ–ê –ø—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–ø–∏—Å–∞–Ω–∏–µ)
          if (SPEND_ENABLED && Number.isFinite(spend) && spend > 0) {
            setProgress(true, 'üí∞ –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å...', '–£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ —Ö–≤–∞—Ç–∞–µ—Ç –±–∞–ª–ª–æ–≤');
            const res = await findBalanceByNick(nick);
            if (!res.found) {
              setProgress(false);
              showInline('err', '–£ –≤–∞—Å 0 –±–∞–ª–ª–æ–≤ üò¢. –ü–æ—Ö–æ–∂–µ, —Ç–µ–±—è –Ω–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ. –ù–∞–ø–∏—à–∏ –Ø–º–∏, —á—Ç–æ–±—ã —Ç–µ–±—è –¥–æ–±–∞–≤–∏–ª–∏.');
              setOrderEnabled(true);
              return;
            }
            const currentBalance = Number.isFinite(res.pointsNum) ? Math.round(res.pointsNum) : 0;
            if (currentBalance < spend) {
              setProgress(false);
              showInline('err', `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤ üò¢. –î–ª—è —ç—Ç–æ–≥–æ –∑–∞–∫–∞–∑–∞ –Ω—É–∂–Ω–æ ${spend} üôÇ, –∞ —É —Ç–µ–±—è ${currentBalance} üôÇ.`);
              setOrderEnabled(true);
              return;
            }
          }

          // –ï—Å–ª–∏ –±–∞–ª–∞–Ω—Å–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
          setProgress(true, 'üì® –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram...', '–í–∞—à –∑–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ø–º–∏');
          const comment = ($('#comment').value || '').trim();
          const priceText = Number.isFinite(spend) && spend > 0 ? `${spend} üôÇ` : '‚Äî';

          const result = await sendOrderToBot({
            nick: displayName || nick,
            item: picked,
            price: priceText,
            comment: comment || '–ù–µ—Ç'
          });

          if (!result.ok) {
            setProgress(false);
            showInline('err', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –Ω–∞–ø–∏—à–∏ –Ø–º–∏ –Ω–∞–ø—Ä—è–º—É—é –≤ Telegram: @YammyTanuki');
            setOrderEnabled(true);
            return;
          }

          // –ï—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —É—Å–ø–µ—à–Ω–∞ - —Å–ø–∏—Å—ã–≤–∞–µ–º –±–∞–ª–ª—ã
          if (SPEND_ENABLED && Number.isFinite(spend) && spend > 0) {
            setProgress(true, 'üí∞ –°–ø–∏—Å—ã–≤–∞–µ–º –±–∞–ª–ª—ã...', '–û–±–Ω–æ–≤–ª—è–µ–º –≤–∞—à –±–∞–ª–∞–Ω—Å');
            const spendRes = await spendPoints({ nick, amount: spend, item: picked, comment });
            if (spendRes.ok) {
              await refreshBalanceForAuthed();
            } else {
              // –ï—Å–ª–∏ —Å–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–≤–∞–ª–∏–ª–æ—Å—å (–Ω–æ –æ—Ç–ø—Ä–∞–≤–∫–∞ —É—Å–ø–µ—à–Ω–∞) - –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –Ø–º–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç –≤—Ä—É—á–Ω—É—é
              console.warn('Failed to spend points:', spendRes);
            }
          }

          // –£—Å–ø–µ—Ö!
          setProgress(false);
          $('#btnOrder').classList.add('hidden');
          $('#btnOrderAgain').classList.remove('hidden');
          showInline('ok', '–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –Ø–º–∏ –ø–æ–ª—É—á–∏–ª —Ç–≤–æ–π –∑–∞–∫–∞–∑ üòä');
          $('#comment').value = '';
          picked = '';
          pickedCost = null;
          $('#selectedProductLabel').textContent = '–Ω–µ –≤—ã–±—Ä–∞–Ω';
          $('#orderProduct').textContent = '–ù–µ –≤—ã–±—Ä–∞–Ω';
          $('#orderCost').textContent = '‚Äî';

        } catch (e) {
          setProgress(false);
          setOrderEnabled(true);
          const message = (e && e.message) ? e.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
          showInline('err', `‚úñ –û—à–∏–±–∫–∞: ${message}\n–ü–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞.`);
        }
      });

      // Scroll to top
      $('#toTop')?.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
    }

    // ----- Reveal animations -----
    function initReveal() {
      try {
        const force = document.documentElement.classList.contains('no-io');
        const isSmallOrTablet = window.matchMedia('(max-width: 1024px)').matches;
        if (!force && !isSmallOrTablet && 'IntersectionObserver' in window) {
          const io = new IntersectionObserver((entries) => {
            for (const e of entries) {
              if (e.isIntersecting) {
                e.target.classList.add('is-in');
                io.unobserve(e.target);
              }
            }
          }, { threshold: 0.12 });
          $$('.reveal').forEach(el => io.observe(el));
        } else {
          $$('.reveal').forEach(el => el.classList.add('is-in'));
        }
      } catch (err) {
        // Fallback
        $$('.reveal').forEach(el => el.classList.add('is-in'));
      }
    }

    // ----- Decorative effects (desktop only) -----
    function initDecorativeEffects() {
      const isMobile = window.matchMedia('(max-width: 640px)').matches;
      const reduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      const inApp = document.documentElement.classList.contains('no-io');

      if (!isMobile && !reduced && !inApp) {
        // Petals effect
        const petalsHost = $('#petals');
        if (petalsHost) {
          let running = true;
          const maxOnScreen = 18;

          function rand(min, max) {
            return Math.random() * (max - min) + min;
          }

          function createPetal() {
            const el = document.createElement("div");
            const size = rand(10, 18);
            const startX = rand(0, window.innerWidth);
            const drift = rand(-60, 60);
            const dur = rand(7, 12);
            const rot = rand(0, 360);
            const hue = rand(330, 360);
            const opacity = rand(0.25, 0.55);

            el.style.position = "absolute";
            el.style.left = `${startX}px`;
            el.style.top = `-30px`;
            el.style.width = `${size}px`;
            el.style.height = `${size * 0.75}px`;
            el.style.borderRadius = "999px 999px 999px 0";
            el.style.transform = `rotate(${rot}deg)`;
            el.style.opacity = opacity.toFixed(2);
            el.style.background = `hsl(${hue} 85% 70% / .9)`;
            el.style.boxShadow = "0 10px 25px rgba(0,0,0,.08)";
            el.style.filter = "blur(.2px)";
            el.style.pointerEvents = "none";

            const keyframes = [
              { transform: `translate3d(0,0,0) rotate(${rot}deg)`, offset: 0 },
              { transform: `translate3d(${drift * 0.6}px, ${window.innerHeight * 0.45}px, 0) rotate(${rot + 160}deg)`, offset: 0.55 },
              { transform: `translate3d(${drift}px, ${window.innerHeight + 80}px, 0) rotate(${rot + 340}deg)`, offset: 1 }
            ];

            const anim = el.animate(keyframes, { duration: dur * 1000, easing: "linear", iterations: 1 });
            anim.onfinish = () => el.remove();
            return el;
          }

          function tick() {
            if (!running) return;
            const count = petalsHost.childElementCount;
            if (count < maxOnScreen) {
              const add = Math.min(2, maxOnScreen - count);
              for (let i = 0; i < add; i++) petalsHost.appendChild(createPetal());
            }
            setTimeout(tick, rand(450, 900));
          }

          tick();
          document.addEventListener("visibilitychange", () => {
            running = !document.hidden;
            if (running) tick();
          });
        }

        // Floaties animation
        const floaties = $$(".floaty");
        if (floaties.length > 0) {
          let t = 0;
          function loop() {
            t += 0.006;
            floaties.forEach((el, i) => {
              const amp = 10 + i * 4;
              const x = Math.sin(t + i) * amp;
              const y = Math.cos(t + i * 1.3) * amp;
              el.style.transform = `translate3d(${x}px, ${y}px, 0)`;
            });
            requestAnimationFrame(loop);
          }
          requestAnimationFrame(loop);
        }
      }
    }

    // ----- Initialize everything -----
    function init() {
      // Handle Telegram warning
      const ua = (navigator.userAgent || '').toLowerCase();
      const isTelegramInApp = /Telegram/i.test(ua);
      if (isTelegramInApp) {
        $('#tgWarning')?.classList.remove('hidden');
      }

      // Handle OAuth callback
      handleTwitchOAuthCallback();

      // Restore auth if exists
      const auth = getAuth();
      const remember = $('#rememberNick');
      if (auth?.login) {
        if (remember) {
          remember.checked = !!localStorage.getItem(AUTH_STORAGE_KEY);
        }
        // –°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏–º UI (—Å–∫—Ä–æ–µ–º –∫–Ω–æ–ø–∫—É "–í–æ–π—Ç–∏"), –ø–æ—Ç–æ–º –æ–±–Ω–æ–≤–∏–º –±–∞–ª–∞–Ω—Å
        setNickUIAuthed(auth.display_name || auth.login);
        setTimeout(() => refreshBalanceForAuthed(), 250);
      } else {
        setNickUIAuthed('');
        refreshBalanceForAuthed();
      }

      // Wire up event listeners
      initEventListeners();

      // Initialize reveal animations
      initReveal();

      // Initialize decorative effects
      initDecorativeEffects();

      // Create top anchor
      if (!$('#top')) {
        const a = document.createElement("div");
        a.id = "top";
        a.style.position = "absolute";
        a.style.top = "0";
        a.style.left = "0";
        a.style.width = "1px";
        a.style.height = "1px";
        a.style.pointerEvents = "none";
        document.body.prepend(a);
      }
    }

    // Start initialization
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init, { once: true });
    } else {
      init();
    }
  </script>
</body>
</html>
