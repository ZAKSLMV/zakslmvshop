<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="color-scheme" content="light" />
  <title>–ú–∞–≥–∞–∑–∏–Ω—á–∏–∫ –∑–∞ –±–∞–ª–ª—ã</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <style>
    :root{
      --glass-bg: rgba(255,255,255,.55);
      --glass-border: rgba(255,255,255,.6);
      --shadow: 0 10px 30px rgba(15, 23, 42, .12);
      --shadow-strong: 0 18px 60px rgba(15, 23, 42, .18);
      --ring: rgba(59,130,246,.25);
      --ink: #0b1b33;
    }

    html{ scroll-behavior: smooth; }

    body{
      color: var(--ink);
      background: radial-gradient(1200px 700px at 15% 15%, rgba(147,197,253,.55), rgba(255,255,255,0) 55%),
                  radial-gradient(1100px 700px at 85% 10%, rgba(224,231,255,.65), rgba(255,255,255,0) 55%),
                  radial-gradient(900px 600px at 80% 75%, rgba(186,230,253,.55), rgba(255,255,255,0) 60%),
                  linear-gradient(180deg, #eaf5ff 0%, #f6fbff 35%, #eef7ff 100%);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .bg-anim{
      position: fixed;
      inset: 0;
      z-index: -3;
      pointer-events: none;
      opacity: .65;
      filter: blur(30px) saturate(1.1);
      transform: translateZ(0);
      background: radial-gradient(800px 500px at 20% 30%, rgba(56,189,248,.35), rgba(255,255,255,0) 60%),
                  radial-gradient(700px 450px at 80% 30%, rgba(99,102,241,.25), rgba(255,255,255,0) 60%),
                  radial-gradient(700px 450px at 50% 80%, rgba(34,211,238,.22), rgba(255,255,255,0) 60%);
      animation: floatBg 14s ease-in-out infinite alternate;
    }

    @keyframes floatBg{
      0%{ transform: translate3d(-1%, -1%, 0) scale(1.02); }
      100%{ transform: translate3d(1%, 1.2%, 0) scale(1.06); }
    }

    .glass{
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }

    .glass-strong{
      background: rgba(255,255,255,.65);
      border: 1px solid rgba(255,255,255,.7);
      box-shadow: var(--shadow-strong);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }

    .glow{
      position: relative;
      isolation: isolate;
    }

    .glow:before{
      content: "";
      position: absolute;
      inset: -14px;
      z-index: -1;
      background: radial-gradient(500px 120px at 25% 0%, rgba(59,130,246,.28), rgba(255,255,255,0) 70%),
                  radial-gradient(420px 120px at 80% 30%, rgba(56,189,248,.25), rgba(255,255,255,0) 70%),
                  radial-gradient(420px 140px at 50% 100%, rgba(129,140,248,.18), rgba(255,255,255,0) 70%);
      filter: blur(18px);
      opacity: .9;
    }

    .float-card{ animation: floatCard 7s ease-in-out infinite; }
    .float-card:nth-child(2n){ animation-duration: 8.3s; }
    .float-card:nth-child(3n){ animation-duration: 9.2s; }
    @keyframes floatCard{
      0%{ transform: translateY(0px); }
      50%{ transform: translateY(-10px); }
      100%{ transform: translateY(0px); }
    }

    #stars{
      position: fixed;
      inset: 0;
      z-index: -2;
      pointer-events: none;
      overflow: hidden;
    }

    .star{
      position: absolute;
      width: 2px;
      height: 2px;
      background: rgba(255,255,255,.9);
      border-radius: 999px;
      box-shadow: 0 0 12px rgba(56,189,248,.6);
      opacity: .0;
      animation: fallStar linear infinite;
    }

    @keyframes fallStar{
      0%{ transform: translate3d(0, -10vh, 0); opacity: 0; }
      10%{ opacity: .95; }
      90%{ opacity: .9; }
      100%{ transform: translate3d(0, 120vh, 0); opacity: 0; }
    }

    #clouds{
      position: fixed;
      inset: 0;
      z-index: -2;
      pointer-events: none;
      overflow: hidden;
      opacity: .55;
      filter: blur(0px) saturate(1.05);
    }

    .cloud{
      position: absolute;
      width: 260px;
      height: 120px;
      background: radial-gradient(circle at 30% 50%, rgba(255,255,255,.95) 0 40%, rgba(255,255,255,0) 60%),
                  radial-gradient(circle at 60% 40%, rgba(255,255,255,.88) 0 45%, rgba(255,255,255,0) 65%),
                  radial-gradient(circle at 55% 70%, rgba(255,255,255,.82) 0 40%, rgba(255,255,255,0) 62%),
                  radial-gradient(circle at 75% 55%, rgba(255,255,255,.8) 0 35%, rgba(255,255,255,0) 60%);
      border-radius: 999px;
      animation: drift linear infinite;
    }

    @keyframes drift{
      0%{ transform: translate3d(-30vw, 0, 0); }
      100%{ transform: translate3d(130vw, 0, 0); }
    }

    .focus-ring:focus{ outline: none; box-shadow: 0 0 0 5px var(--ring); }

    .modal-backdrop{ animation: fadeIn .18s ease-out; }
    .modal-panel{ animation: pop .2s ease-out; }
    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }
    @keyframes pop{ from{ transform: translateY(6px) scale(.98); opacity: .0;} to{ transform: translateY(0) scale(1); opacity: 1;} }

    @media (prefers-reduced-motion: reduce){
      html{ scroll-behavior: auto; }
      .float-card, .bg-anim, .cloud, .star{ animation: none !important; }
    }
  </style>
</head>
<body>
  <div class="bg-anim" aria-hidden="true"></div>
  <div id="stars" aria-hidden="true"></div>
  <div id="clouds" aria-hidden="true"></div>


  <main id="top" class="max-w-6xl mx-auto px-4 sm:px-6 pb-20">
    <!-- Hero -->
    <section class="pt-8 sm:pt-10">
      <div class="grid lg:grid-cols-12 gap-6 items-stretch">
        <div class="lg:col-span-7 glass-strong glow rounded-3xl p-6 sm:p-8">
          <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full glass text-sm text-slate-700">
            <span>‚ú®</span>
            <span>–õ—ë–≥–∫–∏–π —Å—Ç–µ–∫–ª—è–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω ‚Ä¢ –ë—ã—Å—Ç—Ä–æ ‚Ä¢ –ë–µ–∑ –ª–∏—à–Ω–∏—Ö –∫–ª–∏–∫–æ–≤</span>
          </div>
          <h1 class="mt-4 text-3xl sm:text-4xl font-extrabold tracking-tight">
            ü™ô –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∞–≥–∞–∑–∏–Ω—á–∏–∫
          </h1>
          <p class="mt-3 text-slate-700 leading-relaxed">
            –ó–¥–µ—Å—å —Ç—ã –º–æ–∂–µ—à—å –∑–∞–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –∑–∞ –±–∞–ª–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞—Ä–∞–±–æ—Ç–∞–ª(–∞) –Ω–∞ –∫–ª–∏–ø–∞—Ö.
            –í—ã–±–∏—Ä–∞–π –Ω–∞–≥—Ä–∞–¥—É, –ø—Ä–æ–≤–µ—Ä—è–π –±–∞–ª–∞–Ω—Å –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–π –∑–∞–∫–∞–∑ ‚Äî –ø—Ä—è–º–æ —Å —Å–∞–π—Ç–∞.
          </p>

          <div class="mt-6 flex flex-col sm:flex-row gap-3">
            <a href="#rules" class="glass rounded-2xl px-4 py-3 hover:bg-white/60 transition shadow focus-ring">
              <div class="font-bold">–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø—Ä–∞–≤–∏–ª–∞–º</div>
              <div class="text-sm text-slate-600">–ö–∞–∫ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –±–∞–ª–ª—ã + –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</div>
            </a>
            <a href="#shop" class="glass rounded-2xl px-4 py-3 hover:bg-white/60 transition shadow focus-ring">
              <div class="font-bold">–û—Ç–∫—Ä—ã—Ç—å –≤–∏—Ç—Ä–∏–Ω—É</div>
              <div class="text-sm text-slate-600">–ù–∞–≥—Ä–∞–¥—ã, –º–µ–º—ã, –∫–∏–Ω–æ, –∏–≥—Ä—ã –∏ –Ω–µ —Ç–æ–ª—å–∫–æ</div>
            </a>
            <a href="#order" class="glass rounded-2xl px-4 py-3 hover:bg-white/60 transition shadow focus-ring">
              <div class="font-bold">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</div>
              <div class="text-sm text-slate-600">–í—ã–±–µ—Ä–∏ —Ç–æ–≤–∞—Ä –∏ –æ—Ç–ø—Ä–∞–≤—å –∑–∞—è–≤–∫—É</div>
            </a>
          </div>

          <div class="mt-6 glass rounded-2xl p-4">
            <div class="flex items-start gap-3">
              <div class="w-10 h-10 rounded-2xl bg-sky-600/10 flex items-center justify-center">üí°</div>
              <div>
                <div class="font-bold">–ü–æ–¥—Å–∫–∞–∑–∫–∞</div>
                <div class="text-sm text-slate-700 leading-relaxed">
                  –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤–æ–∏ –±–∞–ª–ª—ã –º–æ–∂–Ω–æ –Ω–∞ Twitch –∫–æ–º–∞–Ω–¥–æ–π –≤ —á–∞—Ç–µ: <span class="font-mono bg-white/60 px-1.5 py-0.5 rounded">!–ë–∞–ª–∞–Ω—Å</span>
                  (–∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å –∑–¥–µ—Å—å ‚Äî –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏).
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="lg:col-span-5 grid gap-6">
          <div class="glass-strong rounded-3xl p-6 sm:p-7 glow">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-sm text-slate-600">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –±–∞–ª–∞–Ω—Å</div>
                <div class="mt-2 flex flex-wrap items-center gap-2">
                  <div id="authChip" class="glass rounded-2xl px-3 py-2 text-sm flex items-center gap-2">
                    <span class="inline-flex items-center gap-2">
                      <span class="w-2.5 h-2.5 rounded-full bg-slate-300" id="authDot"></span>
                      <span id="authLabel" class="text-slate-700">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω(–∞)</span>
                    </span>
                  </div>
                  <div class="flex gap-2">
                    <button id="btnLogin" class="px-3 py-2 rounded-2xl bg-sky-600 text-white hover:bg-sky-700 transition shadow focus-ring">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Twitch</button>
                    <button id="btnLogout" class="hidden px-3 py-2 rounded-2xl glass hover:bg-white/50 transition focus-ring">–í—ã–π—Ç–∏</button>
                  </div>
                </div>

                <div class="mt-4 text-sm text-slate-600">–¢–≤–æ–π –±–∞–ª–∞–Ω—Å</div>
                <div class="mt-1 text-3xl font-extrabold tracking-tight"><span id="balanceValue">‚Äî</span> <span class="text-xl">ü™ô</span></div>
                <div id="balanceHint" class="mt-2 text-sm text-slate-600">–ê–≤—Ç–æ—Ä–∏–∑—É–π—Å—è —á–µ—Ä–µ–∑ Twitch, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏ ¬´–û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å¬ª.</div>
              </div>
              <div class="w-12 h-12 rounded-2xl bg-sky-600/10 flex items-center justify-center">üîê</div>
            </div>

            <div class="mt-4 flex gap-2">
              <button id="btnRefreshBalance" class="px-4 py-2.5 rounded-2xl bg-white/70 hover:bg-white transition shadow focus-ring flex-1">–û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
              <button id="btnOpenSettings" class="px-4 py-2.5 rounded-2xl glass hover:bg-white/50 transition focus-ring">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            </div>
            <div id="balanceStatus" class="mt-3 text-sm"></div>
          </div>

          <div class="glass-strong rounded-3xl p-6 sm:p-7">
            <div class="flex items-start gap-3">
              <div class="w-12 h-12 rounded-2xl bg-indigo-600/10 flex items-center justify-center">‚ö°</div>
              <div>
                <div class="font-extrabold text-xl">–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç</div>
                <ul class="mt-2 text-sm text-slate-700 leading-relaxed list-disc pl-5">
                  <li>–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Twitch ‚Äî —á—Ç–æ–±—ã –ø–æ–¥—Ç—è–Ω—É—Ç—å –Ω–∏–∫ –∏ –±–∞–ª–∞–Ω—Å</li>
                  <li>–ü–æ—Å—á–∏—Ç–∞—Ç—å –±–∞–ª–ª—ã –∑–∞ –∫–ª–∏–ø—ã –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ</li>
                  <li>–í—ã–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É ‚Üí –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ ‚Üí –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram</li>
                </ul>
              </div>
            </div>
          </div>

          <div class="glass rounded-3xl p-6 sm:p-7">
            <div class="font-bold">–°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</div>
            <div class="mt-2 text-sm text-slate-700 leading-relaxed">
              –í —ç—Ç–æ–º –¥–µ–º–æ —Ç–æ–∫–µ–Ω—ã/URL –Ω–µ –ø—Ä–æ–ø–∏—Å–∞–Ω—ã.
              –ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ —Ç—ã –ø—Ä–∏—à–ª—ë—à—å –º–Ω–µ: <span class="font-semibold">Apps Script URL</span>, <span class="font-semibold">Twitch Client ID</span>, <span class="font-semibold">Redirect URI</span> –∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) <span class="font-semibold">Telegram –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</span> ‚Äî –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è/–±–∞–ª–∞–Ω—Å/–∑–∞–∫–∞–∑ –∑–∞—Ä–∞–±–æ—Ç–∞—é—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é.
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="rules" class="pt-10 sm:pt-14">
      <div class="grid gap-6 items-start">
        <div class="glass-strong glow rounded-3xl p-6 sm:p-8">
          <h2 class="text-2xl sm:text-3xl font-extrabold tracking-tight">üìå –ü—Ä–∞–≤–∏–ª–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤</h2>
          <div class="mt-4 space-y-3 text-slate-700 leading-relaxed">
            <p>‚úÖ –ó–∞ –∫–∞–∂–¥—ã–π –∫–ª–∏–ø ‚Üí <span class="font-bold">+50</span> –±–∞–ª–ª–æ–≤.</p>
            <p>‚úÖ –ï—Å–ª–∏ –∫–ª–∏–ø–æ–≤ –±–æ–ª—å—à–µ –æ–¥–Ω–æ–≥–æ ‚Üí –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–µ–º–∏—è <span class="font-bold">+3%</span> –ø–æ —Ñ–æ—Ä–º—É–ª–µ.</p>
            <div class="glass rounded-2xl p-4">
              <div class="font-bold">–§–æ—Ä–º—É–ª–∞</div>
              <div class="mt-1 font-mono text-sm bg-white/60 inline-block px-2 py-1 rounded-xl">S = 50√óN + 0.03√ó(50√óN)√ó(N-1)</div>
              <div class="mt-2 text-sm text-slate-600">S ‚Äî –∏—Ç–æ–≥, N ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–ø–æ–≤</div>
            </div>

            <div class="glass rounded-2xl p-4">
              <div class="font-bold">–ü—Ä–∏–º–µ—Ä—ã</div>
              <ul class="mt-2 text-sm list-disc pl-5">
                <li>1 –∫–ª–∏–ø = 50 ü™ô</li>
                <li>2 –∫–ª–∏–ø–∞ = 103 ü™ô</li>
                <li>3 –∫–ª–∏–ø–∞ = 157.5 ü™ô</li>
                <li>4 –∫–ª–∏–ø–∞ = 214.5 ü™ô</li>
              </ul>
            </div>

            <p>‚ö†Ô∏è –í–∞–∂–Ω–æ: –µ—Å–ª–∏ –∫–ª–∏–ø ¬´–Ω–µ –æ —á—ë–º¬ª ‚Äî –±–∞–ª–ª—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è!</p>
            <p>üíô –°–æ–≤–µ—Ç: —á–µ–º –±–æ–ª—å—à–µ –∫–ª–∏–ø–æ–≤ –≤ —Å—Ç—Ä–∏–º–µ ‚Äî —Ç–µ–º –≤—ã–≥–æ–¥–Ω–µ–µ.</p>
          </div>

          <div class="mt-6 flex flex-col sm:flex-row gap-3">
            <button id="btnOpenCalcRules" class="px-4 py-3 rounded-2xl bg-sky-600 text-white hover:bg-sky-700 transition shadow focus-ring">–û—Ç–∫—Ä—ã—Ç—å –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –±–∞–ª–ª–æ–≤</button>
            <a href="#shop" class="px-4 py-3 rounded-2xl glass hover:bg-white/60 transition shadow focus-ring">–ü–µ—Ä–µ–π—Ç–∏ –∫ —Ç–æ–≤–∞—Ä–∞–º</a>
          </div>
        </div>
      </div>
    </section>

    <section id="shop" class="pt-10 sm:pt-14">
      <div class="glass-strong glow rounded-3xl p-6 sm:p-8">
        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
          <div>
            <h2 class="text-2xl sm:text-3xl font-extrabold tracking-tight">üõçÔ∏è –í–∏—Ç—Ä–∏–Ω–∞</h2>
            <p class="mt-2 text-slate-700 leading-relaxed">
              –í—ã–±–∏—Ä–∞–π –∫–∞—Ç–µ–≥–æ—Ä–∏—é, –∑–∞—Ç–µ–º –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî –≤—ã–±—Ä–∞–Ω–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—Å—è –≤ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞.
            </p>
          </div>
          <div class="glass rounded-2xl p-3 flex flex-col sm:flex-row gap-2 sm:items-center">
            <div class="text-sm text-slate-600">–í—ã–±—Ä–∞–Ω–æ:</div>
            <div id="selectedBadge" class="text-sm font-semibold">–ù–∏—á–µ–≥–æ</div>
          </div>
        </div>

        <div class="mt-6 grid gap-4">
          <div id="productsGrid" class="mt-6 grid gap-3 sm:grid-cols-2 lg:grid-cols-3"></div>
        </div>
      </div>
    </section>

    <section id="order" class="pt-10 sm:pt-14">
      <div class="grid lg:grid-cols-12 gap-6 items-start">
        <div class="lg:col-span-7 glass-strong glow rounded-3xl p-6 sm:p-8">
          <h2 class="text-2xl sm:text-3xl font-extrabold tracking-tight">üì¶ –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
          <p class="mt-2 text-slate-700 leading-relaxed">
            –í—ã–±–µ—Ä–∏ –Ω–∞–≥—Ä–∞–¥—É –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–¢–æ–≤–∞—Ä—ã¬ª. –î–æ–±–∞–≤—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –∏ –Ω–∞–∂–º–∏ ¬´–ó–∞–∫–∞–∑–∞—Ç—å¬ª.
            –ó–∞—è–≤–∫–∞ —É–π–¥—ë—Ç –≤ Telegram.
          </p>

          <div class="mt-6 grid gap-4">
            <div class="glass rounded-2xl p-4">
              <div class="text-sm text-slate-600">–í—ã–±—Ä–∞–Ω–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞</div>
              <div class="mt-1 flex items-center justify-between gap-3">
                <div>
                  <div id="orderItemName" class="font-extrabold">‚Äî</div>
                  <div id="orderItemMeta" class="text-sm text-slate-600">–í—ã–±–µ—Ä–∏ —Ç–æ–≤–∞—Ä –≤ –≤–∏—Ç—Ä–∏–Ω–µ</div>
                </div>
                <div class="text-right">
                  <div class="text-sm text-slate-600">–°—Ç–æ–∏–º–æ—Å—Ç—å</div>
                  <div class="font-extrabold"><span id="orderItemPrice">‚Äî</span> ü™ô</div>
                </div>
              </div>
            </div>

            <div class="glass rounded-2xl p-4">
              <label class="text-sm text-slate-600" for="comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
              <textarea id="comment" rows="4" class="mt-2 w-full rounded-2xl bg-white/70 border border-white/60 p-3 focus-ring" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: ‚Äò—Ö–æ—á—É –º–µ–º—ã –ø—Ä–æ –∫–æ—Ç–∏–∫–æ–≤‚Äô, ‚Äò–≤—ã–±–µ—Ä–∏ –∞–Ω–∏–º–µ –∏–∑ –º–æ–∏—Ö –ª—é–±–∏–º—ã—Ö‚Äô, ‚Äò–∏–≥—Ä–∞: ...‚Äô"></textarea>
            </div>

            <div class="flex flex-col sm:flex-row gap-3">
              <button id="btnPlaceOrder" class="flex-1 px-4 py-3 rounded-2xl bg-sky-600 text-white hover:bg-sky-700 transition shadow focus-ring">
                –ó–∞–∫–∞–∑–∞—Ç—å
              </button>
              <button id="btnClearSelection" class="px-4 py-3 rounded-2xl glass hover:bg-white/60 transition shadow focus-ring">
                –°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä
              </button>
            </div>

            <div id="orderStatus" class="glass rounded-2xl p-4 hidden"></div>

            <div id="orderActions" class="hidden flex flex-col sm:flex-row gap-3">
              <button id="btnRetry" class="px-4 py-3 rounded-2xl bg-white/80 hover:bg-white transition shadow focus-ring">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
              <button id="btnNewOrder" class="px-4 py-3 rounded-2xl glass hover:bg-white/60 transition shadow focus-ring">–û—Ñ–æ—Ä–º–∏—Ç—å –µ—â—ë</button>
            </div>
          </div>
        </div>

        <aside class="lg:col-span-5 glass-strong rounded-3xl p-6 sm:p-7 sticky top-24">
          <div class="flex items-start gap-3">
            <div class="w-12 h-12 rounded-2xl bg-indigo-600/10 flex items-center justify-center">üîê</div>
            <div class="w-full">
              <div class="font-extrabold text-xl">–ü—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π</div>
              <ul class="mt-2 text-sm text-slate-700 leading-relaxed list-disc pl-5">
                <li>–ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é Twitch</li>
                <li>–ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—ã–±—Ä–∞–Ω —Ç–æ–≤–∞—Ä</li>
                <li>–ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –±–∞–ª–∞–Ω—Å –∏–∑ Google Sheets (Apps Script)</li>
                <li>–ï—Å–ª–∏ –±–∞–ª–ª–æ–≤ —Ö–≤–∞—Ç–∞–µ—Ç ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞—è–≤–∫—É –≤ Telegram</li>
                <li>–ü–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞ –º–æ–∂–Ω–æ —Å–ø–∏—Å–∞—Ç—å –±–∞–ª–ª—ã (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ –Ω–∞ API)</li>
              </ul>

              <div class="mt-4 glass rounded-2xl p-4">
                <div class="font-bold">–í–∞–∂–Ω–æ</div>
                <div class="mt-1 text-sm text-slate-700 leading-relaxed">
                  –ï—Å–ª–∏ –±–∞–ª–ª–æ–≤ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚Äî –∑–∞–∫–∞–∑ <span class="font-semibold">–Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è</span>.
                  –û—à–∏–±–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –ø–æ–Ω—è—Ç–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º.
                </div>
              </div>

              <div class="mt-4 text-xs text-slate-600">
                –°–æ–≤–µ—Ç: –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ª—É—á—à–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å Telegram –∏ —Å–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ —á–µ—Ä–µ–∑ Apps Script (—á—Ç–æ–±—ã –Ω–µ —Å–≤–µ—Ç–∏—Ç—å —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ).
              </div>
            </div>
          </div>
        </aside>
      </div>
    </section>

    <footer class="pt-12">
      <div class="glass rounded-3xl p-6 sm:p-8 text-sm text-slate-700">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <div class="font-bold">–ú–∞–≥–∞–∑–∏–Ω—á–∏–∫ –∑–∞ –±–∞–ª–ª—ã</div>
            <div class="text-slate-600">–°–¥–µ–ª–∞–Ω–æ –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ ‚Ä¢ Tailwind CDN ‚Ä¢ Vanilla JS</div>
          </div>
          <div class="flex flex-wrap gap-2">
            <a class="px-3 py-2 rounded-xl glass hover:bg-white/60 transition" href="#top">–ù–∞–≤–µ—Ä—Ö</a>
            <button id="btnOpenCalcFooter" class="px-3 py-2 rounded-xl glass hover:bg-white/60 transition">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</button>
          </div>
        </div>
      </div>
    </footer>
  </main>

  <div id="calcModal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0 bg-slate-900/25" data-close="1"></div>
    <div class="relative h-full w-full flex items-end sm:items-center justify-center p-4">
      <div class="modal-panel w-full sm:max-w-lg glass-strong rounded-3xl p-5 sm:p-6 shadow-2xl">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-xs uppercase tracking-wider text-slate-600">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –±–∞–ª–ª–æ–≤</div>
            <div class="text-xl font-extrabold">üßÆ –ü–æ—Å—á–∏—Ç–∞–π –∏—Ç–æ–≥ –∑–∞ –∫–ª–∏–ø—ã</div>
          </div>
          <button class="px-3 py-2 rounded-xl glass hover:bg-white/60 transition focus-ring" data-close="1">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>

        <div class="mt-4 grid gap-4">
          <div class="glass rounded-2xl p-4">
            <label for="clips" class="text-sm text-slate-600">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–ø–æ–≤</label>
            <div class="mt-2 flex gap-2 items-center">
              <input id="clips" type="number" min="1" max="100" value="1" class="w-28 rounded-2xl bg-white/70 border border-white/60 p-2.5 focus-ring" />
              <input id="clipsRange" type="range" min="1" max="30" value="1" class="w-full" />
            </div>
            <div class="mt-2 text-xs text-slate-600">–§–æ—Ä–º—É–ª–∞: <span class="font-mono">S = 50√óN + 0.03√ó(50√óN)√ó(N-1)</span></div>
          </div>

          <div class="glass rounded-2xl p-4">
            <div class="text-sm text-slate-600">–ò—Ç–æ–≥</div>
            <div class="mt-1 text-3xl font-extrabold"><span id="calcResult">50</span> <span class="text-xl">ü™ô</span></div>
            <div class="mt-2 text-sm text-slate-700" id="calcExplain"></div>
          </div>

          <div class="flex gap-2">
            <button id="btnFillAsComment" class="flex-1 px-4 py-3 rounded-2xl bg-white/80 hover:bg-white transition shadow focus-ring">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
            <button id="btnCopyCalc" class="px-4 py-3 rounded-2xl glass hover:bg-white/60 transition focus-ring">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="settingsModal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0 bg-slate-900/25" data-close-settings="1"></div>
    <div class="relative h-full w-full flex items-end sm:items-center justify-center p-4">
      <div class="modal-panel w-full sm:max-w-2xl glass-strong rounded-3xl p-5 sm:p-6 shadow-2xl">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-xs uppercase tracking-wider text-slate-600">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            <div class="text-xl font-extrabold">‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API</div>
            <div class="mt-1 text-sm text-slate-700">–ú–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤ localStorage (—É–¥–æ–±–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∞). –í –ø—Ä–æ–¥–µ –ª—É—á—à–µ –∑–∞—à–∏—Ç—å –≤ –∫–æ–¥ –∏–ª–∏ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä/Apps Script.</div>
          </div>
          <button class="px-3 py-2 rounded-xl glass hover:bg-white/60 transition focus-ring" data-close-settings="1">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>

        <div class="mt-4 grid gap-4">
          <div class="grid sm:grid-cols-2 gap-3">
            <div class="glass rounded-2xl p-4">
              <label class="text-sm text-slate-600">TWITCH_CLIENT_ID</label>
              <input id="cfgTwitchClientId" class="mt-2 w-full rounded-2xl bg-white/70 border border-white/60 p-2.5 focus-ring" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: abcd1234..." />
            </div>
            <div class="glass rounded-2xl p-4">
              <label class="text-sm text-slate-600">TWITCH_REDIRECT_URI</label>
              <input id="cfgTwitchRedirect" class="mt-2 w-full rounded-2xl bg-white/70 border border-white/60 p-2.5 focus-ring" placeholder="https://.../index.html" />
            </div>
          </div>

          <div class="grid sm:grid-cols-2 gap-3">
            <div class="glass rounded-2xl p-4">
              <label class="text-sm text-slate-600">BALANCE_API_URL (Apps Script)</label>
              <input id="cfgBalanceApi" class="mt-2 w-full rounded-2xl bg-white/70 border border-white/60 p-2.5 focus-ring" placeholder="https://script.google.com/macros/s/.../exec" />
              <div class="mt-2 text-xs text-slate-600">–û–∂–∏–¥–∞–µ—Ç—Å—è: GET ?nick=... ‚Üí {balance: number} (–∏–ª–∏ {ok:true,balance:number})</div>
            </div>
            <div class="glass rounded-2xl p-4">
              <label class="text-sm text-slate-600">ORDER_API_URL (Apps Script)</label>
              <input id="cfgOrderApi" class="mt-2 w-full rounded-2xl bg-white/70 border border-white/60 p-2.5 focus-ring" placeholder="(—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)" />
              <div class="mt-2 text-xs text-slate-600">–û–∂–∏–¥–∞–µ—Ç—Å—è: POST JSON ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram + —Å–ø–∏—Å–∞–Ω–∏–µ</div>
            </div>
          </div>

          <div class="glass rounded-2xl p-4">
            <div class="font-bold">(–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ü—Ä—è–º–æ–π Telegram (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)</div>
            <div class="mt-2 grid sm:grid-cols-2 gap-3">
              <div>
                <label class="text-sm text-slate-600">TELEGRAM_BOT_TOKEN</label>
                <input id="cfgTgToken" class="mt-2 w-full rounded-2xl bg-white/70 border border-white/60 p-2.5 focus-ring" placeholder="123:ABC..." />
              </div>
              <div>
                <label class="text-sm text-slate-600">TELEGRAM_CHAT_IDS (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                <input id="cfgTgChats" class="mt-2 w-full rounded-2xl bg-white/70 border border-white/60 p-2.5 focus-ring" placeholder="12345,67890" />
              </div>
            </div>
            <div class="mt-2 text-xs text-slate-600">–ï—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω ORDER_API_URL ‚Äî –æ–Ω –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø–µ—Ä–≤—ã–º.</div>
          </div>

          <div class="flex flex-col sm:flex-row gap-3">
            <button id="btnSaveCfg" class="px-4 py-3 rounded-2xl bg-sky-600 text-white hover:bg-sky-700 transition shadow focus-ring">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button id="btnResetCfg" class="px-4 py-3 rounded-2xl glass hover:bg-white/60 transition shadow focus-ring">–°–±—Ä–æ—Å–∏—Ç—å</button>
            <div id="cfgStatus" class="text-sm text-slate-700 sm:ml-auto self-center"></div>
          </div>

          <details class="glass rounded-2xl p-4">
            <summary class="cursor-pointer font-bold">–®–∞–±–ª–æ–Ω Apps Script (–ø–æ–¥—Å–∫–∞–∑–∫–∞)</summary>
            <div class="mt-3 text-sm text-slate-700 leading-relaxed">
              <div class="font-semibold">–í–∞–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏:</div>
              <div class="mt-2 font-mono text-xs bg-white/60 p-3 rounded-2xl overflow-auto">
                Access-Control-Allow-Origin: *
                Access-Control-Allow-Methods: GET, POST, OPTIONS
                Access-Control-Allow-Headers: Content-Type
              </div>
              <div class="mt-2">–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è API ‚Äî –ø—Ä–∏—à–ª–∏ –º–Ω–µ URL, –∏ —è –ø–æ–¥—Å—Ç—Ä–æ—é –∫–ª–∏–µ–Ω—Ç –ø–æ–¥ —Ç–æ—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–æ–≤.</div>
            </div>
          </details>
        </div>
      </div>
    </div>
  </div>

  <div id="memesModal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0 bg-slate-900/25" data-close-memes="1"></div>
    <div class="relative h-full w-full flex items-end sm:items-center justify-center p-4">
      <div class="modal-panel w-full sm:max-w-xl glass-strong rounded-3xl p-5 sm:p-6 shadow-2xl">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-xs uppercase tracking-wider text-slate-600">–¢–æ–≤–∞—Ä</div>
            <div class="text-xl font-extrabold">üòÇ –ú–µ–º—ã ‚Äî –≤—ã–±–µ—Ä–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
            <div class="mt-1 text-sm text-slate-700">–ß–µ–º –±–æ–ª—å—à–µ –±–µ—Ä—ë—à—å ‚Äî —Ç–µ–º –≤—ã–≥–æ–¥–Ω–µ–µ —Ü–µ–Ω–∞ –∑–∞ 1 –º–µ–º.</div>
          </div>
          <button class="px-3 py-2 rounded-xl glass hover:bg-white/60 transition focus-ring" data-close-memes="1">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>

        <div class="mt-4 grid gap-4">
          <div class="glass rounded-2xl p-4">
            <div class="flex items-center justify-between gap-3">
              <div>
                <div class="text-sm text-slate-600">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
                <div class="mt-0.5 text-2xl font-extrabold"><span id="memesQty">20</span> —à—Ç.</div>
              </div>
              <div class="text-right">
                <div class="text-sm text-slate-600">–ò—Ç–æ–≥–æ</div>
                <div class="mt-0.5 text-2xl font-extrabold"><span id="memesTotal">200</span> ü™ô</div>
                <div class="mt-1 text-xs text-slate-600">‚âà <span id="memesUnit">10</span> ü™ô / –º–µ–º</div>
              </div>
            </div>

            <div class="mt-4">
              <input id="memesRange" type="range" min="20" max="500" step="5" value="20" class="w-full" />
              <div class="mt-2 flex items-center justify-between text-xs text-slate-600">
                <span>–ú–∏–Ω: 20 (200 ü™ô)</span>
                <span>–ú–∞–∫—Å: 500 (—Å–∞–º–∞—è –≤—ã–≥–æ–¥–Ω–∞—è —Ü–µ–Ω–∞)</span>
              </div>
            </div>
          </div>

          <div class="glass rounded-2xl p-4">
            <div class="font-bold">–ß—Ç–æ –ø–æ–ø–∞–¥—ë—Ç –≤ –∑–∞–∫–∞–∑</div>
            <div class="mt-2 text-sm text-slate-700" id="memesPreview">–ú–µ–º—ã: 20 —à—Ç. ‚Äî 200 ü™ô</div>
            <div class="mt-1 text-xs text-slate-600">–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É—Ç–æ—á–Ω–µ–Ω–∏—è –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–∞ —à–∞–≥–µ –∑–∞–∫–∞–∑–∞.</div>
          </div>

          <div class="flex flex-col sm:flex-row gap-3">
            <button id="btnPickMemes" class="flex-1 px-4 py-3 rounded-2xl bg-sky-600 text-white hover:bg-sky-700 transition shadow focus-ring">–í—ã–±—Ä–∞—Ç—å</button>
            <button id="btnMemesToOrder" class="px-4 py-3 rounded-2xl glass hover:bg-white/60 transition shadow focus-ring">–ö –∑–∞–∫–∞–∑—É</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="cinemaModal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0 bg-slate-900/25" data-close-cinema="1"></div>
    <div class="relative h-full w-full flex items-end sm:items-center justify-center p-4">
      <div class="modal-panel w-full sm:max-w-xl glass-strong rounded-3xl p-5 sm:p-6 shadow-2xl">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-xs uppercase tracking-wider text-slate-600">–¢–æ–≤–∞—Ä</div>
            <div class="text-xl font-extrabold">üé¨ –ö–∏–Ω–æ –∏ –ê–Ω–∏–º–µ ‚Äî –≤—ã–±–µ—Ä–∏ —Ñ–æ—Ä–º–∞—Ç</div>
            <div class="mt-1 text-sm text-slate-700">–¶–µ–Ω–∞ –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è –¥–ª—è –≤—Å–µ—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤: <span class="font-semibold">750 ü™ô</span>.</div>
          </div>
          <button class="px-3 py-2 rounded-xl glass hover:bg-white/60 transition focus-ring" data-close-cinema="1">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>

        <div class="mt-4 grid gap-4">
          <div class="glass rounded-2xl p-4">
            <div class="text-sm text-slate-600">–§–æ—Ä–º–∞—Ç</div>
            <div id="cinemaChoices" class="mt-3 grid grid-cols-2 sm:grid-cols-3 gap-2">
              <button class="cinema-choice px-3 py-2.5 rounded-2xl glass hover:bg-white/60 transition focus-ring text-sm" data-kind="–§–∏–ª—å–º">üé¨ –§–∏–ª—å–º</button>
              <button class="cinema-choice px-3 py-2.5 rounded-2xl glass hover:bg-white/60 transition focus-ring text-sm" data-kind="–ú—É–ª—å—Ç—Ñ–∏–ª—å–º">üß∏ –ú—É–ª—å—Ç—Ñ–∏–ª—å–º</button>
              <button class="cinema-choice px-3 py-2.5 rounded-2xl glass hover:bg-white/60 transition focus-ring text-sm" data-kind="–ê–Ω–∏–º–µ">üçø –ê–Ω–∏–º–µ</button>
              <button class="cinema-choice px-3 py-2.5 rounded-2xl glass hover:bg-white/60 transition focus-ring text-sm" data-kind="–°–µ—Ä–∏–∞–ª">üì∫ –°–µ—Ä–∏–∞–ª</button>
              <button class="cinema-choice px-3 py-2.5 rounded-2xl glass hover:bg-white/60 transition focus-ring text-sm" data-kind="–¢–µ–ª–µ–ø–µ—Ä–µ–¥–∞—á–∞">üéôÔ∏è –¢–µ–ª–µ–ø–µ—Ä–µ–¥–∞—á–∞</button>
            </div>
            <div class="mt-3 text-xs text-slate-600">–í—ã–±–æ—Ä –≤–ª–∏—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (—Ü–µ–Ω–∞ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è).</div>
          </div>

          <div class="glass rounded-2xl p-4">
            <div class="font-bold">–ß—Ç–æ –ø–æ–ø–∞–¥—ë—Ç –≤ –∑–∞–∫–∞–∑</div>
            <div class="mt-2 text-sm text-slate-700" id="cinemaPreview">–ö–∏–Ω–æ –∏ –ê–Ω–∏–º–µ ‚Äî –≤—ã–±–µ—Ä–∏ —Ñ–æ—Ä–º–∞—Ç</div>
            <div class="mt-1 text-xs text-slate-600">–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ/–ø–æ–∂–µ–ª–∞–Ω–∏—è –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–∞ —à–∞–≥–µ –∑–∞–∫–∞–∑–∞.</div>
          </div>

          <div class="flex flex-col sm:flex-row gap-3">
            <button id="btnPickCinema" class="flex-1 px-4 py-3 rounded-2xl bg-sky-600 text-white hover:bg-sky-700 transition shadow focus-ring" disabled>–í—ã–±—Ä–∞—Ç—å</button>
            <button id="btnCinemaToOrder" class="px-4 py-3 rounded-2xl glass hover:bg-white/60 transition shadow focus-ring" disabled>–ö –∑–∞–∫–∞–∑—É</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const DEFAULT_CFG = {
      // –í–ê–ñ–ù–û: —Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω—ã –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ. –õ—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ORDER_API_URL (Apps Script),
      // —á—Ç–æ–±—ã –Ω–µ —Å–≤–µ—Ç–∏—Ç—å TELEGRAM_BOT_TOKEN –≤ –±—Ä–∞—É–∑–µ—Ä–µ.
      TELEGRAM_BOT_TOKEN: '8269159854:AAHoLGrTjm79AMK2Ma3H5j614BdWNJ4Oe-Q',
      TELEGRAM_CHAT_IDS: '5102684150',
      BALANCE_API_URL: 'https://script.google.com/macros/s/AKfycbwm_z6obO9t_f3QAjjwNEdmtXSrfj3kAWiHnFC80mJkmw1EPlF90kED5Ys1vzp0u6oXhQ/exec',
      ORDER_API_URL: '–ó–ê–ü–†–û–°–ò–¢–¨ –ü–û–°–õ–ï –°–û–ó–î–ê–ù–ò–Ø –°–ê–ô–¢–ê',
      TWITCH_CLIENT_ID: 'njg6lnlpkp9h8s3pdkwzl7byhju06n',
      TWITCH_REDIRECT_URI: 'https://zakslmv.github.io/zakslmvshop/index.html'
    };

    const LS_KEYS = {
      cfg: 'zakshop.cfg.v1',
      auth: 'zakshop.twitch.auth.v1',
      selection: 'zakshop.selection.v1',
      comment: 'zakshop.comment.v1',
      pkce: 'zakshop.pkce.v1'
    };

    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const state = {
      cfg: loadCfg(),
      auth: loadAuth(),
      balance: null,
      selected: loadSelection(),
      placing: false
    };

    function loadCfg(){
      try{
        const raw = localStorage.getItem(LS_KEYS.cfg);
        if(!raw) return {...DEFAULT_CFG};
        const parsed = JSON.parse(raw);
        return {...DEFAULT_CFG, ...parsed};
      }catch{ return {...DEFAULT_CFG}; }
    }

    function saveCfg(patch){
      state.cfg = {...state.cfg, ...patch};
      localStorage.setItem(LS_KEYS.cfg, JSON.stringify(state.cfg));
    }

    function resetCfg(){
      localStorage.removeItem(LS_KEYS.cfg);
      state.cfg = {...DEFAULT_CFG};
    }

    function loadAuth(){
      try{
        const raw = localStorage.getItem(LS_KEYS.auth);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch{ return null; }
    }

    function saveAuth(auth){
      state.auth = auth;
      if(auth) localStorage.setItem(LS_KEYS.auth, JSON.stringify(auth));
      else localStorage.removeItem(LS_KEYS.auth);
    }

    function loadSelection(){
      try{
        const raw = localStorage.getItem(LS_KEYS.selection);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch{ return null; }
    }

    function saveSelection(sel){
      state.selected = sel;
      if(sel) localStorage.setItem(LS_KEYS.selection, JSON.stringify(sel));
      else localStorage.removeItem(LS_KEYS.selection);
    }

    function setComment(val){
      localStorage.setItem(LS_KEYS.comment, val ?? '');
    }

    function getComment(){
      return localStorage.getItem(LS_KEYS.comment) || '';
    }

    function fmtCoins(x){
      if(x === null || x === undefined || Number.isNaN(Number(x))) return '‚Äî';
      const n = Number(x);
      const isInt = Math.abs(n - Math.round(n)) < 1e-9;
      return (isInt ? String(Math.round(n)) : n.toFixed(2).replace(/\.00$/, ''));
    }

    function setStatus(el, {type='info', title='', message='', html=''}){
      const colors = {
        info: 'bg-white/60 text-slate-800 border-white/60',
        ok: 'bg-emerald-50/70 text-emerald-900 border-emerald-200/70',
        warn: 'bg-amber-50/70 text-amber-900 border-amber-200/70',
        err: 'bg-rose-50/70 text-rose-900 border-rose-200/70'
      };
      el.className = `rounded-2xl p-4 border ${colors[type]}`;
      el.innerHTML = html || `
        <div class="font-bold">${escapeHtml(title)}</div>
        <div class="mt-1 text-sm leading-relaxed">${escapeHtml(message)}</div>
      `;
    }

    function escapeHtml(str){
      return String(str ?? '').replace(/[&<>"']/g, (c)=>({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
      }[c]));
    }

    function cfgIsSet(val){
      return val && typeof val === 'string' && !val.includes('–ó–ê–ü–†–û–°–ò–¢–¨') && val.trim().length > 5;
    }

    function toastInBalance(type, title, message){
      const el = $('#balanceStatus');
      setStatus(el, {type, title, message});
    }

    // –ì—Ä—É–ø–ø—ã —Ç–æ–≤–∞—Ä–æ–≤: –æ–±—ä–µ–¥–∏–Ω—è–µ–º –æ–¥–Ω–æ—Ç–∏–ø–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –≤ –æ–¥–Ω—É –∫–∞—Ä—Ç–æ—á–∫—É –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    // –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –≤–∏—Ç—Ä–∏–Ω–∞ –±–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–π: –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä = –æ–¥–Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞
    // (–ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–Ω–æ–≤–∞ –æ–±—ä–µ–¥–∏–Ω—è—Ç—å –ø–æ—Ö–æ–∂–∏–µ –ø–æ–∑–∏—Ü–∏–∏ ‚Äî –≤–µ—Ä–Ω—ë–º –≥—Ä—É–ø–ø—ã)
    const PRODUCTS = [
      {
        id: 'memes-custom',
        category: '–ú–µ–º—ã',
        title: '–ú–µ–º—ã (–ø–∞–∫)',
        price: 200,
        icon: 'üòÇ',
        desc: '–í—ã–±–∏—Ä–∞–µ—à—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ–º–æ–≤ –ø–æ–ª–∑—É–Ω–∫–æ–º (—á–µ–º –±–æ–ª—å—à–µ ‚Äî —Ç–µ–º –≤—ã–≥–æ–¥–Ω–µ–µ).',
        kind: 'memes_custom'
      },
      {
        id: 'cinema-custom',
        category: '–ö–∏–Ω–æ –∏ –ê–Ω–∏–º–µ',
        title: '–ö–∏–Ω–æ –∏ –ê–Ω–∏–º–µ (–≤—ã–±–æ—Ä)',
        price: 750,
        icon: 'üé¨',
        desc: '–í—ã–±–∏—Ä–∞–µ—à—å —Ñ–æ—Ä–º–∞—Ç: —Ñ–∏–ª—å–º/–º—É–ª—å—Ç—Ñ–∏–ª—å–º/–∞–Ω–∏–º–µ/—Å–µ—Ä–∏–∞–ª/—Ç–µ–ª–µ–ø–µ—Ä–µ–¥–∞—á–∞. –¶–µ–Ω–∞ –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è.',
        kind: 'cinema_custom'
      },
      { id: '18plus', category: '18+', title: '–•–µ–Ω—Ç–∞–π / –ü–æ—Ä–Ω–æ-–∏–≥—Ä—ã –Ω–∞ Boosty', price: 1000, icon: 'üîû', desc: '–ù–∞ —Ç–≤–æ–π/–º–æ–π –≤—ã–±–æ—Ä. –ê–∫–∫—É—Ä–∞—Ç–Ω–æ, —ç—Ç–æ 18+.' },
      { id: 'game', category: '–ì–µ–π–º–µ—Ä—Å–∫–∞—è –∑–æ–Ω–∞', title: '–ò–≥—Ä–∞—é –≤ —Ç–≤–æ—é –∏–≥—Ä—É', price: 1500, icon: 'üéÆ', desc: '–î–ª—è MMO ‚Äî —Ç–æ–ª—å–∫–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ. –ï—Å–ª–∏ –Ω–µ –∑–∞–π–¥—ë—Ç ‚Äî —Å—Ç–æ–ø —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞.' },
      { id: 'custom', category: '–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç', title: '–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç (–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ)', price: 0, icon: 'üìù', desc: '–ü—Ä–µ–¥–ª–æ–∂–∏ —Å–≤–æ—é –∏–¥–µ—é –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏. –¶–µ–Ω–∞ –æ–±—Å—É–∂–¥–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏.' },
      { id: 'ultimate', category: '–£–ª—å—Ç–∏–º–∞—Ç–∏–≤–Ω—ã–π –∑–∞–∫–∞–∑', title: '12 —á–∞—Å–æ–≤ —Å—Ç—Ä–∏–º–∞!', price: 5000, icon: 'üëë', desc: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º. –ü–ª–∞–Ω–∏—Ä—É–µ–º –∑–∞—Ä–∞–Ω–µ–µ.' }
    ];

    // –ú–µ–º—ã: 20..500, —á–µ–º –±–æ–ª—å—à–µ ‚Äî —Ç–µ–º –¥–µ—à–µ–≤–ª–µ –∑–∞ 1 –º–µ–º
    // –¶–µ–Ω–∞ = memesQty * unitPrice(qty), –≥–¥–µ unitPrice –ª–∏–Ω–µ–π–Ω–æ –ø–∞–¥–∞–µ—Ç –æ—Ç 10 –¥–æ 5
    // –ü—Ä–æ–≤–µ—Ä–∫–∞: 20 ‚Üí 200 (10/–º–µ–º), 500 ‚Üí 2500 (5/–º–µ–º)
    const MEMES = {
      min: 20,
      max: 500,
      step: 5,
      unitMax: 10,
      unitMin: 5
    };

    function memesUnitPrice(qty){
      const q = clamp(qty, MEMES.min, MEMES.max);
      const t = (q - MEMES.min) / (MEMES.max - MEMES.min);
      const unit = MEMES.unitMax + (MEMES.unitMin - MEMES.unitMax) * t; // 10 ‚Üí 5
      return unit;
    }

    function memesPrice(qty){
      const unit = memesUnitPrice(qty);
      // –æ–∫—Ä—É–≥–ª–∏–º —Ü–µ–Ω—É –¥–æ 5 –º–æ–Ω–µ—Ç, —á—Ç–æ–±—ã –≤—ã–≥–ª—è–¥–µ–ª–æ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ
      const raw = qty * unit;
      return Math.round(raw / 5) * 5;
    }

    function clamp(x, a, b){
      return Math.min(b, Math.max(a, Number(x)||0));
    }

    function renderProducts(){
      const grid = $('#productsGrid');
      grid.className = 'mt-6 grid gap-3 sm:grid-cols-2 lg:grid-cols-3';

      grid.innerHTML = PRODUCTS.map(p => productTileHtml(p)).join('');

      $$('#productsGrid [data-pick]').forEach(btn => btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-pick');
        const p = PRODUCTS.find(x => x.id === id);
        if(!p) return;

        // –û—Å–æ–±—ã–µ —Ç–æ–≤–∞—Ä—ã —Å –º–æ–¥–∞–ª–∫–∞–º–∏
        if(p.kind === 'memes_custom'){
          openMemesModal();
          return;
        }
        if(p.kind === 'cinema_custom'){
          openCinemaModal();
          return;
        }

        saveSelection({id: p.id, title: p.title, category: p.category, price: p.price, icon: p.icon});
        updateSelectionUI(true);
        document.querySelector('#order')?.scrollIntoView({behavior:'smooth', block:'start'});
      }));
    }

    function productTileHtml(p){
      const picked = state.selected?.id === p.id;
      return `
        <div class="glass rounded-2xl p-4 border ${picked ? 'border-sky-300/70' : 'border-white/60'} hover:bg-white/60 transition">
          <div class="flex items-start justify-between gap-3">
            <div class="flex items-start gap-3 min-w-0">
              <div class="w-10 h-10 rounded-2xl bg-white/70 flex items-center justify-center shrink-0">${escapeHtml(p.icon)}</div>
              <div class="min-w-0">
                <div class="font-extrabold leading-tight truncate">${escapeHtml(p.title)}</div>
                <div class="text-xs text-slate-600 mt-0.5">${escapeHtml(p.category)}</div>
                <div class="text-sm text-slate-700 mt-1 leading-snug">${escapeHtml(p.desc)}</div>
              </div>
            </div>
            <div class="text-right shrink-0">
              <div class="text-[11px] uppercase tracking-wider text-slate-600">–¶–µ–Ω–∞</div>
              <div class="font-extrabold">${fmtCoins(p.price)} ü™ô</div>
            </div>
          </div>

          <button data-pick="${escapeHtml(p.id)}" class="mt-3 w-full px-3 py-2.5 rounded-2xl ${picked ? 'bg-emerald-600 text-white hover:bg-emerald-700' : 'bg-sky-600 text-white hover:bg-sky-700'} transition shadow focus-ring">
            ${picked ? '–í—ã–±—Ä–∞–Ω–æ' : '–í—ã–±—Ä–∞—Ç—å'}
          </button>
        </div>
      `;
    }

    function updateSelectionUI(rerender=false){
      if(rerender) renderProducts();
      const sel = state.selected;
      $('#selectedBadge').textContent = sel ? `${sel.icon} ${sel.title} ‚Äî ${fmtCoins(sel.price)} ü™ô` : '–ù–∏—á–µ–≥–æ';
      $('#orderItemName').textContent = sel ? `${sel.icon} ${sel.title}` : '‚Äî';
      $('#orderItemMeta').textContent = sel ? `${sel.category}` : '–í—ã–±–µ—Ä–∏ —Ç–æ–≤–∞—Ä –≤ –≤–∏—Ç—Ä–∏–Ω–µ';
      $('#orderItemPrice').textContent = sel ? fmtCoins(sel.price) : '‚Äî';
    }

    function calcScore(N){
      N = Math.max(1, Number(N)||1);
      return 50*N + 0.03*(50*N)*(N-1);
    }

    function explainCalc(N){
      N = Math.max(1, Number(N)||1);
      if(N === 1) return '1 –∫–ª–∏–ø ‚Üí 50 ü™ô';
      const base = 50*N;
      const bonus = 0.03*base*(N-1);
      const total = base + bonus;
      return `–ë–∞–∑–∞: 50√ó${N} = ${fmtCoins(base)} ü™ô ‚Ä¢ –ü—Ä–µ–º–∏—è: 0.03√ó(${fmtCoins(base)})√ó(${N-1}) = ${fmtCoins(bonus)} ü™ô ‚Ä¢ –ò—Ç–æ–≥: ${fmtCoins(total)} ü™ô`;
    }

    function openCalc(){
      $('#calcModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      updateCalc();
      setTimeout(() => $('#clips')?.focus(), 0);
    }

    function closeCalc(){
      $('#calcModal').classList.add('hidden');
      document.body.style.overflow = '';
    }

    function updateCalc(){
      const n = Number($('#clips').value || 1);
      const total = calcScore(n);
      $('#calcResult').textContent = fmtCoins(total);
      $('#calcExplain').textContent = explainCalc(n);
      $('#clipsRange').value = String(Math.min(30, Math.max(1, n)));
    }

    function randString(len=64){
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
      let out = '';
      const arr = new Uint8Array(len);
      crypto.getRandomValues(arr);
      for(let i=0;i<len;i++) out += chars[arr[i] % chars.length];
      return out;
    }

    async function sha256base64url(str){
      const enc = new TextEncoder().encode(str);
      const digest = await crypto.subtle.digest('SHA-256', enc);
      const bytes = new Uint8Array(digest);
      let b64 = btoa(String.fromCharCode(...bytes));
      return b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    }

    function twitchConfigOk(){
      return cfgIsSet(state.cfg.TWITCH_CLIENT_ID) && cfgIsSet(state.cfg.TWITCH_REDIRECT_URI);
    }

    async function startTwitchLogin(){
      if(!twitchConfigOk()){
        toastInBalance('warn', '–ù—É–∂–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è', '–ó–∞–ø–æ–ª–Ω–∏ TWITCH_CLIENT_ID –∏ TWITCH_REDIRECT_URI –≤ ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö¬ª.');
        openSettings();
        return;
      }

      const clientId = state.cfg.TWITCH_CLIENT_ID.trim();
      const redirectUri = state.cfg.TWITCH_REDIRECT_URI.trim();
      const stateStr = randString(22);
      const verifier = randString(64);
      const challenge = await sha256base64url(verifier);

      sessionStorage.setItem(LS_KEYS.pkce, JSON.stringify({verifier, state: stateStr, ts: Date.now()}));

      const scopes = ['user:read:email'];
      const params = new URLSearchParams({
        client_id: clientId,
        redirect_uri: redirectUri,
        response_type: 'code',
        scope: scopes.join(' '),
        state: stateStr,
        code_challenge: challenge,
        code_challenge_method: 'S256'
      });

      window.location.href = `https://id.twitch.tv/oauth2/authorize?${params.toString()}`;
    }

    async function handleTwitchRedirect(){
      const url = new URL(window.location.href);
      const code = url.searchParams.get('code');
      const returnedState = url.searchParams.get('state');
      const error = url.searchParams.get('error');
      const errorDesc = url.searchParams.get('error_description');

      const hash = new URLSearchParams((window.location.hash || '').replace(/^#/, ''));
      const accessTokenHash = hash.get('access_token');
      const tokenTypeHash = hash.get('token_type');

      if(error){
        toastInBalance('err', '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Twitch', `${error}: ${errorDesc || ''}`.trim());
        return;
      }

      if(accessTokenHash && tokenTypeHash){
        saveAuth({ access_token: accessTokenHash, token_type: tokenTypeHash, obtained_at: Date.now(), via: 'implicit' });
        history.replaceState({}, document.title, url.origin + url.pathname + url.search);
        await hydrateUserFromTwitch();
        return;
      }

      if(!code) return;

      try{
        const pkceRaw = sessionStorage.getItem(LS_KEYS.pkce);
        const pkce = pkceRaw ? JSON.parse(pkceRaw) : null;
        if(!pkce || !pkce.verifier) throw new Error('PKCE verifier –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π –≤–æ–π—Ç–∏ –µ—â—ë —Ä–∞–∑.');
        if(pkce.state !== returnedState) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä state.');

        const token = await exchangeCodeForToken(code, pkce.verifier);
        saveAuth({...token, obtained_at: Date.now(), via: 'pkce'});

        url.searchParams.delete('code');
        url.searchParams.delete('state');
        history.replaceState({}, document.title, url.toString());

        await hydrateUserFromTwitch();
      }catch(e){
        setAuthUI(false);
        toastInBalance('err', '–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Twitch', `${e.message || e}`);
        showImplicitFallback();
      }
    }

    async function exchangeCodeForToken(code, verifier){
      const clientId = state.cfg.TWITCH_CLIENT_ID.trim();
      const redirectUri = state.cfg.TWITCH_REDIRECT_URI.trim();

      const body = new URLSearchParams({
        client_id: clientId,
        code,
        grant_type: 'authorization_code',
        redirect_uri: redirectUri,
        code_verifier: verifier
      });

      const resp = await fetch('https://id.twitch.tv/oauth2/token', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body
      });
      const data = await resp.json().catch(()=> ({}));
      if(!resp.ok) throw new Error(data.message || `Token error: HTTP ${resp.status}`);
      if(!data.access_token) throw new Error('access_token –Ω–µ –ø–æ–ª—É—á–µ–Ω');
      return data;
    }

    function showImplicitFallback(){
      const el = $('#balanceStatus');
      const ok = twitchConfigOk();
      if(!ok) return;

      const clientId = state.cfg.TWITCH_CLIENT_ID.trim();
      const redirectUri = state.cfg.TWITCH_REDIRECT_URI.trim();
      const stateStr = randString(18);
      const params = new URLSearchParams({
        client_id: clientId,
        redirect_uri: redirectUri,
        response_type: 'token',
        scope: '',
        state: stateStr
      });

      setStatus(el, {
        type: 'warn',
        title: 'Fallback (–µ—Å–ª–∏ PKCE –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª)',
        message: '–ú–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å Implicit Flow. –≠—Ç–æ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç.'
      });
      el.innerHTML += `
        <div class="mt-3">
          <a class="inline-flex items-center gap-2 px-4 py-2 rounded-2xl bg-white/80 hover:bg-white transition shadow" href="https://id.twitch.tv/oauth2/authorize?${params.toString()}">
            –ü–µ—Ä–µ–π—Ç–∏ –∫ Implicit –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            <span aria-hidden="true">‚Üí</span>
          </a>
        </div>
      `;
    }

    async function twitchApi(path){
      if(!state.auth?.access_token) throw new Error('–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞');
      if(!cfgIsSet(state.cfg.TWITCH_CLIENT_ID)) throw new Error('–ù–µ—Ç TWITCH_CLIENT_ID');
      const resp = await fetch(`https://api.twitch.tv/helix/${path.replace(/^\//,'')}`, {
        headers: {
          'Authorization': `Bearer ${state.auth.access_token}`,
          'Client-Id': state.cfg.TWITCH_CLIENT_ID.trim()
        }
      });
      const data = await resp.json().catch(()=> ({}));
      if(!resp.ok) throw new Error(data.message || `Twitch API error: HTTP ${resp.status}`);
      return data;
    }

    async function hydrateUserFromTwitch(){
      try{
        if(!state.auth?.access_token){ setAuthUI(false); return; }
        const data = await twitchApi('users');
        const u = data?.data?.[0];
        if(!u) throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
        const profile = { id: u.id, login: u.login, display_name: u.display_name, profile_image_url: u.profile_image_url };
        saveAuth({...state.auth, profile});
        setAuthUI(true);
        toastInBalance('ok', '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞', `–ü—Ä–∏–≤–µ—Ç, ${profile.display_name}! –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å.`);
      }catch(e){
        setAuthUI(false);
        toastInBalance('err', '–û—à–∏–±–∫–∞ Twitch API', e.message || String(e));
      }
    }

    function setAuthUI(isAuthed){
      const dot = $('#authDot');
      const label = $('#authLabel');
      if(isAuthed && state.auth?.profile?.display_name){
        dot.className = 'w-2.5 h-2.5 rounded-full bg-emerald-500';
        label.textContent = `@${state.auth.profile.display_name}`;
        $('#btnLogin').classList.add('hidden');
        $('#btnLogout').classList.remove('hidden');
      }else{
        dot.className = 'w-2.5 h-2.5 rounded-full bg-slate-300';
        label.textContent = '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω(–∞)';
        $('#btnLogin').classList.remove('hidden');
        $('#btnLogout').classList.add('hidden');
      }
    }

    function logout(){
      saveAuth(null);
      state.balance = null;
      $('#balanceValue').textContent = '‚Äî';
      $('#balanceHint').textContent = '–ê–≤—Ç–æ—Ä–∏–∑—É–π—Å—è —á–µ—Ä–µ–∑ Twitch, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏ ¬´–û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å¬ª.';
      toastInBalance('info', '–í—ã—Ö–æ–¥', '–¢—ã –≤—ã—à–µ–ª(–ª–∞) –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞.');
      setAuthUI(false);
    }

    function getNickForBalance(){
      const p = state.auth?.profile;
      return { display: p?.display_name || null, login: p?.login || null };
    }

    async function fetchBalance(){
      if(!state.auth?.profile){
        toastInBalance('warn', '–ù—É–∂–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', '–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏ —á–µ—Ä–µ–∑ Twitch.');
        return;
      }
      if(!cfgIsSet(state.cfg.BALANCE_API_URL)){
        toastInBalance('warn', '–ù—É–∂–µ–Ω Apps Script URL', '–ó–∞–ø–æ–ª–Ω–∏ BALANCE_API_URL –≤ ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö¬ª.');
        openSettings();
        return;
      }

      const {display, login} = getNickForBalance();
      const nick = display || login;
      if(!nick) throw new Error('–ù–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω');

      $('#balanceValue').textContent = '‚Ä¶';
      toastInBalance('info', '–ó–∞–≥—Ä—É–∑–∫–∞', '–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –±–∞–ª–∞–Ω—Å –∏–∑ —Ç–∞–±–ª–∏—Ü—ã‚Ä¶');

      const url = new URL(state.cfg.BALANCE_API_URL.trim());
      url.searchParams.set('nick', nick);
      if(login) url.searchParams.set('login', login);

      const resp = await fetch(url.toString(), { method: 'GET' });
      const data = await resp.json().catch(()=> ({}));
      if(!resp.ok) throw new Error(data.error || `HTTP ${resp.status}`);

      // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –æ—Ç–≤–µ—Ç–∞
      // –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç: { balance: number }
      // –¢–∞–∫–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∏–º: { points: number }, { data: { balance } }, { result: { balance } }
      // –ò —Ç–≤–æ–π –∫–µ–π—Å Google Sheets: { "–ò—Ç–æ–≥–æ–≤—ã–µ –±–∞–ª–ª—ã": number } –∏–ª–∏ { totalPoints: number }
      const balance = (
        data.balance ??
        data.points ??
        data.totalPoints ??
        data.total_points ??
        data['–ò—Ç–æ–≥–æ–≤—ã–µ –±–∞–ª–ª—ã'] ??
        (data.data && (data.data.balance ?? data.data.points ?? data.data['–ò—Ç–æ–≥–æ–≤—ã–µ –±–∞–ª–ª—ã'])) ??
        (data.result && (data.result.balance ?? data.result.points))
      );
      if(balance === undefined || balance === null) throw new Error('API –Ω–µ –≤–µ—Ä–Ω—É–ª balance/–ò—Ç–æ–≥–æ–≤—ã–µ –±–∞–ª–ª—ã');

      state.balance = Number(balance);
      $('#balanceValue').textContent = fmtCoins(state.balance);
      $('#balanceHint').textContent = `–ë–∞–ª–∞–Ω—Å –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –Ω–∏–∫—É: ${nick}`;
      toastInBalance('ok', '–ì–æ—Ç–æ–≤–æ', `–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: ${fmtCoins(state.balance)} ü™ô`);
    }

    function getSelected(){
      if(!state.selected) return null;
      const p = PRODUCTS.find(x => x.id === state.selected.id);
      return p ? {...p} : {...state.selected};
    }

    function showOrderStatus({type='info', title='', message='', html=''}){
      const el = $('#orderStatus');
      el.classList.remove('hidden');
      setStatus(el, {type, title, message, html});
    }

    function setOrderActionsVisible(v){
      const el = $('#orderActions');
      if(v) el.classList.remove('hidden');
      else el.classList.add('hidden');
    }

    function resetOrderUI(){
      $('#orderStatus').classList.add('hidden');
      setOrderActionsVisible(false);
      state.placing = false;
      $('#btnPlaceOrder').disabled = false;
      $('#btnPlaceOrder').textContent = '–ó–∞–∫–∞–∑–∞—Ç—å';
    }

    function setPlacingUI(){
      state.placing = true;
      $('#btnPlaceOrder').disabled = true;
      $('#btnPlaceOrder').textContent = '–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º‚Ä¶';
      showOrderStatus({
        type: 'info',
        title: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞‚Ä¶',
        message: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥. –≠—Ç–æ –æ–∫–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.'
      });
      setOrderActionsVisible(false);
    }

    function buildTelegramMessage({nick, item, comment}){
      const lines = [
        'üì¶ –ù–æ–≤—ã–π –∑–∞–∫–∞–∑:',
        `–¢–æ–≤–∞—Ä: ${item.title}`,
        `Nick: ${nick}`,
        `–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${comment && comment.trim() ? comment.trim() : '‚Äî'}`,
        `–°—Ç–æ–∏–º–æ—Å—Ç—å: ${fmtCoins(item.price)} ü™ô`
      ];
      return lines.join('\n');
    }

    async function placeOrder(){
      if(state.placing) return;

      if(!state.auth?.profile){
        showOrderStatus({type:'warn', title:'–ù—É–∂–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', message:'–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏ —á–µ—Ä–µ–∑ Twitch, —á—Ç–æ–±—ã –ø–æ–¥—Ç—è–Ω—É—Ç—å –Ω–∏–∫ –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å.'});
        setOrderActionsVisible(true);
        return;
      }

      const item = getSelected();
      if(!item){
        showOrderStatus({type:'warn', title:'–ù–µ –≤—ã–±—Ä–∞–Ω —Ç–æ–≤–∞—Ä', message:'–í–µ—Ä–Ω–∏—Å—å –≤ —Ä–∞–∑–¥–µ–ª ¬´–¢–æ–≤–∞—Ä—ã¬ª –∏ –Ω–∞–∂–º–∏ ¬´–í—ã–±—Ä–∞—Ç—å¬ª.'});
        setOrderActionsVisible(true);
        return;
      }

      const nick = state.auth.profile.display_name || state.auth.profile.login;
      const comment = ($('#comment').value || '').trim();

      try{
        setPlacingUI();

        await fetchBalance();

        if(state.balance === null || state.balance === undefined || Number.isNaN(Number(state.balance))) throw new Error('–ë–∞–ª–∞–Ω—Å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω');
        if(Number(state.balance) < Number(item.price)){
          showOrderStatus({
            type:'err',
            title:'–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤',
            message:`–ù—É–∂–Ω–æ ${fmtCoins(item.price)} ü™ô, –∞ —É —Ç–µ–±—è ${fmtCoins(state.balance)} ü™ô. –ó–∞–∫–∞–∑ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.`
          });
          setOrderActionsVisible(true);
          $('#btnPlaceOrder').disabled = false;
          $('#btnPlaceOrder').textContent = '–ó–∞–∫–∞–∑–∞—Ç—å';
          state.placing = false;
          return;
        }

        const message = buildTelegramMessage({nick, item, comment});
        const orderPayload = {
          nick,
          login: state.auth.profile.login,
          display_name: state.auth.profile.display_name,
          item,
          comment,
          price: item.price,
          message,
          ts: Date.now()
        };

        let sentVia = null;

        if(cfgIsSet(state.cfg.ORDER_API_URL)){
          const resp = await fetch(state.cfg.ORDER_API_URL.trim(), {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ action: 'order', ...orderPayload })
          });
          const data = await resp.json().catch(()=> ({}));
          if(!resp.ok || data.ok === false){
            throw new Error(data.error || `ORDER_API_URL: HTTP ${resp.status}`);
          }
          sentVia = 'Apps Script';

          if(data.balance !== undefined && data.balance !== null){
            state.balance = Number(data.balance);
            $('#balanceValue').textContent = fmtCoins(state.balance);
          }
        } else if(cfgIsSet(state.cfg.TELEGRAM_BOT_TOKEN) && cfgIsSet(state.cfg.TELEGRAM_CHAT_IDS)){
          const ids = state.cfg.TELEGRAM_CHAT_IDS.split(',').map(s=>s.trim()).filter(Boolean);
          const token = state.cfg.TELEGRAM_BOT_TOKEN.trim();
          if(!ids.length) throw new Error('TELEGRAM_CHAT_IDS –ø—É—Å—Ç');

          for(const chatId of ids){
            const url = `https://api.telegram.org/bot${token}/sendMessage`;
            const resp = await fetch(url, {
              method: 'POST',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify({ chat_id: chatId, text: message })
            });
            const data = await resp.json().catch(()=> ({}));
            if(!resp.ok || data.ok === false){
              throw new Error(data.description || `Telegram error: HTTP ${resp.status}`);
            }
          }
          sentVia = 'Telegram –Ω–∞–ø—Ä—è–º—É—é';
        } else {
          throw new Error('–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω ORDER_API_URL –∏ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã Telegram –ø–∞—Ä–∞–º–µ—Ç—Ä—ã. –û—Ç–∫—Ä–æ–π ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏¬ª.');
        }

        showOrderStatus({
          type:'ok',
          title:'–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω',
          message:`–ì–æ—Ç–æ–≤–æ! –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ (${sentVia}). –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ —Å–ø–∏—Å–∞–Ω–∏–µ ‚Äî –æ–Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ API.`
        });

        setOrderActionsVisible(true);
        $('#btnPlaceOrder').disabled = false;
        $('#btnPlaceOrder').textContent = '–ó–∞–∫–∞–∑–∞—Ç—å';
        state.placing = false;
      }catch(e){
        showOrderStatus({ type:'err', title:'–û—à–∏–±–∫–∞', message: e.message || String(e) });
        setOrderActionsVisible(true);
        $('#btnPlaceOrder').disabled = false;
        $('#btnPlaceOrder').textContent = '–ó–∞–∫–∞–∑–∞—Ç—å';
        state.placing = false;
      }
    }

    function openSettings(){
      $('#settingsModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      fillSettingsInputs();
      setTimeout(() => $('#cfgTwitchClientId')?.focus(), 0);
    }

    function closeSettings(){
      $('#settingsModal').classList.add('hidden');
      document.body.style.overflow = '';
    }

    // –ú–µ–º—ã (–º–æ–¥–∞–ª–∫–∞)
    function openMemesModal(){
      const range = $('#memesRange');
      if(range){
        range.min = String(MEMES.min);
        range.max = String(MEMES.max);
        range.step = String(MEMES.step);
        range.value = String(MEMES.min);
      }
      updateMemesModal();
      $('#memesModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      setTimeout(() => $('#memesRange')?.focus(), 0);
    }

    function closeMemesModal(){
      $('#memesModal').classList.add('hidden');
      document.body.style.overflow = '';
    }

    function updateMemesModal(){
      const qty = clamp($('#memesRange')?.value, MEMES.min, MEMES.max);
      const total = memesPrice(qty);
      const unit = total / qty;
      $('#memesQty').textContent = String(qty);
      $('#memesTotal').textContent = fmtCoins(total);
      $('#memesUnit').textContent = fmtCoins(unit);
      $('#memesPreview').textContent = `–ú–µ–º—ã: ${qty} —à—Ç. ‚Äî ${fmtCoins(total)} ü™ô`;
    }

    function pickMemesSelection({scrollToOrder=false}={}){
      const qty = clamp($('#memesRange')?.value, MEMES.min, MEMES.max);
      const total = memesPrice(qty);

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä
      saveSelection({
        id: 'memes-custom',
        title: `–ú–µ–º—ã ‚Äî ${qty} —à—Ç.`,
        category: '–ú–µ–º—ã',
        price: total,
        icon: 'üòÇ',
        meta: { qty }
      });
      updateSelectionUI(true);

      closeMemesModal();

      if(scrollToOrder){
        document.querySelector('#order')?.scrollIntoView({behavior:'smooth', block:'start'});
      }
    }

    // –ö–∏–Ω–æ –∏ –∞–Ω–∏–º–µ (–º–æ–¥–∞–ª–∫–∞)
    const CINEMA = {
      price: 750,
      options: [
        { kind: '–§–∏–ª—å–º', icon: 'üé¨', hint: '–§–∏–ª—å–º (–¥–æ 2 —á–∞—Å–æ–≤)' },
        { kind: '–ú—É–ª—å—Ç—Ñ–∏–ª—å–º', icon: 'üß∏', hint: '–ú—É–ª—å—Ç—Ñ–∏–ª—å–º (–¥–æ 2 —á–∞—Å–æ–≤)' },
        { kind: '–ê–Ω–∏–º–µ', icon: 'üçø', hint: '–ê–Ω–∏–º–µ (–¥–æ 2 —á–∞—Å–æ–≤)' },
        { kind: '–°–µ—Ä–∏–∞–ª', icon: 'üì∫', hint: '–°–µ—Ä–∏–∞–ª (–¥–æ 2 —á–∞—Å–æ–≤)' },
        { kind: '–¢–µ–ª–µ–ø–µ—Ä–µ–¥–∞—á–∞', icon: 'üéôÔ∏è', hint: '–¢–µ–ª–µ–ø–µ—Ä–µ–¥–∞—á–∞ (–¥–æ 2 —á–∞—Å–æ–≤)' }
      ]
    };

    const cinemaState = { kind: null };

    function openCinemaModal(){
      cinemaState.kind = null;
      updateCinemaUI();
      $('#cinemaModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      setTimeout(() => $('#cinemaChoices .cinema-choice')?.focus(), 0);
    }

    function closeCinemaModal(){
      $('#cinemaModal').classList.add('hidden');
      document.body.style.overflow = '';
    }

    function updateCinemaUI(){
      const kind = cinemaState.kind;
      const preview = $('#cinemaPreview');
      const pickBtn = $('#btnPickCinema');
      const toOrderBtn = $('#btnCinemaToOrder');

      $$('#cinemaChoices .cinema-choice').forEach(b => {
        const k = b.getAttribute('data-kind');
        const active = kind && k === kind;
        b.classList.toggle('bg-sky-600', !!active);
        b.classList.toggle('text-white', !!active);
        b.classList.toggle('hover:bg-sky-700', !!active);
        // fallback to glass look when not active
        if(active){
          b.classList.remove('glass');
        }else{
          b.classList.add('glass');
        }
      });

      if(kind){
        preview.textContent = `–ö–∏–Ω–æ –∏ –ê–Ω–∏–º–µ ‚Äî ${kind} ‚Äî ${fmtCoins(CINEMA.price)} ü™ô`;
        pickBtn.disabled = false;
        toOrderBtn.disabled = false;
      }else{
        preview.textContent = '–ö–∏–Ω–æ –∏ –ê–Ω–∏–º–µ ‚Äî –≤—ã–±–µ—Ä–∏ —Ñ–æ—Ä–º–∞—Ç';
        pickBtn.disabled = true;
        toOrderBtn.disabled = true;
      }
    }

    function pickCinemaSelection({scrollToOrder=false}={}){
      if(!cinemaState.kind) return;
      const kind = cinemaState.kind;

      saveSelection({
        id: 'cinema-custom',
        title: `–ö–∏–Ω–æ –∏ –ê–Ω–∏–º–µ ‚Äî ${kind}`,
        category: '–ö–∏–Ω–æ –∏ –ê–Ω–∏–º–µ',
        price: CINEMA.price,
        icon: 'üé¨',
        meta: { kind }
      });
      updateSelectionUI(true);
      closeCinemaModal();

      if(scrollToOrder){
        document.querySelector('#order')?.scrollIntoView({behavior:'smooth', block:'start'});
      }
    }

    function fillSettingsInputs(){
      $('#cfgTwitchClientId').value = (cfgIsSet(state.cfg.TWITCH_CLIENT_ID) ? state.cfg.TWITCH_CLIENT_ID : '');
      $('#cfgTwitchRedirect').value = (cfgIsSet(state.cfg.TWITCH_REDIRECT_URI) ? state.cfg.TWITCH_REDIRECT_URI : window.location.href.split('#')[0]);
      $('#cfgBalanceApi').value = (cfgIsSet(state.cfg.BALANCE_API_URL) ? state.cfg.BALANCE_API_URL : '');
      $('#cfgOrderApi').value = (cfgIsSet(state.cfg.ORDER_API_URL) ? state.cfg.ORDER_API_URL : '');
      $('#cfgTgToken').value = (cfgIsSet(state.cfg.TELEGRAM_BOT_TOKEN) ? state.cfg.TELEGRAM_BOT_TOKEN : '');
      $('#cfgTgChats').value = (cfgIsSet(state.cfg.TELEGRAM_CHAT_IDS) ? state.cfg.TELEGRAM_CHAT_IDS : '');
    }

    function updateCfgStatus(text){
      $('#cfgStatus').textContent = text || '';
    }

    function setupStars(){
      const container = $('#stars');
      const isDesktop = window.matchMedia('(min-width: 900px)').matches;
      const reduceMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if(!isDesktop || reduceMotion) return;

      const count = 35;
      container.innerHTML = '';
      for(let i=0;i<count;i++){
        const s = document.createElement('div');
        s.className = 'star';
        const left = Math.random() * 100;
        const delay = Math.random() * 6;
        const dur = 6 + Math.random() * 10;
        const size = 1 + Math.random() * 2.2;
        s.style.left = `${left}%`;
        s.style.top = `${-Math.random() * 120}%`;
        s.style.width = `${size}px`;
        s.style.height = `${size}px`;
        s.style.animationDuration = `${dur}s`;
        s.style.animationDelay = `${delay}s`;
        s.style.opacity = String(0);
        container.appendChild(s);
      }
    }

    function setupClouds(){
      const container = $('#clouds');
      const isDesktop = window.matchMedia('(min-width: 900px)').matches;
      const reduceMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      container.innerHTML = '';
      if(!isDesktop || reduceMotion) return;

      const clouds = [
        {top: 12, dur: 45, scale: 1.0, opacity: .55},
        {top: 28, dur: 55, scale: 1.15, opacity: .45},
        {top: 46, dur: 62, scale: .9, opacity: .4},
        {top: 68, dur: 70, scale: 1.25, opacity: .35}
      ];
      for(const c of clouds){
        const el = document.createElement('div');
        el.className = 'cloud';
        el.style.top = `${c.top}%`;
        el.style.opacity = String(c.opacity);
        el.style.transform = `translate3d(-30vw, 0, 0) scale(${c.scale})`;
        el.style.animationDuration = `${c.dur}s`;
        el.style.animationDelay = `${-Math.random()*c.dur}s`;
        container.appendChild(el);
      }
    }

    function wireEvents(){
      // –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
      ['#btnOpenCalcRules','#btnOpenCalcFooter'].forEach(sel => {
        $(sel)?.addEventListener('click', openCalc);
      });

      $('#calcModal').addEventListener('click', (e) => {
        const t = e.target;
        if(t && t.getAttribute && t.getAttribute('data-close') === '1') closeCalc();
      });

      window.addEventListener('keydown', (e) => {
        if(e.key === 'Escape'){
          if(!$('#calcModal').classList.contains('hidden')) closeCalc();
          if(!$('#settingsModal').classList.contains('hidden')) closeSettings();
          if(!$('#memesModal')?.classList.contains('hidden')) closeMemesModal();
          if(!$('#cinemaModal')?.classList.contains('hidden')) closeCinemaModal();
        }
      });

      $('#clips').addEventListener('input', () => updateCalc());
      $('#clipsRange').addEventListener('input', () => {
        $('#clips').value = $('#clipsRange').value;
        updateCalc();
      });

      $('#btnCopyCalc').addEventListener('click', async () => {
        const n = Number($('#clips').value || 1);
        const total = fmtCoins(calcScore(n));
        const text = `${n} –∫–ª–∏–ø(–æ–≤) ‚Üí ${total} ü™ô`;
        try{ await navigator.clipboard.writeText(text); }catch{}
        $('#btnCopyCalc').textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ';
        setTimeout(()=> $('#btnCopyCalc').textContent = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å', 900);
      });

      $('#btnFillAsComment').addEventListener('click', () => {
        const n = Number($('#clips').value || 1);
        const total = fmtCoins(calcScore(n));
        const line = `–ö–ª–∏–ø—ã: ${n} ‚Üí ${total} ü™ô`;
        const ta = $('#comment');
        const cur = (ta.value || '').trim();
        ta.value = cur ? (cur + '\n' + line) : line;
        ta.dispatchEvent(new Event('input'));
        closeCalc();
        document.querySelector('#order')?.scrollIntoView({behavior: 'smooth', block: 'start'});
      });

      $('#btnOpenSettings').addEventListener('click', openSettings);
      $('#settingsModal').addEventListener('click', (e) => {
        const t = e.target;
        if(t && t.getAttribute && t.getAttribute('data-close-settings') === '1') closeSettings();
      });

      // –ú–µ–º—ã: –º–æ–¥–∞–ª–∫–∞
      $('#memesModal')?.addEventListener('click', (e) => {
        const t = e.target;
        if(t && t.getAttribute && t.getAttribute('data-close-memes') === '1') closeMemesModal();
      });
      $('#memesRange')?.addEventListener('input', updateMemesModal);
      $('#btnPickMemes')?.addEventListener('click', () => pickMemesSelection({scrollToOrder:false}));
      $('#btnMemesToOrder')?.addEventListener('click', () => pickMemesSelection({scrollToOrder:true}));

      // –ö–∏–Ω–æ –∏ –∞–Ω–∏–º–µ: –º–æ–¥–∞–ª–∫–∞
      $('#cinemaModal')?.addEventListener('click', (e) => {
        const t = e.target;
        if(t && t.getAttribute && t.getAttribute('data-close-cinema') === '1') closeCinemaModal();
      });
      $('#cinemaChoices')?.addEventListener('click', (e) => {
        const btn = e.target?.closest?.('.cinema-choice');
        if(!btn) return;
        cinemaState.kind = btn.getAttribute('data-kind');
        updateCinemaUI();
      });
      $('#btnPickCinema')?.addEventListener('click', () => pickCinemaSelection({scrollToOrder:false}));
      $('#btnCinemaToOrder')?.addEventListener('click', () => pickCinemaSelection({scrollToOrder:true}));

      $('#btnSaveCfg').addEventListener('click', () => {
        saveCfg({
          TWITCH_CLIENT_ID: $('#cfgTwitchClientId').value.trim(),
          TWITCH_REDIRECT_URI: $('#cfgTwitchRedirect').value.trim(),
          BALANCE_API_URL: $('#cfgBalanceApi').value.trim(),
          ORDER_API_URL: $('#cfgOrderApi').value.trim(),
          TELEGRAM_BOT_TOKEN: $('#cfgTgToken').value.trim(),
          TELEGRAM_CHAT_IDS: $('#cfgTgChats').value.trim()
        });
        updateCfgStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
        setTimeout(()=> updateCfgStatus(''), 1200);
      });

      $('#btnResetCfg').addEventListener('click', () => {
        resetCfg();
        fillSettingsInputs();
        updateCfgStatus('–°–±—Ä–æ—à–µ–Ω–æ');
        setTimeout(()=> updateCfgStatus(''), 1200);
      });

      $('#btnLogin').addEventListener('click', startTwitchLogin);
      $('#btnLogout').addEventListener('click', logout);

      $('#btnRefreshBalance').addEventListener('click', () => fetchBalance().catch(e => toastInBalance('err','–û—à–∏–±–∫–∞', e.message || String(e))));

      const comment = $('#comment');
      comment.value = getComment();
      comment.addEventListener('input', () => setComment(comment.value));

      // –í–∏—Ç—Ä–∏–Ω–∞ (–±–µ–∑ –ø–æ–∏—Å–∫–∞/–∫–∞—Ç–µ–≥–æ—Ä–∏–π)
      $('#btnShopReset')?.addEventListener('click', () => {
        saveSelection(null);
        updateSelectionUI(true);
        resetOrderUI();
      });

      // –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∏–∑ –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–æ–≤–∞—Ä–æ–≤ —É–±—Ä–∞–Ω

      $('#btnPlaceOrder').addEventListener('click', placeOrder);
      $('#btnRetry').addEventListener('click', placeOrder);
      $('#btnNewOrder').addEventListener('click', () => {
        resetOrderUI();
        $('#comment').value = '';
        setComment('');
        document.querySelector('#shop')?.scrollIntoView({behavior: 'smooth', block: 'start'});
      });

      $('#btnClearSelection').addEventListener('click', () => {
        saveSelection(null);
        updateSelectionUI(true);
        resetOrderUI();
      });

      window.addEventListener('resize', () => {
        setupStars();
        setupClouds();
      });
    }

    async function init(){
      renderProducts();
      updateSelectionUI(false);
      wireEvents();
      setupStars();
      setupClouds();

      setAuthUI(!!state.auth?.profile);

      await handleTwitchRedirect();

      if(state.auth?.access_token && !state.auth?.profile){
        await hydrateUserFromTwitch();
      }

      if(state.auth?.profile){
        $('#balanceHint').textContent = `–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω(–∞) –∫–∞–∫ @${state.auth.profile.display_name}. –ù–∞–∂–º–∏ ¬´–û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å¬ª.`;
      }
    }

    init();
  </script>
</body>
</html>
