<!DOCTYPE html>
<html lang="ru" class="scroll-smooth">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="color-scheme" content="light" />
    <title>–ú–∞–≥–∞–∑–∏–Ω—á–∏–∫ –Ø–º–∏ ‚Äî –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤</title>
    <meta name="description" content="–ú–∞–≥–∞–∑–∏–Ω—á–∏–∫ –Ø–º–∏ ‚Äî –∑–∞–∫–∞–∑—ã–≤–∞–π –∫–æ–Ω—Ç–µ–Ω—Ç –∑–∞ –±–∞–ª–ª—ã —Å –∫–ª–∏–ø–æ–≤. –ü—Ä–∞–≤–∏–ª–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è, –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –±–∞–ª–ª–æ–≤ –∏ —Ç–æ–≤–∞—Ä—ã." />
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        :root {
            --glass-bg: rgba(255,255,255,.55);
            --glass-brd: rgba(255,255,255,.45);
            --shadow: 0 18px 55px rgba(18, 28, 55, .14);
            --ring: 0 0 0 1px rgba(255,255,255,.55), 0 0 0 6px rgba(255,255,255,.18);
        }

        html, body {
            height: 100%;
        }

        body {
            overflow-x: hidden;
            background: radial-gradient(900px 600px at 18% 14%, rgba(255,255,255,.10), transparent 62%),
                        radial-gradient(800px 520px at 82% 22%, rgba(255,255,255,.08), transparent 60%),
                        linear-gradient(135deg, #f2b6da 0%, #9ad0f0 52%, #cbbcff 100%);
            color: rgba(255,255,255,.90);
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
        }

        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background: linear-gradient(180deg, rgba(6,10,28,.56), rgba(6,10,28,.40));
            z-index: 0;
            pointer-events: none;
        }

        .compact h1 {
            font-size: clamp(1.55rem, 3.6vw, 2.6rem) !important;
        }

        .compact h2 {
            font-size: clamp(1.25rem, 2.6vw, 1.85rem) !important;
        }

        .compact h3 {
            font-size: 1.05rem !important;
        }

        .noise {
            pointer-events: none;
            position: fixed;
            inset: 0;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.65" numOctaves="2" stitchTiles="stitch"/></filter><rect width="200" height="200" filter="url(%23n)" opacity="0.14"/></svg>');
            mix-blend-mode: soft-light;
            opacity: .14;
            z-index: 2;
        }

        #stars {
            position: fixed;
            inset: 0;
            z-index: 1;
            pointer-events: none;
        }

        .star {
            position: absolute;
            width: 10px;
            height: 10px;
            opacity: .0;
            filter: drop-shadow(0 0 6px rgba(231,191,43,.22));
            transform: translate3d(0,0,0) rotate(0deg);
            animation: starFall linear infinite;
        }

        .star::before {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.95), rgba(255,255,255,0) 52%), conic-gradient(from 0deg, #f6e7a6, #e7bf2b, #c9961d, #e7bf2b, #f6e7a6);
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            border-radius: 2px;
        }

        @keyframes starFall {
            0% {
                transform: translate3d(var(--x,0), -15vh, 0) rotate(0deg) scale(var(--s,1));
                opacity: 0;
            }
            10% { opacity: var(--o,.85); }
            90% { opacity: var(--o,.85); }
            100% {
                transform: translate3d(calc(var(--x,0) + var(--drift,0px)), 115vh, 0) rotate(260deg) scale(var(--s,1));
                opacity: 0;
            }
        }

        #clouds {
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
        }

        .cloud {
            position: absolute;
            width: clamp(140px, 22vw, 300px);
            height: clamp(52px, 9vw, 110px);
            background: rgba(255,255,255,.12);
            border: 1px solid rgba(255,255,255,.10);
            border-radius: 999px;
            filter: blur(.25px);
            box-shadow: 0 14px 40px rgba(10,20,80,.06);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            opacity: .55;
            animation: cloudMove linear infinite;
        }

        .cloud:before, .cloud:after {
            content: "";
            position: absolute;
            background: rgba(255,255,255,.23);
            border: 1px solid rgba(255,255,255,.14);
            border-radius: 999px;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .cloud:before {
            width: 60%;
            height: 85%;
            left: 8%;
            top: -35%;
        }

        .cloud:after {
            width: 55%;
            height: 75%;
            right: 10%;
            top: -25%;
        }

        @keyframes cloudMove {
            from { transform: translate3d(-120%, 0, 0); }
            to { transform: translate3d(120vw, 0, 0); }
        }

        .glass {
            background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.08));
            border: 1px solid rgba(255,255,255,.18);
            box-shadow: 0 12px 34px rgba(10,20,80,.14);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }

        .glow {
            position: relative;
            isolation: isolate;
        }

        .glow:before {
            content: "";
            position: absolute;
            inset: -1px;
            border-radius: 1.25rem;
            background: conic-gradient(from 200deg, rgba(255,255,255,.0), rgba(255,255,255,.22), rgba(255,255,255,.0), rgba(255,255,255,.16), rgba(255,255,255,.0));
            filter: blur(12px);
            opacity: .40;
            z-index: -1;
            animation: halo 10s linear infinite;
        }

        @keyframes halo {
            to { transform: rotate(360deg); }
        }

        .floaty {
            animation: floaty 6s ease-in-out infinite;
        }

        @keyframes floaty {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .btn {
            background: linear-gradient(135deg, rgba(255,255,255,.25), rgba(255,255,255,.08));
            border: 1px solid rgba(255,255,255,.25);
            box-shadow: 0 12px 30px rgba(10,20,80,.18);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            transition: transform .18s ease, box-shadow .18s ease, background .18s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 18px 44px rgba(10,20,80,.22);
        }

        .btn:active {
            transform: translateY(0px) scale(.99);
        }

        .reveal {
            opacity: 0;
            transform: translateY(14px);
            transition: opacity .7s ease, transform .7s ease;
        }

        .reveal.in {
            opacity: 1;
            transform: translateY(0);
        }

        .no-io .reveal {
            opacity: 1 !important;
            transform: none !important;
            transition: none !important;
        }

        @media (max-width: 1024px) {
            .reveal {
                opacity: 1 !important;
                transform: none !important;
                transition: none !important;
            }
        }

        @media (max-width: 640px) {
            .noise { display: none !important; }
            #stars { display: none !important; }
            #clouds { display: none !important; }
            .glow:before { display: none !important; }
            .glass { backdrop-filter: none !important; -webkit-backdrop-filter: none !important; }
            .btn { backdrop-filter: none !important; -webkit-backdrop-filter: none !important; }
            body::before { background: linear-gradient(180deg, rgba(6,10,28,.62), rgba(6,10,28,.48)) !important; }
            #rules, #goods, #order { padding-top: 1rem !important; padding-bottom: 1rem !important; }
            .glass { box-shadow: none !important; }
        }

        @media (prefers-reduced-motion: reduce) {
            #stars, #clouds, .noise { display: none !important; }
            .glow:before { display: none !important; }
            .glass, .btn { backdrop-filter: none !important; -webkit-backdrop-filter: none !important; }
        }

        .yammy-check {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,.38);
            background: rgba(0,0,0,.20);
            display: inline-grid;
            place-content: center;
            cursor: pointer;
            flex: 0 0 18px;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
        }

        .yammy-check:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255,255,255,.18);
        }

        .yammy-check::after {
            content: "";
            width: 9px;
            height: 5px;
            border-left: 2px solid rgba(255,255,255,.92);
            border-bottom: 2px solid rgba(255,255,255,.92);
            transform: rotate(-45deg);
            opacity: 0;
            margin-top: -1px;
        }

        .yammy-check:checked::after {
            opacity: 1;
        }

        .toast {
            animation: toastIn .22s ease-out;
        }

        @keyframes toastIn {
            from { transform: translateY(12px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        #petals {
            position: fixed;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['ui-sans-serif', 'system-ui', 'Segoe UI', 'Roboto', 'Arial']
                    }
                }
            }
        }
    </script>
</head>

<body class="compact">
<div id="petals" aria-hidden="true"></div>
<div id="clouds" aria-hidden="true"></div>
<div id="stars" aria-hidden="true"></div>
<div class="noise" aria-hidden="true"></div>

<header class="relative z-10">
    <div class="mx-auto max-w-6xl px-4 sm:px-6 pt-6 sm:pt-10 pb-3">
        <div class="glass glow rounded-3xl p-5 sm:p-8">
            <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-6">
                <div>
                    <div class="inline-flex items-center gap-2 rounded-full px-4 py-2 bg-white/10 border border-white/20">
                        <span class="text-sm text-white/90">‚ú® –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</span>
                        <span class="text-xs text-white/70">–º–∞–≥–∞–∑–∏–Ω—á–∏–∫ –Ø–º–∏</span>
                    </div>
                    <h1 class="mt-4 text-3xl sm:text-5xl font-extrabold tracking-tight leading-tight">
                        –ó–∞–∫–∞–∑—ã–≤–∞–π –∫–æ–Ω—Ç–µ–Ω—Ç –∑–∞ –±–∞–ª–ª—ã ‚Äî
                        <span class="block text-white/90">–±—ã—Å—Ç—Ä–æ, –∫—Ä–∞—Å–∏–≤–æ –∏ —É–¥–æ–±–Ω–æ</span>
                    </h1>
                    <p class="mt-4 text-base sm:text-lg text-white/80 max-w-2xl">
                        –ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –∑–∞ –∫–ª–∏–ø—ã. –ù–∏–∂–µ ‚Äî –ø—Ä–∞–≤–∏–ª–∞, –º–∏–Ω–∏‚Äë–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∏ –≤–∏—Ç—Ä–∏–Ω–∞ —Ç–æ–≤–∞—Ä–æ–≤. –° —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤—Å—ë –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫ –∂–µ –∫–ª–∞—Å—Å–Ω–æ.
                    </p>
                    <div class="mt-6 flex flex-wrap gap-3">
                        <a href="#rules" class="btn rounded-2xl px-5 py-3 text-sm font-semibold">üìú –ü—Ä–∞–≤–∏–ª–∞ + –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</a>
                        <a href="#goods" class="btn rounded-2xl px-5 py-3 text-sm font-semibold">üõçÔ∏è –¢–æ–≤–∞—Ä—ã</a>
                        <a href="#order" class="btn rounded-2xl px-5 py-3 text-sm font-semibold">‚úâÔ∏è –ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</a>
                    </div>
                </div>
                <div class="floaty">
                    <div class="glass rounded-3xl p-5 sm:p-6 border border-white/20 shadow-[0_16px_54px_rgba(10,20,80,.16)]">
                        <div class="flex items-start justify-between gap-3">
                            <div>
                                <div class="text-sm text-white/80">–ü–æ–¥—Å–∫–∞–∑–∫–∞</div>
                                <div class="mt-1 text-base font-bold">–°–æ–±–µ—Ä–∏ –∑–∞–∫–∞–∑ –≤–Ω–∏–∑—É</div>
                            </div>
                        </div>
                        <div class="mt-2 text-xs text-white/75">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä ‚Äî –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ü—Ä–∞–≤–∏–ª–∞¬ª (–∫–Ω–æ–ø–∫–∞ üßÆ). –ù–∏—á–µ–≥–æ –Ω–µ –∫–æ–ø–∏—Ä—É–µ–º ‚Äî –ø—Ä–æ—Å—Ç–æ —Å—á–∏—Ç–∞–µ–º.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

<main class="relative z-10">
    <section id="rules" class="mx-auto max-w-6xl px-4 sm:px-6 py-5 sm:py-8">
        <div class="grid grid-cols-1 gap-5">
            <div class="reveal">
                <div class="glass glow rounded-3xl p-5 sm:p-7">
                    <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4">
                        <div class="min-w-0">
                            <h2 class="text-2xl sm:text-3xl font-extrabold">üìú –ü–†–ê–í–ò–õ–ê –ù–ê–ß–ò–°–õ–ï–ù–ò–Ø –ë–ê–õ–õ–û–í</h2>
                            <div class="mt-3 space-y-2 text-white/85 leading-relaxed text-sm sm:text-base">
                                <p><span class="font-semibold">1Ô∏è‚É£ –ó–∞ –∫–∞–∂–¥—ã–π –∫–ª–∏–ø</span> ‚Üí <span class="font-bold">+50</span> ü™ô.</p>
                                <p><span class="font-semibold">2Ô∏è‚É£ –ï—Å–ª–∏ –∫–ª–∏–ø–æ–≤ –±–æ–ª—å—à–µ –æ–¥–Ω–æ–≥–æ</span> ‚Üí –∫ –∫–∞–∂–¥–æ–º—É —Å–ª–µ–¥—É—é—â–µ–º—É –¥–æ–±–∞–≤–ª—è–µ–º <span class="font-bold">+3%</span> –æ—Ç —Å—É–º–º—ã –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–ª–∏–ø–∞.</p>
                                <div class="mt-3 rounded-2xl bg-black/12 border border-white/12 p-4">
                                    <div class="font-semibold">–ü—Ä–∏–º–µ—Ä—ã:</div>
                                    <ul class="mt-2 list-disc pl-5 space-y-1 text-white/85">
                                        <li>1 –∫–ª–∏–ø = 50 ü™ô</li>
                                        <li>2 –∫–ª–∏–ø–∞ = 100 + 3% √ó 100 √ó 1 = 103 ü™ô</li>
                                        <li>3 –∫–ª–∏–ø–∞ = 150 + 3% √ó 150 √ó 2 = 159 ü™ô</li>
                                        <li>4 –∫–ª–∏–ø–∞ = 200 + 3% √ó 200 √ó 3 = 218 ü™ô</li>
                                    </ul>
                                </div>
                                <p class="mt-2"><span class="font-semibold">‚ö†Ô∏è –í–∞–∂–Ω–æ:</span> –µ—Å–ª–∏ –∫–ª–∏–ø –Ω–µ –æ —á–µ–º ‚Äî –±–∞–ª–ª—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è!</p>
                                <p><span class="font-semibold">üí° –°–æ–≤–µ—Ç:</span> —á–µ–º –±–æ–ª—å—à–µ –∫–ª–∏–ø–æ–≤ –≤ —Å—Ç—Ä–∏–º–µ ‚Äî —Ç–µ–º –≤—ã–≥–æ–¥–Ω–µ–µ!</p>
                                <p class="text-white/70 text-xs sm:text-sm">–°–æ–≤–µ—Ç: —Å–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏ —á–µ—Ä–µ–∑ Twitch —Å–ø—Ä–∞–≤–∞ ‚Äî —Ç–∞–∫ –±–∞–ª–∞–Ω—Å –ø–æ–¥—Ç—è–Ω–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚ú®</p>
                            </div>
                            <div class="mt-4 flex flex-wrap items-center gap-3">
                                <button id="openCalc" class="btn rounded-2xl px-4 py-2.5 text-sm font-semibold">üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</button>
                                <p class="text-xs text-white/70">–û—Ç–∫—Ä–æ–µ—Ç—Å—è —Å–≤–µ—Ä—Ö—É ‚Äî –±—ã—Å—Ç—Ä–æ –ø–æ—Å—á–∏—Ç–∞—Ç—å –±–∞–ª–ª—ã.</p>
                            </div>
                        </div>
                        <div class="shrink-0 w-full lg:max-w-sm">
                            <div class="rounded-2xl bg-white/8 border border-white/14 px-4 py-4">
                                <div class="flex items-start justify-between gap-3">
                                    <div>
                                        <div class="text-sm font-bold text-white/90">üîé –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞</div>
                                        <div id="nickStatus" class="mt-1 text-[11px] text-white/65">–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Twitch, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –±–∞–ª–∞–Ω—Å.</div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button id="twitchLoginBtn" class="btn rounded-xl px-3 py-2 text-xs font-semibold">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Twitch</button>
                                        <button id="twitchLogoutBtn" class="btn rounded-xl px-3 py-2 text-xs font-semibold hidden">–í—ã–π—Ç–∏</button>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <div class="rounded-2xl bg-black/12 border border-white/12 p-4">
                                        <div class="text-xs text-white/70">–í–∞—à –Ω–∏–∫:</div>
                                        <div id="nickLine" class="mt-1 text-base font-extrabold">‚Äî</div>
                                    </div>
                                    <div class="mt-3 rounded-2xl bg-black/12 border border-white/12 p-4">
                                        <div class="flex items-center justify-between">
                                            <div class="text-xs text-white/70">–ë–∞–ª–∞–Ω—Å:</div>
                                            <button id="refreshBalance" class="btn rounded-lg px-2 py-1 text-xs font-semibold">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                                        </div>
                                        <div id="balanceResult" class="mt-1 text-base font-extrabold">‚Äî</div>
                                        <p id="balanceHint" class="mt-2 text-xs text-white/70">–î–∞–Ω–Ω—ã–µ –ø–æ–¥—Ç—è–≥–∏–≤–∞—é—Ç—Å—è –∏–∑ Google –¢–∞–±–ª–∏—Ü—ã.</p>
                                    </div>
                                    <div class="mt-3 flex items-center gap-2">
                                        <label class="inline-flex items-center gap-2 text-xs text-white/75 select-none grow">
                                            <input id="rememberNick" type="checkbox" checked class="yammy-check" />
                                            <span>–ó–∞–ø–æ–º–Ω–∏—Ç—å –≤—Ö–æ–¥ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="mt-4 rounded-xl bg-black/14 border border-white/12 px-3 py-3">
                                    <div class="text-[11px] text-white/70">–õ–∏–±–æ –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ Twitch –∫–æ–º–∞–Ω–¥–æ–π</div>
                                    <div class="mt-2 flex items-center gap-2">
                                        <code class="px-2 py-1 rounded-lg bg-black/18 border border-white/12 text-sm">!–ë–∞–ª–∞–Ω—Å</code>
                                        <button id="copyBalance" class="btn rounded-xl px-3 py-2 text-xs font-semibold">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                                    </div>
                                    <p id="copyToast" class="mt-2 text-xs text-white/70 hidden">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div id="calcModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/45 backdrop-blur-sm"></div>
        <div class="relative mx-auto max-w-md px-4 sm:px-6 pt-20 sm:pt-28">
            <div class="glass glow rounded-3xl p-5 sm:p-6">
                <div class="flex items-start justify-between gap-3">
                    <div>
                        <h3 class="text-lg font-extrabold">üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –±–∞–ª–ª–æ–≤</h3>
                        <div class="text-xs text-white/70">+3% –∫–∞–∂–¥—ã–π —Å–ª–µ–¥—É—é—â–∏–π –∫–ª–∏–ø</div>
                    </div>
                    <button id="closeCalc" class="btn rounded-xl px-3 py-2 text-sm font-semibold">‚úï</button>
                </div>
                <div class="mt-4 grid grid-cols-1 gap-3">
                    <label class="text-sm text-white/80">–°–∫–æ–ª—å–∫–æ –∫–ª–∏–ø–æ–≤?</label>
                    <div class="flex items-center gap-2">
                        <button id="clipsMinus" class="btn rounded-xl px-3 py-2 text-sm font-bold">‚àí</button>
                        <input id="clips" type="number" min="0" value="1" class="w-full rounded-xl bg-black/20 border border-white/20 px-4 py-2 text-white placeholder-white/50 outline-none focus:border-white/40" />
                        <button id="clipsPlus" class="btn rounded-xl px-3 py-2 text-sm font-bold">+</button>
                    </div>
                    <div class="mt-1 rounded-2xl bg-black/12 border border-white/12 p-4">
                        <div class="text-sm text-white/75">–ò—Ç–æ–≥–æ –±–∞–ª–ª–æ–≤:</div>
                        <div class="mt-1 text-2xl font-extrabold tracking-tight"><span id="total">50</span> <span class="text-lg">ü™ô</span></div>
                        <div class="mt-2 text-xs text-white/70">–°—á–∏—Ç–∞–µ–º: 50, –ø–æ—Ç–æ–º –∫–∞–∂–¥—ã–π —Å–ª–µ–¥—É—é—â–∏–π = –ø—Ä–µ–¥—ã–¥—É—â–∏–π √ó 1.03</div>
                    </div>
                    <div class="flex gap-2">
                        <button id="calcApply" class="btn rounded-2xl px-4 py-3 text-sm font-semibold grow">–ì–æ—Ç–æ–≤–æ</button>
                        <button id="calcCopyInside" class="btn rounded-2xl px-4 py-3 text-sm font-semibold">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                    <p id="calcToastInside" class="text-xs text-white/70 hidden">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ</p>
                </div>
            </div>
        </div>
    </div>

    <section id="goods" class="mx-auto max-w-6xl px-4 sm:px-6 py-5 sm:py-8">
        <div class="reveal">
            <div class="glass glow rounded-3xl p-5 sm:p-7">
                <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4">
                    <div>
                        <h2 class="text-2xl sm:text-3xl font-extrabold">üõçÔ∏è –¢–æ–≤–∞—Ä—ã</h2>
                        <p class="mt-2 text-white/80">–ù–∞–∂–º–∏ ¬´–í—ã–±—Ä–∞—Ç—å¬ª ‚Äî –∏ –ø–µ—Ä–µ–π–¥—ë–º –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é.</p>
                    </div>
                    <div class="text-sm text-white/75 hidden sm:block">–°–æ–≤–µ—Ç: —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—å –±–∞–ª–ª—ã, –ø–æ—Ç–æ–º –≤—ã–±–µ—Ä–∏ –Ω–∞–≥—Ä–∞–¥—É.</div>
                </div>
                <div id="goodsGrid" class="mt-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </div>
    </section>

    <section id="order" class="mx-auto max-w-6xl px-4 sm:px-6 py-6 sm:py-12">
        <div class="reveal">
            <div class="glass glow rounded-3xl p-6 sm:p-8">
                <div class="flex flex-col lg:flex-row gap-6 lg:items-start lg:justify-between">
                    <div class="max-w-2xl">
                        <h2 class="text-2xl sm:text-3xl font-extrabold">‚úâÔ∏è –ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑?</h2>
                        <p id="orderIntro" class="mt-3 text-white/85 leading-relaxed">–î–ª—è –Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –Ω–∞ —Ç–≤–∏—á.</p>
                        <p id="orderHelp" class="mt-4 text-white/80 hidden">
                            –í—ã–±–µ—Ä–∏ –Ω–∞–≥—Ä–∞–¥—É –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–¢–æ–≤–∞—Ä—ã¬ª. –î–æ–±–∞–≤—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) –∏ –Ω–∞–∂–º–∏ ¬´–ó–∞–∫–∞–∑–∞—Ç—å¬ª. Telegram –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å –≥–æ—Ç–æ–≤—ã–º —Ç–µ–∫—Å—Ç–æ–º.
                        </p>
                    </div>
                    <div class="w-full lg:max-w-sm">
                        <div id="orderCard" class="glass rounded-3xl p-5 border border-white/20 hidden">
                            <div id="orderFormContent">
                                <div class="text-sm text-white/75">–í—ã–±—Ä–∞–Ω–æ:</div>
                                <div id="picked" class="mt-2 text-lg font-extrabold">–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ</div>
                                <div id="orderMsg" class="mt-3 hidden rounded-2xl border px-4 py-3 text-sm">
                                    <div id="orderMsgTitle" class="font-bold"></div>
                                    <div id="orderMsgText" class="mt-1 text-white/80 text-xs"></div>
                                    <div id="orderMsgActions" class="mt-3 hidden flex flex-wrap gap-2"></div>
                                </div>
                                <div class="mt-3">
                                    <label class="text-sm text-white/80">–î–æ–ø. –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                                    <textarea id="comment" rows="3" class="mt-2 w-full rounded-2xl bg-black/20 border border-white/20 px-4 py-3 text-white placeholder-white/50 outline-none focus:border-white/40" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∂–∞–Ω—Ä/–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ/–∫–∞–∫–∞—è –∏–º–µ–Ω–Ω–æ –∏–≥—Ä–∞..."></textarea>
                                </div>
                                <button id="placeOrder" class="btn mt-4 rounded-2xl px-4 py-3 text-sm font-semibold w-full">–ó–∞–∫–∞–∑–∞—Ç—å</button>
                            </div>
                            <div id="orderProcessing" class="hidden text-center py-8">
                                <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-white/20 border-t-white/90"></div>
                                <div id="processingText" class="mt-4 text-base font-bold">‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–∫–∞–∑...</div>
                                <div id="processingHint" class="mt-2 text-xs text-white/70">–ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram</div>
                            </div>
                            <div id="orderSuccess" class="hidden text-center py-6">
                                <div class="text-5xl mb-4">‚úÖ</div>
                                <div class="text-xl font-extrabold text-emerald-100">–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!</div>
                                <div class="mt-2 text-sm text-white/80">–Ø–º–∏ –ø–æ–ª—É—á–∏–ª —Ç–≤–æ–π –∑–∞–∫–∞–∑ üòä</div>
                                <button id="orderAgain" class="btn mt-6 rounded-2xl px-6 py-3 text-sm font-semibold">–û—Ñ–æ—Ä–º–∏—Ç—å –µ—â—ë –æ–¥–∏–Ω –∑–∞–∫–∞–∑</button>
                            </div>
                            <div id="orderError" class="hidden text-center py-6">
                                <div class="text-5xl mb-4">‚ùå</div>
                                <div id="errorTitle" class="text-xl font-extrabold text-rose-100">–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏</div>
                                <div id="errorText" class="mt-2 text-sm text-white/80">–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</div>
                                <button id="orderRetry" class="btn mt-6 rounded-2xl px-6 py-3 text-sm font-semibold">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-6 text-xs text-white/65">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: —ç—Ç–æ—Ç —Å–∞–π—Ç ‚Äî —É–¥–æ–±–Ω–∞—è –≤–∏—Ç—Ä–∏–Ω–∞. –û–ø–ª–∞—Ç–∞/–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚Äî –ø–æ —Ç–≤–æ–∏–º –ø—Ä–∞–≤–∏–ª–∞–º –≤ —á–∞—Ç–µ.</div>
            </div>
        </div>
    </section>

    <footer class="mx-auto max-w-6xl px-4 sm:px-6 pb-10">
        <div class="glass rounded-3xl p-5 sm:p-6 border border-white/20 text-white/75">
            <div class="flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
                <div>
                    <div class="font-bold text-white/90">‚ú® –ú–∞–≥–∞–∑–∏–Ω—á–∏–∫ –Ø–º–∏</div>
                    <div class="text-xs">–° –õ—é–±–æ–≤—å—é ‚ù§Ô∏è</div>
                </div>
                <button id="toTop" class="btn rounded-2xl px-4 py-3 text-sm font-semibold">–ù–∞–≤–µ—Ä—Ö ‚Üë</button>
            </div>
        </div>
    </footer>
</main>

<script>
    // === –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–ù–´–• –ë–†–ê–£–ó–ï–†–û–í ===
    try {
        const ua = (navigator.userAgent || '').toLowerCase();
        const inApp = ua.includes('telegram') || ua.includes('instagram') || ua.includes('fbav') || ua.includes('fban');
        if (inApp) document.documentElement.classList.add('no-io');
        if (!('IntersectionObserver' in window)) document.documentElement.classList.add('no-io');
    } catch (e) {
        document.documentElement.classList.add('no-io');
    }

    // === HELPERS ===
    const $ = (sel, root = document) => root.querySelector(sel);
    const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

    async function copyText(text) {
        try {
            await navigator.clipboard.writeText(text);
            return true;
        } catch (e) {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            document.body.appendChild(ta);
            ta.select();
            try {
                document.execCommand('copy');
                return true;
            } catch (err) {
                return false;
            } finally {
                document.body.removeChild(ta);
            }
        }
    }

    function toast(el) {
        if (!el) return;
        el.classList.remove('hidden');
        el.style.opacity = '0';
        el.style.transition = 'opacity .25s ease';
        requestAnimationFrame(() => el.style.opacity = '1');
        clearTimeout(el._t);
        el._t = setTimeout(() => {
            el.style.opacity = '0';
            setTimeout(() => el.classList.add('hidden'), 260);
        }, 1300);
    }

    function roundNice(n) {
        const r = Math.round(n);
        if (Math.abs(n - r) < 1e-9) return String(r);
        const one = Math.round(n * 10) / 10;
        return String(one).replace('.', ',');
    }

    // === CALCULATOR ===
    function calcTotal(clips) {
        clips = Math.max(0, Math.floor(Number(clips) || 0));
        const base = 50 * clips;
        const bonus = 0.03 * base * (clips - 1);
        return base + bonus;
    }

    function updateCalc() {
        const clipsEl = $('#clips');
        const totalEl = $('#total');
        if (!clipsEl || !totalEl) return;
        let c = Math.max(0, Math.floor(Number(clipsEl.value || 0)));
        clipsEl.value = c;
        totalEl.textContent = roundNice(calcTotal(c));
    }

    function openCalc() {
        const m = $('#calcModal');
        if (!m) return;
        m.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        updateCalc();
        setTimeout(() => $('#clips')?.focus(), 50);
    }

    function closeCalc() {
        const m = $('#calcModal');
        if (!m) return;
        m.classList.add('hidden');
        document.body.style.overflow = '';
    }

    function initCalculator() {
        $('#clipsMinus')?.addEventListener('click', () => {
            const i = $('#clips');
            if (!i) return;
            i.value = Math.max(0, (Number(i.value) || 0) - 1);
            updateCalc();
        });
        $('#clipsPlus')?.addEventListener('click', () => {
            const i = $('#clips');
            if (!i) return;
            i.value = (Number(i.value) || 0) + 1;
            updateCalc();
        });
        $('#clips')?.addEventListener('input', updateCalc);
        $('#openCalc')?.addEventListener('click', openCalc);
        $('#closeCalc')?.addEventListener('click', closeCalc);
        $('#calcApply')?.addEventListener('click', closeCalc);
        $('#calcModal .absolute')?.addEventListener('click', closeCalc);
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !$('#calcModal')?.classList.contains('hidden')) closeCalc();
        });
        $('#calcCopyInside')?.addEventListener('click', async () => {
            const c = Number($('#clips')?.value) || 0;
            const t = $('#total')?.textContent || '';
            const ok = await copyText(`–ö–ª–∏–ø–æ–≤: ${c}. –ò—Ç–æ–≥–æ –±–∞–ª–ª–æ–≤: ${t} ü™ô`);
            if (ok) toast($('#calcToastInside'));
        });
        updateCalc();
    }

    function initCopyButtons() {
        $('#copyBalance')?.addEventListener('click', async () => {
            const ok = await copyText('!–ë–∞–ª–∞–Ω—Å');
            if (ok) toast($('#copyToast'));
        });
    }

    // === PRODUCTS ===
    const PRODUCTS = [
        {
            title: 'ü•® –ó–∞–∫—É—Å–∫–∏ (–ú–µ–º—ã)',
            badge: '—é–º–æ—Ä',
            note: '–õ—ë–≥–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è ‚ú®',
            options: [
                { label: '20 –º–µ–º–æ–≤', price: 200 },
                { label: '45 –º–µ–º–æ–≤', price: 400 }
            ]
        },
        {
            title: 'üçø –û—Å–Ω–æ–≤–Ω–æ–µ –±–ª—é–¥–æ (–ö–∏–Ω–æ –∏ –ê–Ω–∏–º–µ)',
            badge: '–¥–æ 2 —á–∞—Å–æ–≤',
            note: '–ï—Å–ª–∏ –∑–∞–π–¥—ë—Ç ‚Äî —Å–º–æ—Ç—Ä–∏–º —Ñ—É–ª–ª.',
            options: [
                { label: '–§–∏–ª—å–º / –ú—É–ª—å—Ç—Ñ–∏–ª—å–º', price: 750 },
                { label: '–ê–Ω–∏–º–µ / –°–µ—Ä–∏–∞–ª / –¢–µ–ª–µ—à–æ—É', price: 750 }
            ]
        },
        {
            title: 'üå∂Ô∏è –ù–∞ –¥–µ—Å–µ—Ä—Ç (18+)',
            badge: '18+',
            note: '–ù–∞ —Ç–≤–æ–π/–º–æ–π –≤—ã–±–æ—Ä.',
            options: [
                { label: '–•–µ–Ω—Ç–∞–π –∞–Ω–∏–º–µ / –ü–æ—Ä–Ω–æ‚Äë–∏–≥—Ä—ã –Ω–∞ Boosty', price: 1000 }
            ]
        },
        {
            title: 'üéÆ –ì–µ–π–º–µ—Ä—Å–∫–∞—è –∑–æ–Ω–∞',
            badge: '2 —á–∞—Å–∞',
            note: '‚ùó –î–ª—è MMO ‚Äî —Ç–æ–ª—å–∫–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∏–≥—Ä—ã. ‚ö†Ô∏è –ï—Å–ª–∏ –∏–≥—Ä–∞ –Ω–µ ¬´–∑–∞—à–ª–∞¬ª ‚Äî —Å—Ç–æ–ø —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞.',
            options: [
                { label: '–ò–≥—Ä–∞—é –≤ –¢–í–û–Æ –∏–≥—Ä—É', price: 1500 }
            ]
        },
        {
            title: 'üëë –£–ª—å—Ç–∏–º–∞—Ç–∏–≤–Ω—ã–π –∑–∞–∫–∞–∑',
            badge: '–º–∞—Ä–∞—Ñ–æ–Ω',
            note: '–î–ª—è —Å–∞–º—ã—Ö –º–æ—â–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ ‚ú®',
            options: [
                { label: '12 —á–∞—Å–æ–≤ —Å—Ç—Ä–∏–º–∞', price: 5000 }
            ]
        },
        {
            title: 'üñåÔ∏è –†–∏—Å—É–Ω–∫–∏',
            badge: '–∞—Ä—Ç',
            note: '–ù–µ–±–æ–ª—å—à–∏–µ —Ä–∏—Å—É–Ω–∫–∏ –ø–æ —Ç–≤–æ–µ–π –∏–¥–µ–µ ‚ú®',
            options: [
                { label: '–ó–∞–∫–∞–∑–∞—Ç—å –≤—Å—Ä–∞—Ç—ã—à–∞', price: 3000 }
            ]
        },
        {
            title: 'üéÅ –°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç',
            badge: '–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ',
            note: '–ì–ª–∞–≤–Ω–æ–µ ‚Äî —á—Ç–æ–±—ã –±—ã–ª–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ –∏ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º ‚ú®',
            options: [
                { label: '–•–æ—á—É –æ–±—Å—É–¥–∏—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –∑–∞–∫–∞–∑', price: null }
            ]
        }
    ];

    function formatCoins(price) {
        return (price === null || price === undefined) ? '‚Äî' : `${price} ü™ô`;
    }

    function orderTextFrom(title, opt) {
        const p = (opt.price === null || opt.price === undefined) ? '' : ` (${opt.price} ü™ô)`;
        return `${title} ‚Äî ${opt.label}${p}`;
    }

    function renderGoods() {
        const grid = document.getElementById('goodsGrid');
        if (!grid) return;
        grid.innerHTML = '';

        for (const product of PRODUCTS) {
            const card = document.createElement('article');
            card.className = 'group glass rounded-3xl border border-white/20 hover:border-white/40 transition-all duration-300 hover:-translate-y-1 p-5';
            
            const head = document.createElement('div');
            head.className = 'flex items-center justify-between gap-3';
            head.innerHTML = `
                <h3 class="text-xl font-extrabold">${product.title}</h3>
                <span class="text-xs px-3 py-1 rounded-full bg-white/10 border border-white/15">${product.badge || ''}</span>
            `;
            
            const list = document.createElement('ul');
            list.className = 'mt-3 space-y-2 text-white/85';
            list.innerHTML = product.options.map(opt => `
                <li class="flex items-center justify-between">
                    <span>${opt.label}</span>
                    <span class="font-bold">${formatCoins(opt.price)}</span>
                </li>
            `).join('');
            
            const actions = document.createElement('div');
            actions.className = 'mt-4 flex flex-wrap gap-2';
            product.options.forEach((opt, idx) => {
                const b = document.createElement('button');
                b.className = 'btn rounded-2xl px-4 py-2 text-sm font-semibold';
                if (idx === 0) b.classList.add('grow');
                const label = (opt.price === null || opt.price === undefined) ? '–í—ã–±—Ä–∞—Ç—å' : `–í—ã–±—Ä–∞—Ç—å ${opt.price}`;
                b.textContent = label;
                b.setAttribute('data-order', orderTextFrom(product.title, opt));
                actions.appendChild(b);
            });
            
            const note = document.createElement('p');
            note.className = 'mt-3 text-xs text-white/70';
            note.textContent = product.note || '';
            
            card.appendChild(head);
            card.appendChild(list);
            card.appendChild(actions);
            card.appendChild(note);
            grid.appendChild(card);
        }
    }

    let picked = '';

    function wireGoodsButtons() {
        $$('#goodsGrid [data-order]').forEach(btn => {
            btn.addEventListener('click', () => {
                picked = btn.getAttribute('data-order') || '';
                const pickedEl = $('#picked');
                if (pickedEl) pickedEl.textContent = picked || '–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ';
                document.querySelector('#order')?.scrollIntoView?.({ behavior: 'smooth', block: 'start' });
            });
        });
    }

    function initGoods() {
        try {
            renderGoods();
            wireGoodsButtons();
        } catch (e) {
            console.warn('Goods init failed', e);
        }
    }

    // === ORDER MESSAGES ===
    function setOrderMsg({ type = 'info', title = '', text = '', actions = [] } = {}) {
        const box = document.getElementById('orderMsg');
        const t = document.getElementById('orderMsgTitle');
        const tx = document.getElementById('orderMsgText');
        const act = document.getElementById('orderMsgActions');
        if (!box || !t || !tx || !act) return;

        const styles = {
            info: { cls: 'bg-white/8 border-white/18', title: 'text-white/95' },
            warn: { cls: 'bg-amber-500/10 border-amber-200/25', title: 'text-amber-100' },
            error: { cls: 'bg-rose-500/10 border-rose-200/25', title: 'text-rose-100' },
            ok: { cls: 'bg-emerald-500/10 border-emerald-200/25', title: 'text-emerald-100' }
        };

        const s = styles[type] || styles.info;
        box.className = `mt-3 rounded-2xl border px-4 py-3 text-sm ${s.cls}`;
        t.className = `font-bold ${s.title}`;
        t.textContent = title;
        tx.textContent = text;
        act.innerHTML = '';
        if (actions && actions.length) {
            act.classList.remove('hidden');
            for (const a of actions) {
                const b = document.createElement('button');
                b.className = 'btn rounded-xl px-3 py-2 text-xs font-semibold';
                b.textContent = a.label;
                b.addEventListener('click', a.onClick);
                act.appendChild(b);
            }
        } else {
            act.classList.add('hidden');
        }
        box.classList.remove('hidden');
        box.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function clearOrderMsg() {
        const box = document.getElementById('orderMsg');
        if (box) box.classList.add('hidden');
        const act = document.getElementById('orderMsgActions');
        if (act) act.classList.add('hidden');
    }

    // === TELEGRAM BOT API ===
    const TELEGRAM_BOT_API_URL = 'https://script.google.com/macros/s/AKfycbzn3wvaFYwSWkopLZP1ueRb52pJnbWM7sB2Ay4DOx3FPPvBQITpaLF-cx2hflnZ10-_Xg/exec';

    async function sendOrderToBot({ nick, item, price, comment }) {
        try {
            console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞:', { nick, item, price, comment });
            const res = await fetch(TELEGRAM_BOT_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    nick: nick || '–ù–µ —É–∫–∞–∑–∞–Ω',
                    item: item || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                    price: price || '‚Äî',
                    comment: comment || '–ù–µ—Ç'
                })
            });

            console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', res.status);
            const text = await res.text();
            console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', text);

            let data;
            try {
                data = JSON.parse(text);
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:', e);
                return { ok: false, error: '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞', raw: text };
            }

            console.log('–î–∞–Ω–Ω—ã–µ:', data);
            return data;
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', e);
            return { ok: false, error: String(e) };
        }
    }

    // === GOOGLE SHEETS API ===
    const BALANCE_API_URL = 'https://script.google.com/macros/s/AKfycbxv93RskaQaMSQ4t41bpKLhUfx1RQHiwPl-tdYicJ12lvDJ7ZCZhSCAwR2PjSYqZDo/exec';
    const SPEND_ENABLED = true;
    const SPEND_TOKEN = 'yammy_spend_v1';

    function normNick(s) {
        return String(s ?? '').trim().toLowerCase();
    }

    function parsePoints(v) {
        if (v === null || v === undefined) return NaN;
        if (typeof v === 'number') return v;
        const s = String(v).trim().replace(',', '.');
        const n = Number(s);
        return Number.isFinite(n) ? n : NaN;
    }

    async function fetchBalances() {
        const res = await fetch(BALANCE_API_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error('API request failed');
        const json = await res.json();
        if (!json || json.ok !== true || !Array.isArray(json.data)) throw new Error('Bad API payload');
        return json.data;
    }

    async function spendPoints({ nick, amount, item, comment } = {}) {
        const cleanNick = String(nick || '').trim();
        const a = Number(amount);
        if (!cleanNick) return { ok: false, reason: 'nonick' };
        if (!Number.isFinite(a) || a <= 0) return { ok: false, reason: 'badamount' };

        const payload = {
            action: 'spend',
            token: SPEND_TOKEN,
            nick: cleanNick,
            amount: a,
            item: String(item || '').slice(0, 200),
            comment: String(comment || '').slice(0, 500),
            at: Date.now()
        };

        const res = await fetch(BALANCE_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify(payload)
        });

        const txt = await res.text();
        try {
            return JSON.parse(txt);
        } catch (e) {
            return { ok: false, reason: 'badjson', raw: txt.slice(0, 200) };
        }
    }

    async function findBalanceByNick(nick) {
        const needle = normNick(nick);
        if (!needle) return { found: false, reason: 'empty' };
        const rows = await fetchBalances();
        const nickKeys = ['–ù–∏–∫–Ω–µ–π–º', '–Ω–∏–∫–Ω–µ–π–º', 'Nick', 'nick', '–ù–∏–∫', '–Ω–∏–∫'];
        const pointsKeys = ['–ò—Ç–æ–≥–æ–≤—ã–µ –±–∞–ª–ª—ã', '–∏—Ç–æ–≥–æ–≤—ã–µ –±–∞–ª–ª—ã', '–ë–∞–ª–ª—ã', '–±–∞–ª–ª—ã', 'Points', 'points'];

        for (const r of rows) {
            const nickVal = nickKeys.map(k => r[k]).find(v => v !== undefined);
            const rowNick = normNick(nickVal);
            if (!rowNick) continue;
            if (rowNick === needle) {
                const ptsVal = pointsKeys.map(k => r[k]).find(v => v !== undefined);
                const pts = parsePoints(ptsVal);
                return { found: true, nick: nickVal ?? nick, points: ptsVal, pointsNum: pts };
            }
        }
        return { found: false, reason: 'notfound' };
    }

    // === TWITCH OAUTH (PKCE primary + Implicit fallback) ===
    const TWITCH_CLIENT_ID = '89zu7axvj9y80avfsn6a5l20mv5kjq';
    const TWITCH_REDIRECT_URI = window.location.href.split('#')[0];
    const TWITCH_SCOPES = [];
    const AUTH_STORAGE_KEY = 'yammy_twitch_auth_v2';
    const PKCE_STORAGE_KEY = 'yammy_twitch_pkce_v2';

    function setPkceState(obj) {
        sessionStorage.setItem(PKCE_STORAGE_KEY, JSON.stringify(obj || {}));
    }

    function getPkceState() {
        try {
            return JSON.parse(sessionStorage.getItem(PKCE_STORAGE_KEY) || '{}');
        } catch (e) {
            return {};
        }
    }

    function clearPkceState() {
        sessionStorage.removeItem(PKCE_STORAGE_KEY);
    }

    function setAuth(obj) {
        const remember = document.getElementById('rememberNick');
        const data = obj || {};
        try {
            if (remember && remember.checked === false) {
                sessionStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(data));
                localStorage.removeItem(AUTH_STORAGE_KEY);
            } else {
                localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(data));
                sessionStorage.removeItem(AUTH_STORAGE_KEY);
            }
        } catch (e) {
            try {
                localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(data));
            } catch (err) { }
        }
    }

    function getAuth() {
        try {
            const s = sessionStorage.getItem(AUTH_STORAGE_KEY);
            if (s) return JSON.parse(s);
        } catch (e) { }
        try {
            return JSON.parse(localStorage.getItem(AUTH_STORAGE_KEY) || '{}');
        } catch (e) {
            return {};
        }
    }

    function clearAuth() {
        try {
            localStorage.removeItem(AUTH_STORAGE_KEY);
        } catch (e) { }
        try {
            sessionStorage.removeItem(AUTH_STORAGE_KEY);
        } catch (e) { }
    }

    function base64UrlEncode(uint8) {
        let s = '';
        uint8.forEach(b => s += String.fromCharCode(b));
        return btoa(s).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+/g, '');
    }

    function randomString(len = 64) {
        try {
            const a = new Uint8Array(len);
            crypto.getRandomValues(a);
            return base64UrlEncode(a);
        } catch (e) {
            let s = '';
            for (let i = 0; i < len; i++) s += String.fromCharCode(Math.floor(Math.random() * 256));
            return btoa(s).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+/g, '');
        }
    }

    async function sha256(text) {
        const enc = new TextEncoder().encode(text);
        const hash = await crypto.subtle.digest('SHA-256', enc);
        return new Uint8Array(hash);
    }

    function withTimeout(promise, ms = 12000) {
        return new Promise((resolve, reject) => {
            const t = setTimeout(() => reject(new Error('Timeout')), ms);
            promise.then(v => { clearTimeout(t); resolve(v); }, e => { clearTimeout(t); reject(e); });
        });
    }

    function cleanUrlAfterOAuth() {
        const url = new URL(window.location.href);
        url.searchParams.delete('code');
        url.searchParams.delete('scope');
        url.searchParams.delete('state');
        window.history.replaceState({}, document.title, url.toString());
    }

    async function twitchExchangeCode(code) {
        const st = getPkceState();
        if (!st || !st.verifier) throw new Error('Missing PKCE verifier');

        const redirectUri = String(TWITCH_REDIRECT_URI || '').trim();
        const params = new URLSearchParams({
            client_id: TWITCH_CLIENT_ID,
            grant_type: 'authorization_code',
            code: String(code || ''),
            redirect_uri: redirectUri,
            code_verifier: String(st.verifier || '')
        });

        const endpoints = ['https://id.twitch.tv/oauth2/token', 'https://api.twitch.tv/oauth2/token'];
        let lastTxt = '';
        let lastJson = null;
        let lastStatus = 0;

        for (const ep of endpoints) {
            let res;
            try {
                res = await withTimeout(fetch(ep, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params.toString()
                }), 12000);
            } catch (e) {
                lastTxt = String(e?.message || e);
                lastJson = null;
                lastStatus = 0;
                continue;
            }
            lastStatus = res.status;
            lastTxt = await res.text();
            lastJson = null;
            try {
                lastJson = JSON.parse(lastTxt);
            } catch (e) { }
            if (res.ok && lastJson?.access_token) return lastJson;
        }

        const desc = lastJson?.message || lastJson?.error_description || lastJson?.error || lastTxt || `HTTP ${lastStatus}`;
        throw new Error(`Token exchange failed: ${desc}`);
    }

    async function twitchGetUserHelix(accessToken) {
        const res = await withTimeout(fetch('https://api.twitch.tv/helix/users', {
            headers: {
                'Authorization': `Bearer ${accessToken}`,
                'Client-ID': TWITCH_CLIENT_ID
            }
        }), 12000);

        const txt = await res.text();
        let json = null;
        try {
            json = JSON.parse(txt);
        } catch (e) { }

        if (!res.ok) {
            const desc = json?.message || json?.error || txt.slice(0, 200);
            throw new Error(`Failed to fetch user: ${desc}`);
        }

        const u = json?.data?.[0];
        const login = String(u?.login || '').trim();
        const display = String(u?.display_name || login).trim();
        return login ? { login, display_name: display, login_lower: login.toLowerCase() } : null;
    }

    function handleImplicitTokenFromHash() {
        const h = String(window.location.hash || '');
        if (!h || !h.includes('access_token=')) return null;
        const params = new URLSearchParams(h.replace(/^#/, ''));
        const token = params.get('access_token');
        const state = params.get('state') || '';
        if (!token) return null;
        try {
            history.replaceState({}, document.title, window.location.pathname + window.location.search);
        } catch (e) { }
        return { access_token: token, state };
    }

    function setNickUIAuthed(displayName) {
        const status = document.getElementById('nickStatus');
        const nickLine = document.getElementById('nickLine');
        if (nickLine) nickLine.textContent = displayName ? displayName : '‚Äî';
        if (status) status.textContent = displayName ? '–í—ã –≤–æ—à–ª–∏ —á–µ—Ä–µ–∑ Twitch.' : '–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Twitch, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –±–∞–ª–∞–Ω—Å.';
        document.getElementById('twitchLoginBtn')?.classList.toggle('hidden', !!displayName);
        document.getElementById('twitchLogoutBtn')?.classList.toggle('hidden', !displayName);
        try {
            updateOrderGateUI();
        } catch (e) { }
    }

    function getKnownNick() {
        const a = getAuth();
        return String(a?.login || '').trim();
    }

    function getKnownDisplayName() {
        const a = getAuth();
        return String(a?.display_name || a?.login || '').trim();
    }

    async function refreshBalanceForAuthed() {
        const out = document.getElementById('balanceResult');
        const hint = document.getElementById('balanceHint');
        const nickLine = document.getElementById('nickLine');
        const login = getKnownNick();
        let displayName = getKnownDisplayName();

        const auth = getAuth();
        if (auth?.login && !auth?.display_name && auth?.access_token) {
            try {
                const user = await twitchGetUserHelix(auth.access_token);
                if (user?.display_name) {
                    auth.display_name = user.display_name;
                    setAuth(auth);
                    displayName = user.display_name;
                }
            } catch (e) { }
        }

        if (!login) {
            if (nickLine) nickLine.textContent = '‚Äî';
            if (out) out.textContent = '‚Äî';
            if (hint) hint.textContent = '–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Twitch, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –±–∞–ª–∞–Ω—Å.';
            return;
        }
        if (nickLine) nickLine.textContent = displayName;
        if (!BALANCE_API_URL) {
            if (out) out.textContent = '–ë–∞–ª–∞–Ω—Å –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω.';
            if (hint) hint.textContent = '–ù—É–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å URL Apps Script –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é BALANCE_API_URL.';
            return;
        }
        if (out) out.textContent = '–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶';
        try {
            const res = await findBalanceByNick(login);
            if (res.found) {
                const pts = Number.isFinite(res.pointsNum) ? Math.round(res.pointsNum) : res.points;
                if (out) out.textContent = `${displayName} ‚Äî ${pts} ü™ô`;
                if (hint) hint.textContent = '–ï—Å–ª–∏ –±–∞–ª–ª—ã –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç ‚Äî –ø—Ä–æ–≤–µ—Ä—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã.';
            } else {
                if (out) out.textContent = `${displayName} ‚Äî 0 ü™ô üò¢`;
                if (hint) hint.textContent = '–£ –≤–∞—Å 0 –±–∞–ª–ª–æ–≤ üò¢';
            }
        } catch (e) {
            if (out) out.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.';
            if (hint) hint.textContent = '–ü—Ä–æ–≤–µ—Ä—å –¥–æ—Å—Ç—É–ø Apps Script (Deploy ‚Üí Web app ‚Üí –¥–æ—Å—Ç—É–ø: "–í—Å–µ").';
        }
    }

    async function handleTwitchOAuthCallback() {
        const implicit = handleImplicitTokenFromHash();
        if (implicit?.access_token) {
            try {
                const user = await twitchGetUserHelix(implicit.access_token);
                if (!user?.login) throw new Error('No login');
                setAuth({ login: user.login, display_name: user.display_name, access_token: implicit.access_token, obtained_at: Date.now(), implicit: true });
                setNickUIAuthed(user.display_name);
                await refreshBalanceForAuthed();
            } catch (e) {
                clearAuth();
                setNickUIAuthed('');
                const hint = document.getElementById('balanceHint');
                if (hint) hint.textContent = `–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Twitch. ${String(e?.message || e)}`;
            }
            return;
        }

        const url = new URL(window.location.href);
        const code = url.searchParams.get('code');
        const state = url.searchParams.get('state');
        if (!code) return;

        const st0 = getPkceState();
        if (!st0?.state || !st0?.verifier) {
            clearPkceState();
            cleanUrlAfterOAuth();
            clearAuth();
            setNickUIAuthed('');
            const hint = document.getElementById('balanceHint');
            if (hint) hint.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å –≤—Ö–æ–¥. –ù–∞–∂–º–∏ ¬´–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Twitch¬ª –µ—â—ë —Ä–∞–∑.';
            return;
        }

        try {
            const st = getPkceState();
            if (st.state !== state) throw new Error('Bad state');
            const token = await twitchExchangeCode(code);
            const user = await twitchGetUserHelix(token.access_token);
            if (!user?.login) throw new Error('No login');
            setAuth({ login: user.login, display_name: user.display_name, access_token: token.access_token, expires_in: token.expires_in, obtained_at: Date.now() });
            setNickUIAuthed(user.display_name);
            await refreshBalanceForAuthed();
        } catch (e) {
            clearAuth();
            setNickUIAuthed('');
            const hint = document.getElementById('balanceHint');
            if (hint) hint.textContent = `–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Twitch. ${String(e?.message || e)}`;
        } finally {
            clearPkceState();
            cleanUrlAfterOAuth();
        }
    }

    async function twitchLogin() {
        clearOrderMsg();
        clearPkceState();
        try {
            cleanUrlAfterOAuth();
        } catch (e) { }

        const redirectUri = String(TWITCH_REDIRECT_URI || '').trim();
        const ua = (navigator.userAgent || '').toLowerCase();

        const isAndroid = /android/i.test(ua);
        const isIOS = /iphone|ipad|ipod/i.test(ua);
        const isTelegramBrowser = /telegram/i.test(ua) || ua.includes('tgwebview');

        if (isTelegramBrowser) {
            setOrderMsg({
                type: 'info',
                title: '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Telegram',
                text: 'Telegram –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä –∏–º–µ–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç –≤ Chrome –∏–ª–∏ Safari –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.',
                actions: [
                    {
                        label: '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ —Å–∞–π—Ç',
                        onClick: async () => {
                            const ok = await copyText(window.location.href);
                            if (ok) {
                                setOrderMsg({
                                    type: 'ok',
                                    title: '–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!',
                                    text: '–¢–µ–ø–µ—Ä—å –æ—Ç–∫—Ä–æ–π—Ç–µ Chrome/Safari, –≤—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –∏ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —Ç–∞–º. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ Telegram.'
                                });
                            }
                        }
                    }
                ]
            });
            return;
        }

        const state = `implicit_${randomString(24)}`;
        const params = new URLSearchParams({
            client_id: TWITCH_CLIENT_ID,
            redirect_uri: redirectUri,
            response_type: 'token',
            scope: TWITCH_SCOPES.join(' '),
            state: state
        });

        const authUrl = `https://id.twitch.tv/oauth2/authorize?${params.toString()}`;

        if (isAndroid) {
            const intentUrl = `intent://id.twitch.tv/oauth2/authorize?${params.toString()}#Intent;scheme=https;action=android.intent.action.VIEW;S.browser_fallback_url=${encodeURIComponent(authUrl)};end;`;
            window.location.href = intentUrl;
            setTimeout(() => {
                window.location.href = authUrl;
            }, 500);
        } else {
            window.location.assign(authUrl);
        }
    }

    function twitchLogout() {
        clearAuth();
        setNickUIAuthed('');
        refreshBalanceForAuthed();
    }

    function updateOrderGateUI() {
        const authed = !!getKnownNick();
        const intro = document.getElementById('orderIntro');
        const help = document.getElementById('orderHelp');
        const card = document.getElementById('orderCard');
        if (intro) {
            intro.textContent = authed
                ? '–ù–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ –≤ –õ–° –≤ Telegram ‚Äî –æ–¥–Ω–∏–º –∫–ª–∏–∫–æ–º –∏–∑ —ç—Ç–æ–≥–æ —Å–∞–π—Ç–∞.'
                : '–î–ª—è –Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –Ω–∞ —Ç–≤–∏—á.';
        }
        if (help) help.classList.toggle('hidden', !authed);
        if (card) card.classList.toggle('hidden', !authed);
    }

    function parsePickedPrice(str) {
        const s = String(str || '');
        const m = s.match(/\b(\d{2,7})\b\s*ü™ô?/);
        if (!m) return NaN;
        return Number(m[1]);
    }

    function showOrderForm() {
        $('#orderFormContent')?.classList.remove('hidden');
        $('#orderProcessing')?.classList.add('hidden');
        $('#orderSuccess')?.classList.add('hidden');
        $('#orderError')?.classList.add('hidden');
    }

    function showOrderProcessing(text = '‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–∫–∞–∑...', hint = '–ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram') {
        $('#orderFormContent')?.classList.add('hidden');
        $('#orderProcessing')?.classList.remove('hidden');
        $('#orderSuccess')?.classList.add('hidden');
        $('#orderError')?.classList.add('hidden');
        const processingText = $('#processingText');
        const processingHint = $('#processingHint');
        if (processingText) processingText.textContent = text;
        if (processingHint) processingHint.textContent = hint;
    }

    function showOrderSuccess() {
        $('#orderFormContent')?.classList.add('hidden');
        $('#orderProcessing')?.classList.add('hidden');
        $('#orderSuccess')?.classList.remove('hidden');
        $('#orderError')?.classList.add('hidden');
    }

    function showOrderError(title = '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', text = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑') {
        $('#orderFormContent')?.classList.add('hidden');
        $('#orderProcessing')?.classList.add('hidden');
        $('#orderSuccess')?.classList.add('hidden');
        $('#orderError')?.classList.remove('hidden');
        const errorTitle = $('#errorTitle');
        const errorText = $('#errorText');
        if (errorTitle) errorTitle.textContent = title;
        if (errorText) errorText.textContent = text;
    }

    document.getElementById('orderAgain')?.addEventListener('click', showOrderForm);
    document.getElementById('orderRetry')?.addEventListener('click', showOrderForm);

    document.getElementById('placeOrder')?.addEventListener('click', async () => {
        clearOrderMsg();
        const nick = getKnownNick();
        const displayName = getKnownDisplayName();

        if (!nick) {
            setOrderMsg({
                type: 'warn',
                title: '–ù—É–∂–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –Ω–∞ Twitch',
                text: '–ß—Ç–æ–±—ã –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑, —Å–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏ —á–µ—Ä–µ–∑ Twitch –≤ –±–ª–æ–∫–µ ¬´–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞¬ª.',
                actions: [{ label: '–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Twitch', onClick: () => twitchLogin() }]
            });
            return;
        }
        if (!picked) {
            setOrderMsg({ type: 'warn', title: '–í—ã–±–µ—Ä–∏ —Ç–æ–≤–∞—Ä', text: '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –Ω–∞–≥—Ä–∞–¥—É –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–¢–æ–≤–∞—Ä—ã¬ª.' });
            return;
        }

        const spend = parsePickedPrice(picked);

        showOrderProcessing('‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–∫–∞–∑...', '–ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram');

        try {
            if (SPEND_ENABLED && Number.isFinite(spend) && spend > 0) {
                showOrderProcessing('üí∞ –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å...', '–£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ —Ö–≤–∞—Ç–∞–µ—Ç –±–∞–ª–ª–æ–≤');
                const res = await findBalanceByNick(nick);
                if (!res.found) {
                    showOrderError('–£ –≤–∞—Å 0 –±–∞–ª–ª–æ–≤ üò¢', '–ü–æ—Ö–æ–∂–µ, —Ç–µ–±—è –Ω–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ. –ù–∞–ø–∏—à–∏ –Ø–º–∏, —á—Ç–æ–±—ã —Ç–µ–±—è –¥–æ–±–∞–≤–∏–ª–∏.');
                    return;
                }
                const currentBalance = Number.isFinite(res.pointsNum) ? Math.round(res.pointsNum) : 0;
                if (currentBalance < spend) {
                    showOrderError('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤ üò¢', `–î–ª—è —ç—Ç–æ–≥–æ –∑–∞–∫–∞–∑–∞ –Ω—É–∂–Ω–æ ${spend} ü™ô, –∞ —É —Ç–µ–±—è ${currentBalance} ü™ô.`);
                    return;
                }
            }

            showOrderProcessing('üì® –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram...', '–í–∞—à –∑–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ø–º–∏');
            const comment = ($('#comment').value || '').trim();
            const priceText = Number.isFinite(spend) && spend > 0 ? `${spend} ü™ô` : '‚Äî';

            const result = await sendOrderToBot({
                nick: displayName || nick,
                item: picked,
                price: priceText,
                comment: comment || '–ù–µ—Ç'
            });

            if (!result.ok) {
                showOrderError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –Ω–∞–ø–∏—à–∏ –Ø–º–∏ –Ω–∞–ø—Ä—è–º—É—é –≤ Telegram: @YammyTanuki');
                return;
            }

            if (SPEND_ENABLED && Number.isFinite(spend) && spend > 0) {
                showOrderProcessing('üí∞ –°–ø–∏—Å—ã–≤–∞–µ–º –±–∞–ª–ª—ã...', '–û–±–Ω–æ–≤–ª—è–µ–º –≤–∞—à –±–∞–ª–∞–Ω—Å');
                const spendRes = await spendPoints({ nick, amount: spend, item: picked, comment });
                if (spendRes.ok) {
                    await refreshBalanceForAuthed();
                } else {
                    console.warn('Failed to spend points:', spendRes);
                }
            }

            showOrderSuccess();
            $('#comment').value = '';
            picked = '';
            $('#picked').textContent = '–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ';
        } catch (e) {
            showOrderError('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.');
            console.error('Order error:', e);
        }
    });

    // === INIT BALANCE UI ===
    function initBalanceUI() {
        initCopyButtons();
        handleTwitchOAuthCallback();

        document.getElementById('twitchLoginBtn')?.addEventListener('click', twitchLogin);
        document.getElementById('twitchLogoutBtn')?.addEventListener('click', twitchLogout);
        document.getElementById('refreshBalance')?.addEventListener('click', () => refreshBalanceForAuthed());

        const auth = getAuth();
        const remember = document.getElementById('rememberNick');
        if (auth?.login) {
            if (remember) {
                remember.checked = !!localStorage.getItem(AUTH_STORAGE_KEY);
            }
            setNickUIAuthed(auth.display_name || auth.login);
            setTimeout(() => refreshBalanceForAuthed(), 250);
        } else {
            setNickUIAuthed('');
            refreshBalanceForAuthed();
        }

        remember?.addEventListener('change', (e) => {
            const a = getAuth();
            if (!a?.login) return;
            if (e.target.checked) {
                try {
                    localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(a));
                } catch (err) { }
                try {
                    sessionStorage.removeItem(AUTH_STORAGE_KEY);
                } catch (err) { }
            } else {
                try {
                    sessionStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(a));
                } catch (err) { }
                try {
                    localStorage.removeItem(AUTH_STORAGE_KEY);
                } catch (err) { }
            }
        });

        updateOrderGateUI();
    }

    // === REVEAL ===
    try {
        const force = document.documentElement.classList.contains('no-io');
        const isSmallOrTablet = window.matchMedia('(max-width: 1024px)').matches;
        if (!force && !isSmallOrTablet && 'IntersectionObserver' in window) {
            const io = new IntersectionObserver((entries) => {
                for (const e of entries) {
                    if (e.isIntersecting) {
                        e.target.classList.add('in');
                        io.unobserve(e.target);
                    }
                }
            }, { threshold: 0.12 });

            $$('.reveal').forEach(el => io.observe(el));
        } else {
            $$('.reveal').forEach(el => el.classList.add('in'));
        }
    } catch (err) { }

    // === DECORATIVE EFFECTS ===
    const isMobile = window.matchMedia('(max-width: 640px)').matches;
    const reduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const inApp = document.documentElement.classList.contains('no-io');

    if (!isMobile && !reduced && !inApp) {
        const cloudsRoot = document.getElementById('clouds');
        const starsRoot = document.getElementById('stars');

        if (cloudsRoot) {
            function addCloud({ top, duration, delay, scale, opacity }) {
                const c = document.createElement('div');
                c.className = 'cloud';
                c.style.top = top + 'vh';
                c.style.animationDuration = duration + 's';
                c.style.animationDelay = (-delay) + 's';
                c.style.transform = `translate3d(-120%,0,0) scale(${scale})`;
                c.style.opacity = opacity;
                cloudsRoot.appendChild(c);
            }
            const cloudCount = 5;
            for (let i = 0; i < cloudCount; i++) {
                addCloud({
                    top: 6 + Math.random() * 40,
                    duration: 52 + Math.random() * 60,
                    delay: Math.random() * 80,
                    scale: 0.7 + Math.random() * 0.9,
                    opacity: 0.34 + Math.random() * 0.34
                });
            }
        }

        if (starsRoot) {
            function addStar() {
                const s = document.createElement('div');
                s.className = 'star';
                const left = Math.random() * 100;
                const drift = (Math.random() * 2 - 1) * 70;
                const scale = 0.6 + Math.random() * 1.2;
                const opacity = 0.18 + Math.random() * 0.48;
                const dur = 8 + Math.random() * 13;
                const delay = Math.random() * dur;
                s.style.left = left + 'vw';
                s.style.setProperty('--x', '0px');
                s.style.setProperty('--drift', drift + 'px');
                s.style.setProperty('--s', scale);
                s.style.setProperty('--o', opacity);
                s.style.animationDuration = dur + 's';
                s.style.animationDelay = (-delay) + 's';
                s.style.top = '-12vh';
                const sz = (8 + Math.random() * 10);
                s.style.width = sz + 'px';
                s.style.height = sz + 'px';
                starsRoot.appendChild(s);
                setTimeout(() => {
                    s.remove();
                }, (dur + 2) * 1000);
            }
            const initial = Math.min(55, Math.max(35, Math.floor(window.innerWidth / 22)));
            for (let i = 0; i < initial; i++) addStar();
            setInterval(() => {
                for (let i = 0; i < 2; i++) addStar();
            }, 950);
        }
    }

    document.getElementById('toTop')?.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

    // === INIT ALL ===
    function initCriticalUI() {
        initCalculator();
        initGoods();
    }

    function initAllAfterDom() {
        initBalanceUI();
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            initCriticalUI();
            initAllAfterDom();
        }, { once: true });
    } else {
        initCriticalUI();
        initAllAfterDom();
    }
</script>

</body>
</html>
